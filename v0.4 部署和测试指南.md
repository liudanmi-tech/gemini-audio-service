# v0.4 部署和测试指南

## 前置条件

1. ✅ 代码已部署到服务器

2. ✅ 虚拟环境已激活

3. ✅ 所有依赖已安装

4. ✅ 环境变量已配置（`.env` 文件）

## 部署步骤

### 步骤1: 验证代码结构

在服务器上运行：

```bash
cd ~/gemini-audio-service

./测试v0.4架构.sh
```

应该看到所有检查项都通过 ✅

### 步骤2: 执行数据库迁移

```bash
# 方法1: 使用迁移脚本（推荐）

python3 database/migrations/run_migration_v0.4.py



# 方法2: 使用SQL脚本（如果方法1失败）

psql -U postgres -d gemini_audio_db -f database/migrations/add_skills_tables.sql
```

**验证迁移**:

```bash
# 连接到数据库并检查表

psql -U postgres -d gemini_audio_db

\dt skills

\dt skill_executions

\d strategy_analysis # 检查新字段
```

### 步骤3: 注册技能到数据库

```bash
python3 注册技能到数据库.py
```

应该看到4个技能都注册成功。

**或者使用API**:

```bash
# 注册单个技能

curl -X POST "http://localhost:8001/api/v1/skills/workplace_jungle/reload" \

-H "Authorization: Bearer YOUR_JWT_TOKEN" \

-H "Content-Type: application/json"
```

### 步骤4: 重启服务

```bash
# 停止旧服务

pkill -f 'python.*main.py'



# 启动新服务

cd ~/gemini-audio-service

source venv/bin/activate

nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &



# 检查服务状态

sleep 5

ps aux | grep '[p]ython.*main.py'

tail -50 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|Application startup|ERROR"
```

## 测试步骤

### 测试1: 基础功能测试

```bash
python3 测试v0.4功能.py
```

应该看到：

- ✅ 技能列表查询成功

- ✅ 技能加载成功

- ✅ 场景识别成功（需要网络连接）

- ✅ 技能匹配成功

### 测试2: API 接口测试

#### 2.1 获取技能列表

```bash
# 先登录获取Token

TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \

-H "Content-Type: application/json" \

-d '{"phone": "13800138000", "code": "123456"}' | jq -r '.data.token')



# 获取技能列表

curl -X GET "http://localhost:8001/api/v1/skills" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | jq
```

#### 2.2 场景识别测试

```bash
# 假设有一个session_id

SESSION_ID="your-session-id"



curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/classify-scene" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | jq
```

#### 2.3 策略生成测试（使用技能化架构）

```bash
curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/strategies" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | jq
```

**验证返回数据**:

- 检查 `applied_skills` 字段（应该包含使用的技能列表）

- 检查 `scene_category` 字段（应该包含识别的场景类别）

- 检查 `scene_confidence` 字段（应该包含置信度）

### 测试3: 端到端测试

1. **上传音频文件**（通过iOS客户端或API）

2. **等待音频分析完成**（status 变为 `archived`）

3. **调用策略生成接口**，验证：
- 场景识别是否成功

- 技能匹配是否正确

- 策略生成是否使用技能化架构

- 返回数据包含 `applied_skills` 和 `scene_category`

## 故障排查

### 问题1: 数据库迁移失败

**症状**: `run_migration_v0.4.py` 执行失败

**解决方案**:

- 检查数据库连接（`DATABASE_URL` 环境变量）

- 检查数据库用户权限

- 手动执行SQL脚本：`psql -U postgres -d gemini_audio_db -f database/migrations/add_skills_tables.sql`

### 问题2: 技能注册失败

**症状**: `注册技能到数据库.py` 报错 "技能文件不存在"

**解决方案**:

- 检查技能目录是否存在：`ls -la skills/`

- 检查SKILL.md文件是否存在：`ls -la skills/*/SKILL.md`

- 检查文件路径是否正确

### 问题3: 场景识别失败

**症状**: API返回错误或场景识别不准确

**解决方案**:

- 检查Gemini API Key是否配置

- 检查代理服务器是否可用

- 查看日志：`tail -100 ~/gemini-audio-service.log | grep -i "scene\|skill"`

### 问题4: 技能执行失败

**症状**: 策略生成时使用回退模式（固定Prompt）

**解决方案**:

- 检查技能是否正确注册到数据库

- 检查SKILL.md中的Prompt模板格式是否正确

- 查看日志中的错误信息

## 验证清单

- [ ] 数据库表创建成功（skills、skill_executions）

- [ ] strategy_analysis表新增字段成功

- [ ] 4个技能都注册到数据库

- [ ] 技能列表API返回正确的技能列表

- [ ] 场景识别API能够正确识别场景

- [ ] 策略生成使用技能化架构（不是回退模式）

- [ ] 返回数据包含 `applied_skills` 和 `scene_category`

- [ ] 图片生成和存储正常工作

## 下一步

如果所有测试通过，可以：

1. **监控日志**: 观察技能执行记录和性能

2. **优化Prompt**: 根据实际效果调整各技能的Prompt模板

3. **添加新技能**: 按照规范添加新的场景类型和技能

4. **性能优化**: 根据执行记录优化多技能组合逻辑

---

**文档版本**: v0.4

**创建日期**: 2026-01-16
