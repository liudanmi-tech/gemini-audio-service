# 诊断图片生成配额问题

## 问题现象
- 错误代码：`429 RESOURCE_EXHAUSTED`
- 错误信息：`Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_input_token_count, limit: 0`
- 模型：`gemini-2.5-flash-preview-image`

## 可能原因

即使您已经开通付费账户，仍然可能出现此错误，原因可能是：

1. **API Key 仍关联到免费层项目**
   - 您的 API Key 可能是在免费层项目中创建的
   - 需要在新创建的付费项目中重新生成 API Key

2. **配额需要时间刷新**
   - Google Cloud 的配额更新可能需要几分钟到几小时
   - 建议等待 10-30 分钟后重试

3. **未启用图片生成 API 的付费配额**
   - 需要在 Google Cloud Console 中启用相关 API
   - 需要检查配额限制设置

## 解决步骤

### 步骤 1: 检查 API Key 关联的项目

1. 访问 [Google AI Studio](https://aistudio.google.com/apikey)
2. 查看您的 API Key 列表
3. 确认每个 API Key 关联的项目类型（免费层 vs 付费）

### 步骤 2: 创建新的付费项目（如果需要）

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有付费项目
3. 在新项目中启用以下 API：
   - **Generative Language API** (必需)
   - **Gemini API** (如果单独列出)

### 步骤 3: 生成新的 API Key

1. 在付费项目中，访问 [API Key 管理页面](https://console.cloud.google.com/apis/credentials)
2. 创建新的 API Key
3. 限制 API Key 的权限（可选，但推荐）
4. 更新服务器上的 `.env` 文件中的 `GEMINI_API_KEY`

### 步骤 4: 检查配额设置

1. 访问 [Google Cloud Console - 配额页面](https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/quotas)
2. 搜索 `gemini-2.5-flash-image` 或 `generate_content`
3. 确认配额限制不是 0
4. 如果配额为 0，需要申请增加配额或启用付费配额

### 步骤 5: 验证配额

使用以下命令测试 API Key 是否正常工作：

```bash
# 在服务器上执行
cd ~/gemini-audio-service
source venv/bin/activate

python3 -c "
from google import genai as genai_new
import os
from dotenv import load_dotenv

load_dotenv()
api_key = os.getenv('GEMINI_API_KEY')

try:
    client = genai_new.Client(api_key=api_key)
    print('✅ API Key 验证成功')
    print(f'API Key 前缀: {api_key[:10]}...')
except Exception as e:
    print(f'❌ API Key 验证失败: {e}')
"
```

### 步骤 6: 测试图片生成（带重试）

代码已添加自动重试机制（最多 3 次，带指数退避），如果遇到 429 错误会自动等待后重试。

## 临时解决方案

如果配额问题暂时无法解决，可以考虑：

1. **使用其他图片生成服务**
   - DALL-E (OpenAI)
   - Stable Diffusion
   - Midjourney API

2. **降级处理**
   - 图片生成失败时，只返回 `image_prompt`
   - 客户端可以根据 `image_prompt` 自行生成图片

3. **延迟生成**
   - 将图片生成改为异步任务
   - 在配额恢复后批量生成

## 监控配额使用

访问以下链接监控配额使用情况：
- [Google Cloud Console - 配额监控](https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/quotas)
- [API 使用情况](https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/metrics)

## 联系支持

如果问题持续存在，可以：
1. 在 [Google Cloud Support](https://cloud.google.com/support) 提交工单
2. 在 [Gemini API 社区论坛](https://developers.googleblog.com/2023/12/how-its-made-gemini-multimodal-prompting.html) 寻求帮助
