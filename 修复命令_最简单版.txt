# ============================================
# 最简单修复命令 - 直接复制整段执行
# 自动查找路径，无需手动修改
# ============================================

# 查找项目路径并执行修复
PROJECT_DIR=$(find /home /root -type d -name "gemini-audio-service" 2>/dev/null | head -1)
if [ -z "$PROJECT_DIR" ]; then
    echo "❌ 未找到项目目录，尝试使用默认路径..."
    PROJECT_DIR="$HOME/gemini-audio-service"
fi

echo "📁 项目路径: $PROJECT_DIR"
cd "$PROJECT_DIR" && python3 << 'END'
import shutil, time, os

# 确保在正确的目录
if not os.path.exists('main.py'):
    # 尝试查找
    for path in ['/home/admin/gemini-audio-service', '/root/gemini-audio-service', os.path.expanduser('~/gemini-audio-service')]:
        if os.path.exists(os.path.join(path, 'main.py')):
            os.chdir(path)
            break

backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"✅ 备份: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

changes = []

# 修复1: 函数定义添加 task_data
if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):' in content:
    content = content.replace('async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):', 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):')
    changes.append("函数定义添加task_data")

# 修复2: 函数调用添加 task_data  
if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))' in content:
    content = content.replace('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))', 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))')
    changes.append("函数调用添加task_data")

# 修复3: 添加Query导入
if 'from fastapi import FastAPI, UploadFile, File, HTTPException' in content and 'Query' not in content:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    changes.append("添加Query导入")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

import py_compile
py_compile.compile('main.py', doraise=True)
print(f"✅ 修复完成！共 {len(changes)} 处修改")
for c in changes:
    print(f"  - {c}")
print(f"备份文件: {backup}")
END

# 重启服务
cd "$PROJECT_DIR" && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && echo "✅ 服务已重启" && curl -s http://localhost:8001/health

