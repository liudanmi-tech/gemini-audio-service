# éŸ³é¢‘åˆ†ææœåŠ¡ v0.1 æŠ€æœ¯æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v0.1  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-09  
**çŠ¶æ€**: å‰åç«¯å·²è”é€šï¼ŒåŠŸèƒ½æ­£å¸¸

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#1-ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [æŠ€æœ¯æ ˆé€‰å‹](#2-æŠ€æœ¯æ ˆé€‰å‹)
3. [åç«¯æŠ€æœ¯å®ç°](#3-åç«¯æŠ€æœ¯å®ç°)
4. [å‰ç«¯æŠ€æœ¯å®ç°](#4-å‰ç«¯æŠ€æœ¯å®ç°)
5. [API æ¥å£æ–‡æ¡£](#5-api-æ¥å£æ–‡æ¡£)
6. [æ•°æ®æµå’Œäº¤äº’æµç¨‹](#6-æ•°æ®æµå’Œäº¤äº’æµç¨‹)
7. [éƒ¨ç½²é…ç½®](#7-éƒ¨ç½²é…ç½®)
8. [å…³é”®é—®é¢˜è§£å†³æ–¹æ¡ˆ](#8-å…³é”®é—®é¢˜è§£å†³æ–¹æ¡ˆ)
9. [æµ‹è¯•éªŒè¯](#9-æµ‹è¯•éªŒè¯)

---

## 1. ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iOS å®¢æˆ·ç«¯ (SwiftUI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å½•éŸ³æ¨¡å—    â”‚  â”‚  ä»»åŠ¡åˆ—è¡¨    â”‚  â”‚  ä»»åŠ¡è¯¦æƒ…    â”‚    â”‚
â”‚  â”‚  âœ… å·²å®ç°   â”‚  â”‚  âœ… å·²å®ç°   â”‚  â”‚  âœ… å·²å®ç°   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS (Alamofire)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI åç«¯æœåŠ¡ (Python 3.12)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST /api/v1/audio/upload (ä¸Šä¼ éŸ³é¢‘)            â”‚   â”‚
â”‚  â”‚  GET  /api/v1/tasks/sessions (ä»»åŠ¡åˆ—è¡¨)          â”‚   â”‚
â”‚  â”‚  GET  /api/v1/tasks/sessions/{id} (ä»»åŠ¡è¯¦æƒ…)     â”‚   â”‚
â”‚  â”‚  GET  /api/v1/tasks/sessions/{id}/status (çŠ¶æ€)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP (åå‘ä»£ç†)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginx åå‘ä»£ç†æœåŠ¡å™¨                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æœåŠ¡å™¨: 47.79.254.213 (æ–°åŠ å¡)                    â”‚   â”‚
â”‚  â”‚  è·¯å¾„: /secret-channel                             â”‚   â”‚
â”‚  â”‚  åŠŸèƒ½: è½¬å‘è¯·æ±‚åˆ° Google Gemini API                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Google Gemini 3 Flash API                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ¨¡å‹: gemini-3-flash-preview                      â”‚   â”‚
â”‚  â”‚  åŠŸèƒ½: éŸ³é¢‘ä¸Šä¼ ã€è½¬å†™ã€åˆ†æ                        â”‚   â”‚
â”‚  â”‚  è¾“å‡º: å¯¹è¯æå–ã€æƒ…ç»ªåˆ†æã€é£é™©è¯†åˆ«                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®å­˜å‚¨

- **åç«¯**: å†…å­˜å­˜å‚¨ï¼ˆ`tasks_storage` å’Œ `analysis_storage` å­—å…¸ï¼‰
- **å‰ç«¯**: æœ¬åœ°çŠ¶æ€ç®¡ç†ï¼ˆ`@Published` å±æ€§ï¼‰
- **æœªæ¥è®¡åˆ’**: PostgreSQL + Redis

---

## 2. æŠ€æœ¯æ ˆé€‰å‹

### 2.1 åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Python | 3.12 | è¿è¡Œç¯å¢ƒ |
| FastAPI | 0.128.0 | Web æ¡†æ¶ |
| Uvicorn | - | ASGI æœåŠ¡å™¨ |
| google-generativeai | 0.3.2+ | Gemini API SDK |
| Pydantic | 2.9.0+ | æ•°æ®éªŒè¯ |
| python-dotenv | 1.0.0+ | ç¯å¢ƒå˜é‡ç®¡ç† |
| python-multipart | 0.0.6+ | æ–‡ä»¶ä¸Šä¼ æ”¯æŒ |

### 2.2 å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Swift | 5.9+ | ç¼–ç¨‹è¯­è¨€ |
| SwiftUI | - | UI æ¡†æ¶ |
| iOS | 16.0+ | æœ€ä½æ”¯æŒç‰ˆæœ¬ |
| Alamofire | 5.8.0+ | ç½‘ç»œè¯·æ±‚åº“ |
| Combine | - | å“åº”å¼ç¼–ç¨‹ |
| AVFoundation | - | éŸ³é¢‘å½•åˆ¶ |

### 2.3 åŸºç¡€è®¾æ–½

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Nginx | 1.24.0 | åå‘ä»£ç†æœåŠ¡å™¨ |
| Ubuntu | 24.04.2 LTS | æœåŠ¡å™¨æ“ä½œç³»ç»Ÿ |
| é˜¿é‡Œäº‘ ECS | - | äº‘æœåŠ¡å™¨ï¼ˆæ–°åŠ å¡ï¼‰ |

---

## 3. åç«¯æŠ€æœ¯å®ç°

### 3.1 é¡¹ç›®ç»“æ„

```
gemini-audio-service/
â”œâ”€â”€ main.py                 # ä¸»åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ nginx-config-example.conf  # Nginx é…ç½®ç¤ºä¾‹
â””â”€â”€ ~/gemini-service.log    # æ—¥å¿—æ–‡ä»¶
```

### 3.2 æ ¸å¿ƒæ¨¡å—

#### 3.2.1 ä»£ç†é…ç½®æ¨¡å—

**ä½ç½®**: `main.py` (ç¬¬ 50-137 è¡Œ)

**åŠŸèƒ½**: é…ç½®åå‘ä»£ç†ï¼Œå°† Google Gemini API è¯·æ±‚è½¬å‘åˆ°ä»£ç†æœåŠ¡å™¨

**å…³é”®ä»£ç **:
```python
# Monkey Patch HttpRequest.execute æ–¹æ³•
def patched_execute(self, http=None, num_retries=0):
    original_uri = self.uri
    if 'generativelanguage.googleapis.com' in original_uri:
        # æ›¿æ¢ä¸ºä»£ç†æœåŠ¡å™¨ URL
        new_path = f"/secret-channel{parsed_uri.path}"
        new_uri = urlunparse((
            parsed.scheme,
            f"{parsed.hostname}:{parsed.port or 80}",
            new_path,
            parsed_uri.params,
            parsed_uri.query,
            parsed_uri.fragment
        ))
        self.uri = new_uri
    return original_execute(self, http, num_retries)
```

#### 3.2.2 éŸ³é¢‘åˆ†ææ¨¡å—

**ä½ç½®**: `main.py` (ç¬¬ 224-412 è¡Œ)

**åŠŸèƒ½**: ä¸Šä¼ éŸ³é¢‘åˆ° Geminiï¼Œè°ƒç”¨æ¨¡å‹åˆ†æï¼Œè§£æè¿”å›ç»“æœ

**æµç¨‹**:
1. ä¸Šä¼ æ–‡ä»¶åˆ° Gemini (`genai.upload_file()`)
2. ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ (`wait_for_file_active()`)
3. è°ƒç”¨æ¨¡å‹åˆ†æ (`model.generate_content()`)
4. è§£æ JSON å“åº” (`parse_gemini_response()`)
5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

**å…³é”®å‡½æ•°**:
- `analyze_audio_from_path()`: ä»æ–‡ä»¶è·¯å¾„åˆ†æéŸ³é¢‘
- `wait_for_file_active()`: ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ
- `parse_gemini_response()`: è§£æ Gemini è¿”å›çš„ JSON

#### 3.2.3 ä»»åŠ¡ç®¡ç†æ¨¡å—

**ä½ç½®**: `main.py` (ç¬¬ 581-839 è¡Œ)

**åŠŸèƒ½**: ç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°çŠ¶æ€ï¼‰

**æ•°æ®ç»“æ„**:
```python
tasks_storage = {}  # å­˜å‚¨ä»»åŠ¡å…ƒæ•°æ®
analysis_storage = {}  # å­˜å‚¨åˆ†æç»“æœ
```

**å…³é”®æ¥å£**:
- `POST /api/v1/audio/upload`: ä¸Šä¼ éŸ³é¢‘å¹¶åˆ›å»ºä»»åŠ¡
- `GET /api/v1/tasks/sessions`: è·å–ä»»åŠ¡åˆ—è¡¨
- `GET /api/v1/tasks/sessions/{id}`: è·å–ä»»åŠ¡è¯¦æƒ…
- `GET /api/v1/tasks/sessions/{id}/status`: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

### 3.3 æ•°æ®æ¨¡å‹

#### 3.3.1 è¯·æ±‚/å“åº”æ¨¡å‹

```python
class DialogueItem(BaseModel):
    speaker: str      # è¯´è¯äººæ ‡è¯†
    content: str      # å¯¹è¯å†…å®¹
    tone: str         # è¯­æ°”

class AudioAnalysisResponse(BaseModel):
    speaker_count: int
    dialogues: List[DialogueItem]
    risks: List[str]

class TaskItem(BaseModel):
    session_id: str
    title: str
    start_time: str
    end_time: Optional[str]
    duration: int
    tags: List[str]
    status: str
    emotion_score: Optional[int]
    speaker_count: Optional[int]
```

### 3.4 å¼‚æ­¥ä»»åŠ¡å¤„ç†

**ä½ç½®**: `main.py` (ç¬¬ 648-705 è¡Œ)

**å®ç°**: ä½¿ç”¨ `asyncio.create_task()` åˆ›å»ºå¼‚æ­¥ä»»åŠ¡

**æµç¨‹**:
1. æ¥æ”¶ä¸Šä¼ æ–‡ä»¶
2. è¯»å–æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
3. åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ `analyze_audio_async()`
4. ç«‹å³è¿”å› session_id
5. åå°æ‰§è¡Œåˆ†æä»»åŠ¡

**å…³é”®ä»£ç **:
```python
# è¯»å–æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
file_content = await file.read()
temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
temp_file.write(file_content)
temp_file.close()

# åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))
```

---

## 4. å‰ç«¯æŠ€æœ¯å®ç°

### 4.1 é¡¹ç›®ç»“æ„

```
WorkSurvivalGuide/
â”œâ”€â”€ App/
â”‚   â””â”€â”€ WorkSurvivalGuideApp.swift
â”œâ”€â”€ TaskModule/
â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ TaskListView.swift
â”‚   â”‚   â”œâ”€â”€ TaskDetailView.swift
â”‚   â”‚   â”œâ”€â”€ TaskCardView.swift
â”‚   â”‚   â””â”€â”€ RecordingButtonView.swift
â”‚   â”œâ”€â”€ ViewModels/
â”‚   â”‚   â”œâ”€â”€ TaskListViewModel.swift
â”‚   â”‚   â””â”€â”€ RecordingViewModel.swift
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â””â”€â”€ Task.swift
â”‚   â””â”€â”€ Services/
â”‚       â”œâ”€â”€ NetworkManager.swift
â”‚       â”œâ”€â”€ AudioRecorderService.swift
â”‚       â””â”€â”€ MockNetworkService.swift
â””â”€â”€ Shared/
    â””â”€â”€ AppConfig.swift
```

### 4.2 æ ¸å¿ƒæ¨¡å—

#### 4.2.1 ç½‘ç»œæœåŠ¡æ¨¡å—

**æ–‡ä»¶**: `NetworkManager.swift`

**åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç½‘ç»œè¯·æ±‚

**å…³é”®æ–¹æ³•**:
```swift
// ä¸Šä¼ éŸ³é¢‘
func uploadAudio(fileURL: URL, title: String?) async throws -> UploadResponse

// è·å–ä»»åŠ¡åˆ—è¡¨
func getTaskList(date: Date?, status: String?, page: Int, pageSize: Int) async throws -> TaskListResponse

// è·å–ä»»åŠ¡è¯¦æƒ…
func getTaskDetail(sessionId: String) async throws -> TaskDetailResponse

// è·å–ä»»åŠ¡çŠ¶æ€
func getTaskStatus(sessionId: String) async throws -> TaskStatusResponse
```

**é…ç½®**:
```swift
private let baseURL = "http://47.79.254.213:8001/api/v1"
```

#### 4.2.2 å½•éŸ³æœåŠ¡æ¨¡å—

**æ–‡ä»¶**: `AudioRecorderService.swift`

**åŠŸèƒ½**: ç®¡ç†éŸ³é¢‘å½•åˆ¶

**å…³é”®æ–¹æ³•**:
```swift
func startRecording() -> Bool
func stopRecording() -> URL?
var recordingTime: TimeInterval { get }
```

**å®ç°**: ä½¿ç”¨ `AVAudioRecorder` å½•åˆ¶éŸ³é¢‘ï¼Œä¿å­˜ä¸º M4A æ ¼å¼

#### 4.2.3 å½•éŸ³ ViewModel

**æ–‡ä»¶**: `RecordingViewModel.swift`

**åŠŸèƒ½**: ç®¡ç†å½•éŸ³çŠ¶æ€å’Œä¸Šä¼ æµç¨‹

**å…³é”®å±æ€§**:
```swift
@Published var isRecording: Bool
@Published var recordingTime: TimeInterval
@Published var isUploading: Bool
@Published var uploadProgress: Double
```

**å…³é”®æ–¹æ³•**:
```swift
func startRecording()
func stopRecordingAndUpload()
private func startPollingStatus(sessionId: String)
```

**æµç¨‹**:
1. å¼€å§‹å½•éŸ³ â†’ `startRecording()`
2. åœæ­¢å½•éŸ³ â†’ `stopRecordingAndUpload()`
3. ä¸Šä¼ æ–‡ä»¶ â†’ `NetworkManager.uploadAudio()`
4. è½®è¯¢çŠ¶æ€ â†’ `startPollingStatus()` (æ¯ 3 ç§’æŸ¥è¯¢ä¸€æ¬¡)
5. æ›´æ–°ä»»åŠ¡ â†’ é€šè¿‡ `NotificationCenter` é€šçŸ¥ `TaskListViewModel`

#### 4.2.4 ä»»åŠ¡åˆ—è¡¨ ViewModel

**æ–‡ä»¶**: `TaskListViewModel.swift`

**åŠŸèƒ½**: ç®¡ç†ä»»åŠ¡åˆ—è¡¨çŠ¶æ€

**å…³é”®å±æ€§**:
```swift
@Published var tasks: [TaskItem] = []
@Published var isLoading: Bool = false
```

**å…³é”®æ–¹æ³•**:
```swift
func loadTasks()
func refreshTasks()
```

**é€šçŸ¥ç›‘å¬**:
```swift
// ç›‘å¬æ–°ä»»åŠ¡åˆ›å»º
NotificationCenter.default.addObserver(
    forName: NSNotification.Name("NewTaskCreated"),
    object: nil,
    queue: .main
) { notification in
    // æ·»åŠ æ–°ä»»åŠ¡åˆ°åˆ—è¡¨
}

// ç›‘å¬ä»»åŠ¡åˆ†æå®Œæˆ
NotificationCenter.default.addObserver(
    forName: NSNotification.Name("TaskAnalysisCompleted"),
    object: nil,
    queue: .main
) { notification in
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
}
```

### 4.3 æ•°æ®æ¨¡å‹

#### 4.3.1 Task æ¨¡å‹

**æ–‡ä»¶**: `Task.swift`

```swift
enum TaskStatus: String, Codable {
    case recording = "recording"
    case analyzing = "analyzing"
    case archived = "archived"
    case burned = "burned"
}

struct Task: Codable, Identifiable {
    let id: String              // session_id
    let title: String
    let startTime: Date
    let endTime: Date?
    let duration: Int
    let tags: [String]
    let status: TaskStatus
    let emotionScore: Int?
    let speakerCount: Int?
}
```

#### 4.3.2 API å“åº”æ¨¡å‹

```swift
struct APIResponse<T: Codable>: Codable {
    let code: Int
    let message: String
    let data: T?
    let timestamp: String
}

struct UploadResponse: Codable {
    let sessionId: String
    let audioId: String
    let title: String
    let status: String
    let estimatedDuration: Int
    let createdAt: String
}
```

---

## 5. API æ¥å£æ–‡æ¡£

### 5.1 ä¸Šä¼ éŸ³é¢‘

**æ¥å£**: `POST /api/v1/audio/upload`

**è¯·æ±‚**:
- **Content-Type**: `multipart/form-data`
- **å‚æ•°**:
  - `file` (File, required): éŸ³é¢‘æ–‡ä»¶ (M4A/WAV/MP3)
  - `title` (String, optional): ä»»åŠ¡æ ‡é¢˜

**å“åº”**:
```json
{
  "code": 200,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "session_id": "90eb1544-5a49-4751-9086-5017125df8a4",
    "audio_id": "90eb1544-5a49-4751-9086-5017125df8a4",
    "title": "å½•éŸ³ 16:16",
    "status": "analyzing",
    "estimated_duration": 300,
    "created_at": "2026-01-09T16:16:42.977712"
  },
  "timestamp": "2026-01-09T16:16:42.979196"
}
```

### 5.2 è·å–ä»»åŠ¡åˆ—è¡¨

**æ¥å£**: `GET /api/v1/tasks/sessions`

**è¯·æ±‚å‚æ•°**:
- `page` (int, optional): é¡µç ï¼Œé»˜è®¤ 1
- `page_size` (int, optional): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20
- `date` (string, optional): æ—¥æœŸè¿‡æ»¤ (YYYY-MM-DD)
- `status` (string, optional): çŠ¶æ€è¿‡æ»¤

**å“åº”**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sessions": [
      {
        "session_id": "90eb1544-5a49-4751-9086-5017125df8a4",
        "title": "å½•éŸ³ 16:16",
        "start_time": "2026-01-09T16:16:42.977712",
        "end_time": "2026-01-09T16:17:08.074028",
        "duration": 25,
        "tags": ["#æ­£å¸¸"],
        "status": "archived",
        "emotion_score": 40,
        "speaker_count": 2
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  },
  "timestamp": "2026-01-09T16:20:52.385648"
}
```

### 5.3 è·å–ä»»åŠ¡è¯¦æƒ…

**æ¥å£**: `GET /api/v1/tasks/sessions/{session_id}`

**å“åº”**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "session_id": "90eb1544-5a49-4751-9086-5017125df8a4",
    "title": "å½•éŸ³ 16:16",
    "start_time": "2026-01-09T16:16:42.977712",
    "end_time": "2026-01-09T16:17:08.074028",
    "duration": 25,
    "tags": ["#æ­£å¸¸"],
    "status": "archived",
    "emotion_score": 40,
    "speaker_count": 2,
    "dialogues": [
      {
        "speaker": "è¯´è¯äºº1",
        "content": "å…·ä½“å¯¹è¯å†…å®¹",
        "tone": "å¹³é™"
      }
    ],
    "risks": ["é£é™©ç‚¹1", "é£é™©ç‚¹2"],
    "created_at": "2026-01-09T16:16:42.977712",
    "updated_at": "2026-01-09T16:17:08.074028"
  },
  "timestamp": "2026-01-09T16:20:52.385648"
}
```

### 5.4 æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**æ¥å£**: `GET /api/v1/tasks/sessions/{session_id}/status`

**å“åº”**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "session_id": "90eb1544-5a49-4751-9086-5017125df8a4",
    "status": "archived",
    "progress": 1.0,
    "estimated_time_remaining": 0,
    "updated_at": "2026-01-09T16:17:08.074028"
  },
  "timestamp": "2026-01-09T16:20:52.282068"
}
```

### 5.5 å¥åº·æ£€æŸ¥

**æ¥å£**: `GET /health`

**å“åº”**:
```json
{
  "message": "éŸ³é¢‘åˆ†ææœåŠ¡æ­£åœ¨è¿è¡Œ",
  "status": "ok"
}
```

---

## 6. æ•°æ®æµå’Œäº¤äº’æµç¨‹

### 6.1 éŸ³é¢‘ä¸Šä¼ å’Œåˆ†ææµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»å½•éŸ³æŒ‰é’®
   â†“
2. AudioRecorderService.startRecording()
   â†“
3. ç”¨æˆ·åœæ­¢å½•éŸ³
   â†“
4. AudioRecorderService.stopRecording() â†’ è¿”å›éŸ³é¢‘æ–‡ä»¶ URL
   â†“
5. RecordingViewModel.stopRecordingAndUpload()
   â†“
6. NetworkManager.uploadAudio(fileURL, title)
   â†“
7. POST /api/v1/audio/upload
   â†“
8. åç«¯æ¥æ”¶æ–‡ä»¶ï¼Œåˆ›å»ºä¸´æ—¶æ–‡ä»¶
   â†“
9. åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ analyze_audio_async()
   â†“
10. ç«‹å³è¿”å› session_id (çŠ¶æ€: analyzing)
    â†“
11. å‰ç«¯æ¥æ”¶å“åº”ï¼Œåˆ›å»ºæ–°ä»»åŠ¡ï¼ˆçŠ¶æ€: analyzingï¼‰
    â†“
12. å‰ç«¯å¼€å§‹è½®è¯¢çŠ¶æ€ï¼ˆæ¯ 3 ç§’ï¼‰
    â†“
13. åç«¯å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ:
    - ä¸Šä¼ æ–‡ä»¶åˆ° Gemini
    - ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ
    - è°ƒç”¨æ¨¡å‹åˆ†æ
    - è§£æè¿”å›ç»“æœ
    - æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º archived
    â†“
14. å‰ç«¯è½®è¯¢åˆ°çŠ¶æ€ä¸º archived
    â†“
15. å‰ç«¯è·å–ä»»åŠ¡è¯¦æƒ…
    â†“
16. æ›´æ–°ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
```

### 6.2 ä»»åŠ¡åˆ—è¡¨åŠ è½½æµç¨‹

```
1. TaskListView æ˜¾ç¤º
   â†“
2. TaskListViewModel.loadTasks()
   â†“
3. NetworkManager.getTaskList()
   â†“
4. GET /api/v1/tasks/sessions
   â†“
5. åç«¯è¿”å›ä»»åŠ¡åˆ—è¡¨
   â†“
6. å‰ç«¯è§£æå¹¶æ˜¾ç¤º
```

### 6.3 ä»»åŠ¡è¯¦æƒ…æŸ¥çœ‹æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ä»»åŠ¡å¡ç‰‡
   â†“
2. NavigationLink è·³è½¬åˆ° TaskDetailView
   â†“
3. TaskDetailView åŠ è½½æ—¶è°ƒç”¨ getTaskDetail()
   â†“
4. NetworkManager.getTaskDetail(sessionId)
   â†“
5. GET /api/v1/tasks/sessions/{session_id}
   â†“
6. åç«¯è¿”å›ä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«å¯¹è¯å’Œé£é™©ï¼‰
   â†“
7. å‰ç«¯æ˜¾ç¤ºè¯¦æƒ…
```

---

## 7. éƒ¨ç½²é…ç½®

### 7.1 åç«¯éƒ¨ç½²

#### 7.1.1 æœåŠ¡å™¨ä¿¡æ¯

- **æœåŠ¡å™¨ IP**: 47.79.254.213
- **åœ°åŒº**: æ–°åŠ å¡
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 24.04.2 LTS
- **ç”¨æˆ·**: admin
- **é¡¹ç›®è·¯å¾„**: `/home/admin/gemini-audio-service`

#### 7.1.2 ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `.env`

```bash
GEMINI_API_KEY=AIzaSyCiOOgxgMkTuqw6sXTT08WbD7R6kMK-k08
PROXY_URL=http://47.79.254.213/secret-channel
USE_PROXY=true
```

#### 7.1.3 æœåŠ¡å¯åŠ¨

```bash
cd /home/admin/gemini-audio-service
source venv/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
nohup python3 main.py > ~/gemini-service.log 2>&1 &
```

#### 7.1.4 æœåŠ¡ç®¡ç†

```bash
# åœæ­¢æœåŠ¡
pkill -f "python3 main.py"

# æŸ¥çœ‹æ—¥å¿—
tail -f ~/gemini-service.log

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8001/health
```

### 7.2 Nginx åå‘ä»£ç†é…ç½®

#### 7.2.1 é…ç½®æ–‡ä»¶ä½ç½®

`/etc/nginx/conf.d/gemini.conf`

#### 7.2.2 é…ç½®å†…å®¹

```nginx
server {
    listen 80;
    server_name _;

    # å…è®¸ä¸Šä¼  100MB å¤§æ–‡ä»¶
    client_max_body_size 100M;

    # åå‘ä»£ç†åˆ° Google Gemini API
    location /secret-channel/ {
        # ç§»é™¤ /secret-channel å‰ç¼€ï¼Œè½¬å‘åˆ° Google API
        rewrite ^/secret-channel/(.*) /$1 break;
        
        # è½¬å‘åˆ° Google Gemini API
        proxy_pass https://generativelanguage.googleapis.com/;
        
        # SSL ç›¸å…³è®¾ç½®
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        # è®¾ç½®å¿…è¦çš„è¯·æ±‚å¤´
        proxy_set_header Host generativelanguage.googleapis.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering off;
        proxy_request_buffering off;
    }
    
    # å¤„ç† /secret-channelï¼ˆæ²¡æœ‰æœ«å°¾æ–œæ ï¼‰çš„æƒ…å†µ
    location = /secret-channel {
        return 301 /secret-channel/;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }
}
```

#### 7.2.3 Nginx ç®¡ç†

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload nginx

# é‡å¯ Nginx
sudo systemctl restart nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx
```

### 7.3 å‰ç«¯é…ç½®

#### 7.3.1 API åœ°å€é…ç½®

**æ–‡ä»¶**: `NetworkManager.swift`

```swift
private let baseURL = "http://47.79.254.213:8001/api/v1"
```

#### 7.3.2 Mock æ¨¡å¼é…ç½®

**æ–‡ä»¶**: `AppConfig.swift`

```swift
class AppConfig {
    static let shared = AppConfig()
    var useMockData = false  // è®¾ç½®ä¸º false ä½¿ç”¨çœŸå® API
}
```

---

## 8. å…³é”®é—®é¢˜è§£å†³æ–¹æ¡ˆ

### 8.1 ä»£ç†æœåŠ¡å™¨é…ç½®é—®é¢˜

**é—®é¢˜**: `google-generativeai` SDK ä¸æ”¯æŒç›´æ¥è®¾ç½®è‡ªå®šä¹‰ base URL

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ Monkey Patch ä¿®æ”¹ `HttpRequest.execute` æ–¹æ³•

**å®ç°ä½ç½®**: `main.py` ç¬¬ 68-100 è¡Œ

### 8.2 æ–‡ä»¶ä¸Šä¼ è·¯å¾„é—®é¢˜

**é—®é¢˜**: Google API è¿”å›çš„ Location å¤´ä¸åŒ…å« `/secret-channel` å‰ç¼€

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Nginx ä¸­é…ç½® `location /secret-channel/` å¤„ç†æ‰€æœ‰è·¯å¾„

### 8.3 å¼‚æ­¥ä»»åŠ¡å‚æ•°ä¼ é€’é—®é¢˜

**é—®é¢˜**: `analyze_audio_async()` ç¼ºå°‘ `task_data` å‚æ•°

**è§£å†³æ–¹æ¡ˆ**: 
1. åœ¨è°ƒç”¨å‰è¯»å–æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
2. ç¡®ä¿æ‰€æœ‰å‚æ•°æ­£ç¡®ä¼ é€’

**å…³é”®ä»£ç **:
```python
# è¯»å–æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
file_content = await file.read()
temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
temp_file.write(file_content)
temp_file.close()
temp_file_path = temp_file.name

# åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))
```

### 8.4 Nginx é…ç½®ç©º URI é—®é¢˜

**é—®é¢˜**: è®¿é—® `/secret-channel`ï¼ˆæ— æœ«å°¾æ–œæ ï¼‰æ—¶ï¼Œrewrite è§„åˆ™å¯¼è‡´ç©º URI

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ  `location = /secret-channel` é‡å®šå‘åˆ° `/secret-channel/`

### 8.5 å‰ç«¯çŠ¶æ€è½®è¯¢é—®é¢˜

**é—®é¢˜**: ä»»åŠ¡åˆ†æå®Œæˆåï¼Œå‰ç«¯éœ€è¦åŠæ—¶æ›´æ–°çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨è½®è¯¢æœºåˆ¶ï¼Œæ¯ 3 ç§’æŸ¥è¯¢ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€

**å®ç°ä½ç½®**: `RecordingViewModel.swift` ç¬¬ 211-281 è¡Œ

---

## 9. æµ‹è¯•éªŒè¯

### 9.1 æœåŠ¡ç«¯è‡ªæµ‹

**æµ‹è¯•è„šæœ¬**: æœåŠ¡ç«¯è‡ªæµ‹è„šæœ¬

**æµ‹è¯•ç»“æœ**:
- âœ… æœåŠ¡è¿è¡Œæ­£å¸¸
- âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- âœ… éŸ³é¢‘åˆ†ææˆåŠŸ
- âœ… ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢æ­£å¸¸
- âœ… ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸

**æµ‹è¯•æ•°æ®**:
- ä»»åŠ¡ ID: `90eb1544-5a49-4751-9086-5017125df8a4`
- çŠ¶æ€: `archived`
- è¯´è¯äººæ•°é‡: 2
- æƒ…ç»ªåˆ†æ•°: 40
- æ ‡ç­¾: `#æ­£å¸¸`

### 9.2 å‰åç«¯è”é€šæµ‹è¯•

**æµ‹è¯•ç»“æœ**: âœ… å‰åç«¯å·²è”é€šï¼ŒåŠŸèƒ½æ­£å¸¸

**éªŒè¯ç‚¹**:
1. âœ… å®¢æˆ·ç«¯å¯ä»¥ä¸Šä¼ éŸ³é¢‘
2. âœ… æœåŠ¡ç«¯å¯ä»¥æ¥æ”¶å¹¶å¤„ç†
3. âœ… ä»»åŠ¡åˆ—è¡¨å¯ä»¥æ­£å¸¸æ˜¾ç¤º
4. âœ… ä»»åŠ¡çŠ¶æ€å¯ä»¥æ­£å¸¸æŸ¥è¯¢
5. âœ… ä»»åŠ¡è¯¦æƒ…å¯ä»¥æ­£å¸¸æŸ¥çœ‹

### 9.3 æ€§èƒ½æŒ‡æ ‡

- **æ–‡ä»¶ä¸Šä¼ æ—¶é—´**: çº¦ 2-3 ç§’ï¼ˆ0.17MB éŸ³é¢‘æ–‡ä»¶ï¼‰
- **æ–‡ä»¶å¤„ç†æ—¶é—´**: çº¦ 2-3 ç§’
- **æ¨¡å‹åˆ†ææ—¶é—´**: çº¦ 20-25 ç§’
- **æ€»å¤„ç†æ—¶é—´**: çº¦ 25-30 ç§’ï¼ˆ0.17MB éŸ³é¢‘æ–‡ä»¶ï¼‰

---

## 10. åç»­ä¼˜åŒ–å»ºè®®

### 10.1 çŸ­æœŸä¼˜åŒ–

1. **æ•°æ®åº“è¿ç§»**: ä»å†…å­˜å­˜å‚¨è¿ç§»åˆ° PostgreSQL
2. **ç¼“å­˜æœºåˆ¶**: æ·»åŠ  Redis ç¼“å­˜ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
3. **é”™è¯¯å¤„ç†**: å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
4. **æ—¥å¿—ç³»ç»Ÿ**: å®Œå–„æ—¥å¿—ç³»ç»Ÿï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### 10.2 ä¸­æœŸä¼˜åŒ–

1. **WebSocket æ”¯æŒ**: ä½¿ç”¨ WebSocket æ›¿ä»£è½®è¯¢ï¼Œå®ç°å®æ—¶çŠ¶æ€æ›´æ–°
2. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡æ–‡ä»¶ä¸Šä¼ å’Œåˆ†æ
3. **æ–‡ä»¶å­˜å‚¨**: ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆOSSï¼‰å­˜å‚¨éŸ³é¢‘æ–‡ä»¶
4. **ä»»åŠ¡é˜Ÿåˆ—**: ä½¿ç”¨ Celery ç®¡ç†å¼‚æ­¥ä»»åŠ¡

### 10.3 é•¿æœŸä¼˜åŒ–

1. **å¾®æœåŠ¡æ¶æ„**: æ‹†åˆ†ä¸ºå¤šä¸ªå¾®æœåŠ¡
2. **å®¹å™¨åŒ–éƒ¨ç½²**: ä½¿ç”¨ Docker å’Œ Kubernetes
3. **ç›‘æ§å‘Šè­¦**: æ·»åŠ  Prometheus å’Œ Grafana ç›‘æ§
4. **CI/CD**: å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

---

## 11. é™„å½•

### 11.1 ç›¸å…³æ–‡æ¡£

- `ARCHITECTURE_DESIGN.md`: æ¶æ„è®¾è®¡æ–‡æ¡£
- `TECHNICAL_DESIGN.md`: æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£
- `iOS_DEVELOPMENT_GUIDE.md`: iOS å¼€å‘æŒ‡å—
- `README.md`: é¡¹ç›®è¯´æ˜æ–‡æ¡£

### 11.2 è”ç³»æ–¹å¼

- **é¡¹ç›®è·¯å¾„**: `/Users/liudan/Desktop/AIå†›å¸ˆ/gemini-audio-service`
- **æœåŠ¡å™¨è·¯å¾„**: `/home/admin/gemini-audio-service`
- **æ–‡æ¡£ç‰ˆæœ¬**: v0.1
- **æœ€åæ›´æ–°**: 2026-01-09

---

**æ–‡æ¡£ç»“æŸ**

