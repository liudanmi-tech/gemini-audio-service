# ============================================
# 修复命令 - 最终版（推荐使用）
# 先执行第一步确认路径，再执行第二步修复
# ============================================

# ============================================
# 第一步：确认项目路径（先执行这个）
# ============================================
find /home /root -name "main.py" -path "*/gemini-audio-service/main.py" 2>/dev/null

# 如果上面找到了路径（比如 /home/admin/gemini-audio-service/main.py），
# 那么项目目录就是 /home/admin/gemini-audio-service
# 记下这个路径，在第二步中使用

# ============================================
# 第二步：执行修复（替换下面的路径为第一步找到的目录路径）
# ============================================

# 方法A：如果项目在 /home/admin/gemini-audio-service
cd /home/admin/gemini-audio-service && python3 << 'END'
import shutil, time
backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):' in content:
    content = content.replace('async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):', 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):')
    print("✅ 修复1: 函数定义添加task_data")

if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))' in content:
    content = content.replace('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))', 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))')
    print("✅ 修复2: 函数调用添加task_data")

if 'from fastapi import FastAPI, UploadFile, File, HTTPException' in content and 'Query' not in content:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    print("✅ 修复3: 添加Query导入")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

import py_compile
py_compile.compile('main.py', doraise=True)
print(f"✅ 修复完成！备份: {backup}")
END

# 重启服务
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl -s http://localhost:8001/health

# ============================================
# 如果方法A失败，尝试方法B（项目在 /root/gemini-audio-service）
# ============================================
# cd /root/gemini-audio-service && python3 << 'END'
# ... (同样的Python代码)
# END
# cd /root/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl -s http://localhost:8001/health

