# 技能架构 v0.4 技术文档

**文档版本**: v0.4

**创建日期**: 2026-01-XX

**状态**: 已实现

---

## 📋 目录

1. [架构概述](#1-架构概述)

2. [三层架构设计](#2-三层架构设计)

3. [技能注册表](#3-技能注册表)

4. [路由代理（Router Agent）](#4-路由代理router-agent)

5. [技能执行流程](#5-技能执行流程)

6. [技能格式规范](#6-技能格式规范)

7. [API 接口](#7-api-接口)

8. [实现细节](#8-实现细节)

---

## 1. 架构概述

### 1.1 设计理念

v0.4 技能架构采用**动态策略生成**模式，替代固定 Prompt 模板。系统通过三层架构自动识别场景、选择技能、生成策略。

### 1.2 核心组件

```
┌─────────────────────────────────────────────────────────────┐

│ 对话输入 (Transcript) │

└─────────────────────────────────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────────┐

│ 感知层 (Perception Layer) │

│ - 场景识别 (Scene Classification) │

│ - 关键词提取 │

│ - 情绪分析 │

└─────────────────────────────────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────────┐

│ 调度层 (Orchestration Layer) │

│ - Router Agent (AI 路由代理) │

│ - 技能匹配 (Skill Matching) │

│ - 技能组合 (Skill Composition) │

└─────────────────────────────────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────────┐

│ 执行层 (Execution Layer) │

│ - 技能执行 (Skill Execution) │

│ - Prompt 模板填充 │

│ - 知识库检索 │

│ - 结果组合 (Result Composition) │

└─────────────────────────────────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────────┐

│ 策略输出 (Strategies) │

└─────────────────────────────────────────────────────────────┘
```

---

## 2. 三层架构设计

### 2.1 感知层 (Perception Layer)

**职责**: 从对话中识别场景和关键信息

**功能**:

- 场景分类（职场、家庭、教育等）

- 关键词提取

- 情绪识别

- 风险点检测

**实现**:

```python
# skills/router.py

def classify_scene(transcript: str) -> Dict:

"""

使用 Gemini API 进行场景分类

返回: {

"category": "workplace_jungle",

"confidence": 0.95,

"keywords": ["升职", "加薪", "资源"],

"emotions": ["焦虑", "压力"]

}

"""
```

### 2.2 调度层 (Orchestration Layer)

**职责**: 根据场景选择并组合技能

**功能**:

- Router Agent: AI 驱动的技能选择

- 技能匹配: 基于关键词和场景匹配技能

- 技能组合: 多个技能的组合执行

**实现**:

```python
# skills/router.py

def match_skills(scene_info: Dict) -> List[str]:

"""

匹配适合的技能

返回: ["workplace_jungle", "upward_management"]

"""
```

### 2.3 执行层 (Execution Layer)

**职责**: 执行选定的技能，生成策略

**功能**:

- 加载技能 Prompt 模板

- 填充对话内容

- 检索知识库

- 调用 Gemini API 生成策略

- 组合多个技能的结果

**实现**:

```python
# skills/executor.py

async def execute_skill(

skill_id: str,

transcript: Dict,

knowledge_base: Optional[str] = None

) -> Dict:

"""

执行单个技能

返回: {

"strategies": [...],

"visual": [...],

"_execution_metadata": {...}

}

"""
```

---

## 3. 技能注册表

### 3.1 技能存储

技能存储在 `skills/` 目录下，每个技能一个文件夹：

```
skills/

├── workplace_jungle/

│ ├── SKILL.md # 技能定义（YAML Frontmatter + Prompt）

│ ├── references/

│ │ └── knowledge_base.md # 知识库

│ ├── scripts/ # 可选：Python 脚本

│ └── assets/ # 可选：资源文件

├── family_relationship/

│ └── SKILL.md

└── education_communication/

└── SKILL.md
```

### 3.2 技能格式

每个技能必须包含 `SKILL.md` 文件，格式如下：

```markdown
---

name: 职场丛林

id: workplace_jungle

version: 1.0.0

description: 职场博弈与权力逻辑分析

keywords:

- 升职

- 加薪

- 资源

- 权力

- 冲突

- PUA

- 情感勒索

scenarios:

- 资源申请

- 晋升竞争

- 冲突化解

- 情感勒索应对

- 工作汇报

priority: 10

---



# 技能 Prompt 模板



```prompt

你是一位职场深度分析专家，擅长从权力博弈、向上管理、沟通突破、心理防御四个维度分析职场对话。



## 分析框架



### 四层分析框架

1. **博弈剖析**: 识别权力位阶、隐性诉求、沟通模式、心理防御

2. **应对路径**: Power Play / Upward Management / Communication Breakthrough / Psychological Defense



{transcript_json}



请基于以上对话，生成策略建议。
```

## 知识库

```markdown
# 职场博弈与权力逻辑

...
```

```
### 3.3 技能注册



技能在系统启动时自动注册到数据库：



```python

# skills/registry.py

def register_skill(skill_dir: str) -> Dict:

"""

注册技能到数据库

返回技能元数据

"""
```

---

## 4. 路由代理（Router Agent）

### 4.1 工作原理

Router Agent 是一个 AI 组件，负责：

1. 分析对话内容

2. 识别场景类型

3. 匹配最适合的技能

### 4.2 实现方式

使用 Gemini API 进行场景分类：

```python
# skills/router.py

async def classify_scene(transcript: str) -> Dict:

"""

使用 Gemini API 进行场景分类

"""

prompt = f"""

分析以下对话，识别场景类型和关键词：

{transcript}

返回 JSON 格式：

{{

"category": "workplace_jungle|family_relationship|education_communication|...",

"confidence": 0.95,

"keywords": ["关键词1", "关键词2"],

"emotions": ["情绪1", "情绪2"]

}}

"""

# 调用 Gemini API

response = await call_gemini(prompt)

return parse_json(response)
```

### 4.3 技能匹配

基于场景分类结果匹配技能：

```python
def match_skills(scene_info: Dict) -> List[str]:

"""

根据场景信息匹配技能

"""

matched_skills = []

# 1. 基于场景类别匹配

category = scene_info.get("category")

if category:

skills = get_skills_by_category(category)

matched_skills.extend(skills)

# 2. 基于关键词匹配

keywords = scene_info.get("keywords", [])

for keyword in keywords:

skills = get_skills_by_keyword(keyword)

matched_skills.extend(skills)

# 去重并按优先级排序

matched_skills = sorted(set(matched_skills), key=lambda s: get_skill_priority(s), reverse=True)

return matched_skills
```

---

## 5. 技能执行流程

### 5.1 完整流程

```
1. 接收对话输入

↓

2. 感知层：场景分类

↓

3. 调度层：匹配技能

↓

4. 执行层：执行技能

├─ 加载 Prompt 模板

├─ 填充对话内容

├─ 检索知识库

├─ 调用 Gemini API

└─ 解析返回结果

↓

5. 组合多个技能的结果

↓

6. 返回最终策略
```

### 5.2 代码实现

```python
# main.py 或 skills/executor.py

async def analyze_with_skills(transcript: Dict) -> Dict:

# 1. 场景分类

scene_info = await classify_scene(transcript)

# 2. 匹配技能

skill_ids = match_skills(scene_info)

# 3. 执行技能

skill_results = []

for skill_id in skill_ids:

result = await execute_skill(skill_id, transcript)

skill_results.append(result)

# 4. 组合结果

final_result = compose_results(skill_results)

return final_result
```

---

## 6. 技能格式规范

### 6.1 SKILL.md 结构

```markdown
---

# YAML Frontmatter

name: 技能名称

id: skill_id

version: 1.0.0

description: 技能描述

keywords: [关键词列表]

scenarios: [场景列表]

priority: 优先级（数字，越大越优先）

---



# 技能 Prompt 模板



```prompt

这里是 Prompt 模板内容

{transcript_json} # 对话内容占位符
```

## 知识库（可选）

```markdown
# 知识库内容

...
```

```
### 6.2 Prompt 模板要求



- 必须包含 `{transcript_json}` 占位符

- 可以包含其他占位符（如 `{knowledge_base}`）

- 使用 ````prompt` 代码块包裹



### 6.3 知识库格式



- 存储在 `references/knowledge_base.md`

- 支持 Markdown 格式

- 在 Prompt 中通过 `{knowledge_base}` 引用



---



## 7. API 接口



### 7.1 策略分析接口



```python

POST /api/v1/analysis/strategy



Request:

{

"session_id": "uuid",

"transcript": {

"dialogues": [...]

}

}



Response:

{

"strategies": [

{

"title": "策略标题",

"content": "策略内容",

"type": "warning|suggestion|action",

"_source_skill": "workplace_jungle"

}

],

"visual": [...],

"applied_skills": ["workplace_jungle"],

"scene_category": "workplace_jungle",

"scene_confidence": 0.95

}
```

### 7.2 技能管理接口

```python
# 获取所有技能

GET /api/v1/skills



# 获取单个技能详情

GET /api/v1/skills/{skill_id}



# 重新加载技能

POST /api/v1/skills/{skill_id}/reload
```

---

## 8. 实现细节

### 8.1 技能加载器

```python
# skills/loader.py

def load_skill_from_file(skill_path: str) -> Dict:

"""

从文件加载技能

"""

# 1. 读取 SKILL.md

# 2. 解析 YAML Frontmatter

# 3. 提取 Prompt 模板

# 4. 加载知识库（如果存在）

pass



def extract_prompt_template(markdown_content: str) -> str:

"""

从 Markdown 中提取 Prompt 模板

查找 ```prompt 代码块

"""

pass
```

### 8.2 技能执行器

```python
# skills/executor.py

async def execute_skill(

skill_id: str,

transcript: Dict,

knowledge_base: Optional[str] = None

) -> Dict:

"""

执行技能

"""

# 1. 加载技能

skill = get_skill(skill_id)

# 2. 填充 Prompt

prompt = skill["prompt_template"].format(

transcript_json=json.dumps(transcript, ensure_ascii=False),

knowledge_base=knowledge_base or ""

)

# 3. 调用 Gemini API

response = await call_gemini(prompt)

# 4. 解析结果

result = parse_gemini_response(response)

# 5. 添加执行元数据

result["_execution_metadata"] = {

"skill_id": skill_id,

"priority": skill["priority"]

}

return result
```

### 8.3 结果组合器

```python
# skills/composer.py

def compose_results(skill_results: List[Dict]) -> Dict:

"""

组合多个技能的结果

- 去重（基于相似度）

- 排序（基于优先级）

"""

# 1. 合并所有策略

# 2. 去重（基于 title 和 content 相似度）

# 3. 排序（基于优先级）

# 4. 返回组合结果

pass
```

---

## 9. 数据库模型

### 9.1 Skill 表

```sql
CREATE TABLE skills (

id VARCHAR(100) PRIMARY KEY,

name VARCHAR(255) NOT NULL,

version VARCHAR(50),

description TEXT,

keywords TEXT[],

scenarios TEXT[],

priority INTEGER DEFAULT 0,

prompt_template TEXT,

knowledge_base TEXT,

skill_metadata JSONB,

created_at TIMESTAMP DEFAULT NOW(),

updated_at TIMESTAMP DEFAULT NOW()

);
```

---

## 10. 使用示例

### 10.1 添加新技能

1. 在 `skills/` 目录下创建新文件夹

2. 创建 `SKILL.md` 文件

3. 填写 YAML Frontmatter 和 Prompt 模板

4. 可选：添加 `references/knowledge_base.md`

5. 重启服务，技能自动注册

### 10.2 调用技能分析

```python
# 在 analyze_audio_async 中

transcript = {

"dialogues": [...]

}



# 使用技能架构分析

strategy_result = await analyze_with_skills(transcript)
```

---

## 11. 优势

1. **动态性**: 根据场景自动选择技能，无需手动配置

2. **可扩展**: 添加新技能只需创建文件夹和 SKILL.md

3. **模块化**: 每个技能独立，互不干扰

4. **可组合**: 多个技能可以组合使用

5. **知识库**: 支持技能专属知识库

---

## 12. 未来改进

1. **技能版本管理**: 支持技能版本升级

2. **技能依赖**: 支持技能之间的依赖关系

3. **技能测试**: 自动化测试框架

4. **技能市场**: 用户自定义技能

5. **A/B 测试**: 不同技能版本的对比测试

---

**文档版本**: v0.4

**最后更新**: 2026-01-XX

**维护者**: 开发团队
