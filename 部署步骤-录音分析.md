# 部署步骤（录音分析与 Nginx 代理）

## 一键部署（推荐）

在**本地**项目根目录执行：

```bash
bash 一键部署-录音分析.sh
```

脚本会：上传 `main.py` 和 `scripts/` 到服务器 → 在服务器上配置 Nginx（`/secret-channel/` 代理到 Gemini）→ 重启 Python 应用。

---

## 手动部署

### 1. 上传代码（本地执行）

```bash
scp main.py admin@47.79.254.213:~/gemini-audio-service/
scp -r scripts admin@47.79.254.213:~/gemini-audio-service/
```

### 2. 在服务器上配置 Nginx 与重启应用

SSH 登录后执行：

```bash
cd ~/gemini-audio-service
sudo bash scripts/fix_nginx_gemini_proxy.sh
# 若没有 scripts，可手动按 脚本内容 执行：移除 default、写入 gemini-proxy、nginx -t、reload nginx

source venv/bin/activate
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py >> ~/gemini-audio-service.log 2>&1 &
```

### 3. 环境变量（服务器 .env）

确保服务器项目目录下的 `.env` 包含：

- `GEMINI_API_KEY=你的密钥`
- `USE_PROXY=true`
- `PROXY_FORCE_LOCALHOST=true`（应用与 Nginx 同机时用 127.0.0.1 走代理）

---

## 录音分析报错：「上传文件失败… string indices must be integers」

**含义**：上传到 Gemini 时，SDK 期望收到 JSON，实际收到了**字符串**（多为 HTML 错误页），对响应做 `resp["key"]` 时就会报该错。

**常见原因**：Nginx 把 `/secret-channel/` 转发到 `generativelanguage.googleapis.com` 时**失败**（超时、无法连接等），返回 **502 Bad Gateway** 的 HTML；SDK 把 HTML 当 JSON 解析就会触发该错误。

**根本原因**：当前服务器**无法直接访问 Google**（例如在中国大陆，直连会被阻断或超时）。

### 可行方案

1. **换能访问 Google 的服务器**  
   将应用部署到能直连 Google 的机器（如海外 ECS），并正确配置 Nginx 与 `GEMINI_API_KEY`。

2. **在当前服务器前加“上游代理”**  
   若必须用当前服务器，需要一台**能访问 Google 的代理**（海外代理或带 VPN 的机器），然后：
   - 在该代理上暴露一个转发到 `https://generativelanguage.googleapis.com` 的服务，
   - 在当前服务器的 Nginx 里，把 `proxy_pass` 指向该代理转发的地址，  
   形成「当前服务器 → 代理 → Google」的链路。

3. **确认 Nginx 与 API Key**  
   若服务器本身能访问 Google，再检查：
   - `.env` 里 `GEMINI_API_KEY` 正确，
   - 只启用一个 `default_server`（避免与 `default` 站点冲突），  
   - `sudo nginx -t` 通过后 `sudo systemctl reload nginx`。

---

## 验证

- **Nginx**：`curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1/secret-channel/`（期望 4xx/5xx 来自 Google，不是 502 来自 Nginx）。
- **应用**：看 `~/gemini-audio-service.log` 是否有「已 patch … 以使用反向代理」「文件上传成功」等日志；若仍为「上传文件失败… string indices」，按上面「可行方案」排查网络与代理。
