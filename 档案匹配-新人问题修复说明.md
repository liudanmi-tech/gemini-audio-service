# 档案匹配 - 修复说明

## 问题 1：新人被误标为已有档案

当录音中有**新身份的人**（无档案）时，新人被错误地映射成了已有档案（如吴过）。

## 问题 2：自己与他人互换

当对话为「自己 + 新人」时，Speaker_0（新人）被标成梁志远，Speaker_1（自己）被标成吴过，完全颠倒。

## 根因

原逻辑用 **Speaker 序号 → profile 下标** 的盲映射，未利用 transcript 中的 `is_me`（Speaker_1=用户/自己）。

## 修复方案（v2：利用 is_me）

1. **查询档案**时获取 `relationship_type`，找出 relationship_type="自己" 的 profile_id
2. **从 transcript 找** `is_me=true` 的 speaker（约定为 Speaker_1）
3. **仅映射「自己」**：`speaker_mapping[speaker_with_is_me] = self_profile_id`
4. **其他说话人（含新人）**：不再做盲映射，保持 Speaker_0 等原始标签
5. **单说话人单档案**：保留原有单射映射（兼容自录场景）

## 生效链路

| 环节 | 修复后行为 |
|------|------------|
| speaker_mapping | 仅包含有档案的说话人，新人不在其中 |
| conversation_summary | `profile_names.get(speaker_mapping.get(sp,""), sp)` 未映射者用 sp（Speaker_X）✓ |
| 任务详情 dialogues | `_speaker_to_display` 未映射者返回 Speaker_X ✓ |
| 记忆 B 钩子 | build_memory_payload 同样逻辑 ✓ |

## 部署

修改 `main.py` 中 `analyze_audio_async` 的声纹/档案映射逻辑后，重启服务生效。**已分析过的任务**需重新上传录音分析才能获得正确映射。
