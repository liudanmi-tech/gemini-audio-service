# 档案图片保存失败调试说明

## 问题描述

用户报告"档案图片保存失败"，但从日志可以看到：
- ✅ 图片上传成功（两次都成功）
- ✅ 图片URL正确返回
- ❌ 但没有看到保存档案的日志（"开始更新档案"或"开始创建档案"）

## 可能的原因

1. **用户在上传过程中点击了保存**：此时`isUploadingPhoto = true`，保存被阻止
2. **保存时出错但没有显示错误**：可能错误被静默处理了
3. **保存按钮没有正确触发**：可能UI交互有问题

## 已添加的调试信息

### 1. 保存按钮点击日志

在保存按钮的`action`中添加了详细的日志：
```swift
print("💾 [ProfileEditView] 点击保存按钮")
print("⚠️ [ProfileEditView] 正在保存中，忽略重复点击")
print("⚠️ [ProfileEditView] 图片正在上传中，阻止保存")
print("⚠️ [ProfileEditView] 图片上传失败，询问是否继续保存")
print("✅ [ProfileEditView] 开始执行保存操作")
```

### 2. 保存操作执行日志

在`performSave()`函数中添加了详细的日志：
```swift
print("💾 [ProfileEditView] performSave 开始执行")
print("   isUploadingPhoto: \(isUploadingPhoto)")
print("   photoUploadError: \(photoUploadError ?? "nil")")
print("   viewModel.photoUrl: \(viewModel.photoUrl ?? "nil")")
print("💾 [ProfileEditView] 同步后的数据:")
print("   name: \(viewModel.name)")
print("   relationship: \(viewModel.relationship)")
print("   notes: \(viewModel.notes)")
print("   photoUrl: \(viewModel.photoUrl ?? "nil")")
```

### 3. 错误处理日志

在错误处理中添加了更详细的错误信息：
```swift
print("❌ [ProfileEditView] 保存失败: \(error)")
print("   错误类型: \(type(of: error))")
print("   错误描述: \(error.localizedDescription)")
if let nsError = error as NSError? {
    print("   错误代码: \(nsError.code)")
    print("   错误域: \(nsError.domain)")
    print("   用户信息: \(nsError.userInfo)")
}
```

## 调试步骤

1. **重新编译并运行应用**
2. **尝试保存档案**，观察控制台日志：
   - 如果看到"点击保存按钮"，说明按钮被点击了
   - 如果看到"图片正在上传中，阻止保存"，说明在上传过程中点击了保存
   - 如果看到"开始执行保存操作"，说明保存逻辑开始执行
   - 如果看到"保存失败"，查看详细的错误信息

3. **根据日志输出诊断问题**：
   - **没有看到"点击保存按钮"**：可能是UI交互问题，按钮没有正确响应
   - **看到"图片正在上传中，阻止保存"**：这是正常行为，需要等待上传完成后再保存
   - **看到"开始执行保存操作"但没有后续日志**：可能是网络请求卡住了
   - **看到"保存失败"**：查看详细错误信息，可能是网络、服务器或数据格式问题

## 建议的工作流程

1. **选择图片** → 等待上传完成（看到"图片上传成功"）
2. **填写其他信息**（名称、关系、备注等）
3. **点击保存** → 应该看到"开始执行保存操作"和"档案更新成功"

## 注意事项

- 图片上传是异步的，需要等待上传完成
- 上传过程中会显示"上传中..."提示
- 上传完成后，`isUploadingPhoto`会自动设置为`false`
- 如果上传失败，会显示错误提示，用户可以选择继续保存（保留原有头像）

## 下一步

请运行应用并尝试保存档案，然后查看控制台日志。根据日志输出可以准确诊断问题：
- 如果看到详细的错误信息，可以根据错误类型进一步修复
- 如果看到"图片正在上传中，阻止保存"，这是正常行为，需要等待上传完成
- 如果没有看到任何日志，可能是UI交互问题，需要检查按钮绑定
