# 上传文件到服务器 - 替代方案

## ✅ 当前状态

服务已经在运行（curl 测试成功），但 SSH 密码认证失败。

## 🔧 方案 1: 使用阿里云控制台"命令助手"（推荐）

从你的截图看到有"命令助手"功能，可以直接在服务器上执行命令。

### 步骤：

1. **登录阿里云控制台**
   - 进入轻量应用服务器
   - 找到你的服务器实例

2. **打开"命令助手"**
   - 点击"命令助手"标签
   - 点击"执行命令"

3. **创建文件内容**
   - 使用以下命令创建 `main.py`：

```bash
cd ~/gemini-audio-service
cat > main.py << 'ENDOFFILE'
```

然后需要粘贴文件内容。但这个方法比较复杂。

## 🔧 方案 2: 使用 Python 脚本写入文件（最简单）

在阿里云控制台的"命令助手"中，执行以下 Python 脚本：

```python
python3 << 'PYEOF'
import urllib.request

# 从 GitHub 或直接读取本地文件内容
# 这里我们需要先读取本地文件，然后写入服务器
# 但更简单的方法是：直接在服务器上使用 Python 创建文件

# 方法：使用 base64 编码传输，或者直接分段写入
# 由于文件较大，建议使用方案 3
PYEOF
```

## 🔧 方案 3: 分段创建文件（推荐）

由于文件较大，我们可以分段创建。在阿里云控制台的"命令助手"中执行：

### 步骤 1: 备份原文件

```bash
cd ~/gemini-audio-service
cp main.py main.py.backup
```

### 步骤 2: 使用 Python 脚本修复关键部分

```bash
cd ~/gemini-audio-service
python3 << 'PYEOF'
# 读取原文件
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 修复 upload_audio_api 函数
old_code = """        tasks_storage[session_id] = task_data
        
        # 异步分析
        asyncio.create_task(analyze_audio_async(session_id, file, task_data))"""

new_code = """        tasks_storage[session_id] = task_data
        
        # 读取文件内容（必须在异步任务之前读取，因为 UploadFile 只能读取一次）
        file_content = await file.read()
        file_filename = file.filename
        
        # 创建新的 UploadFile 对象用于异步分析
        from io import BytesIO
        new_file = UploadFile(
            filename=file_filename,
            file=BytesIO(file_content)
        )
        
        # 异步分析
        asyncio.create_task(analyze_audio_async(session_id, new_file, task_data))"""

if old_code in content:
    content = content.replace(old_code, new_code)
    print("✅ 找到需要修复的代码")
else:
    print("⚠️  未找到需要修复的代码，可能已经修复过了")

# 确保导入了 BytesIO
if 'from io import BytesIO' not in content:
    # 在导入部分添加
    import_line = 'from io import BytesIO'
    if 'from typing import' in content:
        # 在 typing 导入后添加
        content = content.replace(
            'from typing import List, Optional, Any',
            'from io import BytesIO\nfrom typing import List, Optional, Any'
        )
    else:
        # 在 datetime 导入后添加
        content = content.replace(
            'from datetime import datetime',
            f'from io import BytesIO\nfrom datetime import datetime'
        )
    print("✅ 已添加 BytesIO 导入")

# 修复 analyze_audio_async 中的导入（如果存在）
content = content.replace(
    '        # 创建新的 UploadFile 对象用于异步分析\n        from io import BytesIO',
    '        # 创建新的 UploadFile 对象用于异步分析'
)

# 写入文件
with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("✅ 文件修复完成")
PYEOF
```

### 步骤 3: 检查语法并重启

```bash
cd ~/gemini-audio-service
source venv/bin/activate
python3 -m py_compile main.py
pkill -f "python3 main.py"
sleep 2
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &
sleep 3
curl http://localhost:8001/health
```

## 🔧 方案 4: 使用阿里云控制台的文件管理（如果有）

如果阿里云控制台有文件上传功能，可以直接上传 `main.py` 文件。

## 🔧 方案 5: 配置 SSH 密钥（长期方案）

如果经常需要上传文件，建议配置 SSH 密钥：

```bash
# 在本地 Mac 终端执行
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_alibaba

# 查看公钥
cat ~/.ssh/id_rsa_alibaba.pub

# 复制公钥内容，然后在阿里云控制台的"密钥对"中配置
```

## 🎯 推荐操作

**现在最简单的方法**：

1. 在阿里云控制台打开"命令助手"
2. 执行上面的"方案 3"中的 Python 脚本
3. 重启服务

或者，如果服务已经在运行，我们可以先测试一下是否真的需要修复。让我检查一下当前代码是否已经有问题。

