# 音频上传→分析完成→匹配技能：耗时分布说明

基于真实 session `c77ba84f-7fe0-4f8b-9376-9a567af85972` 的服务器日志分析（64MB 音频，约 1 小时）。

---

## 一、整体流程与轮询机制

1. **客户端**：上传音频 → 获得 `session_id` → 开始轮询 `GET /tasks/sessions/{id}/status`
2. **轮询策略**：首次等待 8 秒，之后每 3 秒轮询一次，直到 `status == "archived"`
3. **服务端**：上传后立即返回，异步执行分析；分析完成后将 `status` 置为 `archived`

---

## 二、从上传到 status=archived 的耗时分布

| 阶段 | 耗时（秒） | 占比 | 说明 |
|------|-----------|------|------|
| 1. 上传响应（含 DB+OSS） | 8.9 | 5% | 创建 Session、保存任务数据 |
| 2. 本地持久化 | 4.2 | 2% | 保存原音频到本地、更新 Session |
| 3. 大文件切分 | **27.0** | **16%** | 64MB → 4 个分片（切分 + 写入临时文件） |
| 4. Gemini 上传（4 个分片） | 10.6 | 6% | 串行上传到 Gemini Files API |
| 5. generate_content | **116.6** | **67%** | 音频转写 + 结构化分析（主耗时） |
| 6. 结果解析 + DB 更新 | 12.5 | 7% | JSON 解析、Session/分析结果写入 |
| **总计（到 status=archived）** | **~173** | 100% | 约 2 分 53 秒 |

> 说明：`status=archived` 在「DB Session 更新」时即写入，后续声纹、conversation_summary、记忆等在此之后异步进行，不影响轮询结束。

---

## 三、各阶段详细日志时间戳（session c77ba84f）

| 时间戳 | 阶段 | 累计耗时 |
|--------|------|----------|
| 23:43:04 | 生成 session_id | 0s |
| 23:43:13 | 上传响应（DB Session 创建） | 8.9s |
| 23:43:14 | 异步分析开始 | 9s |
| 23:43:18 | 原音频保存到本地 | 13s |
| 23:43:20 | 本地存储完成，进入 analyze_audio_from_path | 16s |
| 23:43:47 | 大文件切分完成，开始上传第 1 个分片 | 43s |
| 23:43:50 | 分片 1 上传成功 (3.12s) | 46s |
| 23:43:53 | 分片 2 上传成功 (2.25s) | 49s |
| 23:43:55 | 分片 3 上传成功 (2.89s) | 51s |
| 23:43:58 | 分片 4 上传成功 (2.32s)，开始 generate_content | 54s |
| 23:45:54 | generate_content 成功（116.58s） | 170s |
| 23:46:04 | 删除分片临时文件，analyze 返回 | 180s |
| 23:46:07 | **数据库 Session 已更新（status=archived）** | **183s** |

---

## 四、耗时最长的三个阶段

### 1. generate_content（约 116.6 秒）— 主瓶颈

- **内容**：Gemini 对约 1 小时音频做转写 + 结构化分析
- **占比**：约 67%
- **可优化方向**：
  - 使用流式返回，边转写边展示（需改 prompt 和 API 调用方式）
  - 考虑音频压缩或限长（如只分析前 30 分钟）
  - 评估更快的模型或 region（若 Gemini 支持）

### 2. 大文件切分（约 27 秒）

- **内容**：64MB 切分为 4 个分片并写入临时文件
- **占比**：约 16%
- **可优化方向**：
  - 优化切分逻辑（流式切分、避免多次 I/O）
  - 使用更大分片减少数量（注意 Gemini 单文件大小限制）

### 3. Gemini 分片上传（约 10.6 秒）

- **内容**：4 个分片串行上传到 Gemini Files API
- **占比**：约 6%
- **可优化方向**：
  - 分片并行上传（若 API 支持）
  - 检查网络链路（服务器→Gemini 的延迟）

---

## 五、轮询次数估算

- 首次等待：8 秒
- 轮询间隔：3 秒
- 总耗时到 `archived`：约 173 秒（从异步开始算）

**轮询次数** ≈ 1（首次）+ (173 - 8) / 3 ≈ **56 次**，与「50–60 次」的体感一致。

---

## 六、策略分析（在 status=archived 之后）

策略分析在 `archived` 之后异步执行，**不阻塞轮询结束**，但会影响「详情页策略是否已生成」：

| 阶段 | 典型耗时 |
|------|----------|
| 场景识别（Gemini） | <1s |
| 技能匹配 | 0.6s |
| 技能执行（文本策略，Gemini） | 23–25s |
| 图片生成（每张） | 9–13s |
| 图片上传 OSS | 0.7–2.6s/张 |

若需要「策略分析完成后再显示详情」，则需在客户端再增加一层轮询（如 `strategy_ready` 字段）。

---

## 七、优化建议汇总

| 优先级 | 方向 | 预期收益 |
|--------|------|----------|
| 高 | 优化 generate_content（流式/限长/模型） | 显著缩短主耗时 |
| 中 | 优化大文件切分逻辑 | 可减少 ~20s |
| 中 | 分片并行上传 Gemini | 可减少 ~5–8s |
| 低 | 缩短首次轮询等待（8s→5s） | 体感略快 |
| 低 | 轮询间隔 3s→2s | 减少无效轮询次数 |
