# 修复服务端代码指南

## 问题分析

根据日志，错误发生在：
- **时间**: 2026-01-09 13:33:24 和 13:33:34
- **错误**: `analyze_audio_async() missing 1 required positional argument: 'task_data'`

但是你的任务是在 2026-01-11 上传的，这说明：
1. **服务器上可能还在运行旧版本的代码**
2. **需要查看1月11日的日志**
3. **可能需要更新服务器上的代码**

## 步骤1：查看1月11日的日志

```bash
# SSH连接到服务器
ssh admin@47.79.254.213

# 查看1月11日的日志
grep "2026-01-11" ~/gemini-audio-service.log | tail -n 200

# 或者查看特定任务的日志
grep "5ce813e1-d670-4ef0-b585-9bcdf07f18c7" ~/gemini-audio-service.log

# 查看最近的日志（包括今天）
tail -n 500 ~/gemini-audio-service.log
```

## 步骤2：检查服务器上的代码版本

```bash
# SSH连接到服务器
ssh admin@47.79.254.213

# 进入项目目录
cd /home/admin/gemini-audio-service

# 查看 upload_audio_api 函数中调用 analyze_audio_async 的代码（应该在第628行附近）
sed -n '620,630p' main.py

# 或者直接查看整个 upload_audio_api 函数
grep -A 50 "async def upload_audio_api" main.py
```

## 步骤3：如果代码确实需要更新

如果服务器上的代码是旧版本，需要：

### 方法1：直接编辑服务器上的文件

```bash
# SSH连接到服务器
ssh admin@47.79.254.213

# 进入项目目录
cd /home/admin/gemini-audio-service

# 备份当前文件
cp main.py main.py.backup

# 使用 nano 或 vi 编辑文件
nano main.py

# 找到 upload_audio_api 函数（大约第581行），确保第628行是：
# asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))
```

### 方法2：从本地上传更新后的文件

```bash
# 在你的本地机器上（确保 main.py 是正确的版本）

# 使用 scp 上传文件
scp main.py admin@47.79.254.213:/home/admin/gemini-audio-service/main.py

# SSH连接并重启服务
ssh admin@47.79.254.213
cd /home/admin/gemini-audio-service

# 停止旧服务
pkill -f "python.*main.py"

# 重启服务
source venv/bin/activate
nohup python3 main.py > ~/gemini-service.log 2>&1 &
```

## 步骤4：重启服务

```bash
# SSH连接到服务器
ssh admin@47.79.254.213

# 停止服务
pkill -f "python.*main.py"

# 或者如果知道进程ID
ps aux | grep "python.*main.py"
kill <PID>

# 检查服务是否已停止
ps aux | grep "python.*main.py"

# 进入项目目录
cd /home/admin/gemini-audio-service

# 激活虚拟环境
source venv/bin/activate

# 启动服务
nohup python3 main.py > ~/gemini-service.log 2>&1 &

# 检查服务是否启动成功
ps aux | grep "python.*main.py"
curl http://localhost:8001/health
```

## 快速诊断命令

```bash
# 一键诊断：检查代码版本和服务状态
ssh admin@47.79.254.213 << 'EOF'
echo "=== 检查代码版本 ==="
cd /home/admin/gemini-audio-service
echo "检查 upload_audio_api 函数中的调用（应该在第628行）："
sed -n '625,630p' main.py | grep "analyze_audio_async"

echo ""
echo "=== 检查服务状态 ==="
ps aux | grep "python.*main.py" | grep -v grep

echo ""
echo "=== 查看最近的错误日志 ==="
tail -n 100 ~/gemini-audio-service.log | grep -i "error\|失败\|failed" | tail -n 10
EOF
```

## 验证修复

修复后，可以：

1. 查看日志确认没有错误：
```bash
tail -f ~/gemini-audio-service.log
```

2. 测试上传功能（使用curl或从iOS客户端测试）

3. 查看任务状态是否正常更新
