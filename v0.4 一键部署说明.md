# v0.4 一键部署说明

## 概述

由于无法直接通过SSH连接到服务器，我无法自动执行部署。但是，我已经创建了自动化部署脚本，您可以在服务器上运行它来自动完成所有操作。

## 使用方法

### 方法1: 在服务器上直接运行（推荐）

1. **SSH连接到服务器**:

```bash
ssh admin@47.79.254.213
```

2. **进入项目目录并上传脚本**（如果需要）:

```bash
cd ~/gemini-audio-service

# 如果脚本不在服务器上，使用scp上传
```

3. **运行自动化部署脚本**:

```bash
chmod +x v0.4自动化部署脚本.sh

./v0.4自动化部署脚本.sh
```

脚本会自动完成：

- ✅ 验证代码结构

- ✅ 执行数据库迁移

- ✅ 注册技能到数据库

- ✅ 停止旧服务

- ✅ 启动新服务

- ✅ 运行功能测试

### 方法2: 使用expect脚本自动化SSH（需要密码）

如果您想从本地自动执行，可以使用expect脚本：

```bash
# 在本地执行（需要先安装expect）

expect << 'EOF'

set timeout 60

spawn ssh admin@47.79.254.213

expect {

"password:" {

send "Ld123456\r"

}

timeout {

exit 1

}

}

expect "$ " {

send "cd ~/gemini-audio-service\r"

expect "$ "

send "chmod +x v0.4自动化部署脚本.sh\r"

expect "$ "

send "./v0.4自动化部署脚本.sh\r"

expect "$ "

send "exit\r"

}

expect eof

EOF
```

**注意**: 这种方式会暴露密码，仅用于开发环境。

### 方法3: 分步手动执行

如果自动化脚本有问题，可以手动执行以下步骤：

#### 步骤1: 执行数据库迁移

```bash
cd ~/gemini-audio-service

source venv/bin/activate

python3 database/migrations/run_migration_v0.4.py
```

#### 步骤2: 注册技能到数据库

```bash
python3 注册技能到数据库.py
```

#### 步骤3: 重启服务

```bash
# 停止旧服务

pkill -f 'python.*main.py'



# 启动新服务

nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &



# 检查服务状态

sleep 5

ps aux | grep '[p]ython.*main.py'

tail -50 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|ERROR"
```

#### 步骤4: 运行测试

```bash
python3 测试v0.4功能.py
```

## 验证部署

### 1. 检查服务状态

```bash
# 检查进程

ps aux | grep '[p]ython.*main.py'



# 检查日志

tail -50 ~/gemini-audio-service.log



# 健康检查

curl http://localhost:8001/health
```

### 2. 测试技能管理API

```bash
# 获取Token（需要先登录）

TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \

-H "Content-Type: application/json" \

-d '{"phone": "13800138000", "code": "123456"}' | jq -r '.data.token')



# 获取技能列表

curl -X GET "http://localhost:8001/api/v1/skills" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | jq
```

### 3. 验证技能化架构

1. **上传音频文件**（通过iOS客户端或API）

2. **等待音频分析完成**（status变为`archived`）

3. **调用策略生成接口**:

```bash
curl -X POST "http://localhost:8001/api/v1/tasks/sessions/{session_id}/strategies" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | jq
```

4. **检查返回数据**:
- 应该包含 `applied_skills` 字段（使用的技能列表）

- 应该包含 `scene_category` 字段（识别的场景类别）

- 应该包含 `scene_confidence` 字段（置信度）

## 故障排查

### 问题1: 数据库迁移失败

**检查**:

- 数据库连接是否正常（`.env` 文件中的 `DATABASE_URL`）

- 数据库用户是否有足够权限

**解决**:

```bash
# 检查.env文件

cat ~/gemini-audio-service/.env | grep DATABASE_URL



# 手动执行SQL脚本

psql -h <数据库地址> -U <用户名> -d gemini_audio_db -f database/migrations/add_skills_tables.sql
```

### 问题2: 技能注册失败

**检查**:

- 技能目录是否存在：`ls -la ~/gemini-audio-service/skills/`

- SKILL.md文件是否存在：`ls -la ~/gemini-audio-service/skills/*/SKILL.md`

**解决**:

- 确保所有技能目录和SKILL.md文件都已上传到服务器

- 检查文件权限

### 问题3: 服务启动失败

**检查日志**:

```bash
tail -100 ~/gemini-audio-service.log | grep -E "ERROR|Traceback|ImportError"
```

**常见原因**:

- 缺少依赖：`pip3 install -r requirements.txt`

- 环境变量未配置：检查 `.env` 文件

- 端口被占用：检查是否有其他服务占用8001端口

## 部署后的验证清单

- [ ] 数据库表创建成功（skills、skill_executions）

- [ ] strategy_analysis表新增字段成功

- [ ] 4个技能都注册到数据库

- [ ] 服务启动成功（进程存在，日志正常）

- [ ] 健康检查通过（curl http://localhost:8001/health）

- [ ] 技能列表API返回正确数据

- [ ] 场景识别功能正常（如果网络可用）

- [ ] 策略生成使用技能化架构（检查applied_skills字段）

---

**文档版本**: v0.4

**创建日期**: 2026-01-16
