# 避免端口占用说明

## 端口分配（固定、不冲突）

| 端口 | 用途 | 说明 |
|------|------|------|
| **80** | Nginx | 对外 HTTP，只由 Nginx 监听；不要用其他程序占 80。 |
| **8000** | FastAPI 应用 | 技能、档案、列表、详情等**全部接口**由该进程提供；默认只起**一个**实例。 |
| **8001** | 可选 | 仅当设置 `UVICORN_PORT=8001` 时使用；与 8000 **二选一**，不要同时起 8000 和 8001。 |

**要点**：没有「不同应用不同端口」的多服务——当前只有 **Nginx(80)** 和 **一个 FastAPI 进程(8000 或 8001)**。端口占用多半是**同一应用被启动了多次**（例如既用 systemd 又用手动 nohup）。

---

## 端口被占用常见原因

1. **重复启动**：用脚本 `nohup python3 main.py &` 起了一次，又用 systemd 或另一脚本再起一次，两个进程都抢 8000。
2. **未先停再起**：直接执行「启动」而没有先 `pkill`，旧进程仍在，新进程绑定 8000 报 `Address already in use`。
3. **Nginx 报 80 被占用**：多半是已有别的 Nginx 或其它程序在监听 80；或本机开了多个 Nginx 配置且都在 `listen 80`。

---

## 怎么避免

### 1. 只保留一种启动方式（推荐）

- **要么**只用 **systemd** 管理应用（`systemctl start/restart gemini-audio-service`），**不要**再在脚本里用 `nohup python3 main.py` 或 `nohup uvicorn ...`。
- **要么**只用**脚本**（例如下面的「安全重启」脚本）启动，**不要**启用或不要同时用 systemd 的同一个服务。

避免「脚本起一份 + systemd 起一份」导致两个进程抢 8000。

### 2. 重启前先停干净再起

任何重启逻辑都应：

1. 按进程名结束旧进程：  
   `pkill -f "python.*main.py"` 和 `pkill -f "uvicorn main:app"`（或使用下面的 `安全重启应用.sh`）。
2. 等待 2～3 秒让端口释放：`sleep 2` 或 `sleep 3`。
3. 再启动**一个**实例（`python3 main.py` 或 `uvicorn main:app --host 0.0.0.0 --port 8000`）。

### 3. Nginx 只用 80

- 确保只有**一个** Nginx 在跑，且只在一个配置里 `listen 80`（或 80 + 443）。
- 不要在本机再起其它占 80 的服务（如别的反向代理、测试用 HTTP 服务）。

### 4. 应用只占一个端口

- 默认只监听 **8000**（`main.py` 里 `UVICORN_PORT` 默认 8000）。
- 若改为 8001，则环境变量 `UVICORN_PORT=8001`，且 Nginx 的 `proxy_pass` 要指向 `127.0.0.1:8001`。
- **8000 与 8001 只选一个**，不要同时起两个端口。

---

## 推荐：用「安全重启」脚本

项目中的 **`安全重启应用.sh`**（在服务器上执行）会：

1. 结束所有 `python.*main.py` 和 `uvicorn main:app` 进程。
2. 等待端口释放。
3. 只启动**一个**应用实例（默认 8000）。

部署或更新代码后，用这一种方式重启，可避免端口被重复占用。

---

## 端口占用时怎么查、怎么关

在服务器上：

```bash
# 看 8000 / 8001 谁在监听
ss -tlnp | grep -E '8000|8001'
# 或
lsof -i :8000
lsof -i :8001

# 看有哪些 uvicorn/main 进程
ps aux | grep -E "uvicorn|main.py" | grep -v grep

# 结束所有相关进程后再启动
pkill -f "uvicorn main:app"
pkill -f "python.*main.py"
sleep 3
# 再执行你的启动命令（仅一次）
```

Nginx 报 80 被占用时：

```bash
sudo ss -tlnp | grep :80
# 或
sudo lsof -i :80
# 关掉重复的 nginx 或其它占 80 的进程后，再 sudo systemctl start nginx
```

---

## 小结

| 问题 | 做法 |
|------|------|
| 应用端口 8000 被占用 | 只保留一种启动方式；重启前先 pkill 再 sleep 再起一个实例。 |
| Nginx 说 80 被占用 | 保证只一个 Nginx、只一处 listen 80；关掉其它占 80 的程序。 |
| 不确定谁在占端口 | 用 `ss -tlnp` / `lsof -i :端口` 查；用 `安全重启应用.sh` 统一重启应用。 |
