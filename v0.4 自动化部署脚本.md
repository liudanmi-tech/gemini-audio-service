!/bin/bash

# v0.4 自动化部署脚本

# 在服务器上运行此脚本，自动完成数据库迁移、技能注册、服务重启和测试

set -e

# 颜色输出

RED='\033[0;31m'

GREEN='\033[0;32m'

YELLOW='\033[1;33m'

NC='\033[0m' # No Color

# 配置

PROJECT_DIR="$HOME/gemini-audio-service"

LOG_FILE="$HOME/v0.4-deployment.log"

# 日志函数

log_info() {

echo -e "${GREEN}[INFO]${NC} $1" | tee -a "$LOG_FILE"

}

log_warn() {

echo -e "${YELLOW}[WARN]${NC} $1" | tee -a "$LOG_FILE"

}

log_error() {

echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"

}

# 检查是否在项目目录

if [ ! -f "$PROJECT_DIR/main.py" ]; then

log_error "项目目录不存在: $PROJECT_DIR"

exit 1

fi

cd "$PROJECT_DIR" || exit 1

log_info "========== 开始 v0.4 自动化部署 =========="

log_info "项目目录: $PROJECT_DIR"

log_info "日志文件: $LOG_FILE"

# 步骤1: 检查虚拟环境

log_info ""

log_info "步骤1: 检查虚拟环境..."

if [ -z "$VIRTUAL_ENV" ]; then

if [ -d "$PROJECT_DIR/venv" ]; then

log_info "激活虚拟环境..."

source "$PROJECT_DIR/venv/bin/activate"

else

log_warn "未检测到虚拟环境，建议先创建: python3 -m venv venv"

fi

else

log_info "虚拟环境已激活: $VIRTUAL_ENV"

fi

# 步骤2: 验证代码结构

log_info ""

log_info "步骤2: 验证代码结构..."

if [ -f "$PROJECT_DIR/测试v0.4架构.sh" ]; then

bash "$PROJECT_DIR/测试v0.4架构.sh" 2>&1 | tee -a "$LOG_FILE"

else

log_warn "验证脚本不存在，跳过验证"

fi

# 步骤3: 执行数据库迁移

log_info ""

log_info "步骤3: 执行数据库迁移..."

if [ -f "$PROJECT_DIR/database/migrations/run_migration_v0.4.py" ]; then

python3 "$PROJECT_DIR/database/migrations/run_migration_v0.4.py" 2>&1 | tee -a "$LOG_FILE"

MIGRATION_STATUS=$?

if [ $MIGRATION_STATUS -eq 0 ]; then

log_info "✅ 数据库迁移成功"

else

log_error "❌ 数据库迁移失败，退出码: $MIGRATION_STATUS"

exit 1

fi

else

log_error "迁移脚本不存在: database/migrations/run_migration_v0.4.py"

exit 1

fi

# 步骤4: 注册技能到数据库

log_info ""

log_info "步骤4: 注册技能到数据库..."

if [ -f "$PROJECT_DIR/注册技能到数据库.py" ]; then

python3 "$PROJECT_DIR/注册技能到数据库.py" 2>&1 | tee -a "$LOG_FILE"

REGISTER_STATUS=$?

if [ $REGISTER_STATUS -eq 0 ]; then

log_info "✅ 技能注册成功"

else

log_error "❌ 技能注册失败，退出码: $REGISTER_STATUS"

exit 1

fi

else

log_error "注册脚本不存在: 注册技能到数据库.py"

exit 1

fi

# 步骤5: 验证技能注册

log_info ""

log_info "步骤5: 验证技能注册..."

python3 << 'EOF' 2>&1 | tee -a "$LOG_FILE"

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills

async def verify():

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')}")

asyncio.run(verify())

EOF

# 步骤6: 停止旧服务

log_info ""

log_info "步骤6: 停止旧服务..."

if pgrep -f 'python.*main.py' > /dev/null; then

log_info "找到运行中的服务进程，正在停止..."

pkill -f 'python.*main.py' || true

sleep 2

if pgrep -f 'python.*main.py' > /dev/null; then

log_warn "服务进程仍在运行，尝试强制停止..."

pkill -9 -f 'python.*main.py' || true

sleep 1

fi

log_info "✅ 旧服务已停止"

else

log_info "未发现运行中的服务"

fi

# 步骤7: 启动新服务

log_info ""

log_info "步骤7: 启动新服务..."

if [ -f "$PROJECT_DIR/main.py" ]; then

log_info "启动服务（后台运行）..."

nohup python3 "$PROJECT_DIR/main.py" > "$HOME/gemini-audio-service.log" 2>&1 &

SERVICE_PID=$!

sleep 5

# 检查服务是否启动成功

if ps -p $SERVICE_PID > /dev/null 2>&1; then

log_info "✅ 服务已启动，PID: $SERVICE_PID"

else

log_error "❌ 服务启动失败，检查日志: $HOME/gemini-audio-service.log"

tail -50 "$HOME/gemini-audio-service.log" | tail -20

exit 1

fi

else

log_error "main.py 不存在"

exit 1

fi

# 步骤8: 检查服务状态

log_info ""

log_info "步骤8: 检查服务状态..."

sleep 3

if curl -s http://localhost:8001/health > /dev/null 2>&1; then

log_info "✅ 服务健康检查通过"

else

log_warn "⚠️ 服务健康检查失败，检查日志..."

tail -50 "$HOME/gemini-audio-service.log" | grep -E "ERROR|error|启动|Uvicorn|Application startup" | tail -10

fi

# 步骤9: 运行功能测试

log_info ""

log_info "步骤9: 运行功能测试..."

if [ -f "$PROJECT_DIR/测试v0.4功能.py" ]; then

python3 "$PROJECT_DIR/测试v0.4功能.py" 2>&1 | tee -a "$LOG_FILE" || {

log_warn "⚠️ 功能测试失败（可能需要网络连接），但不影响部署"

}

else

log_warn "功能测试脚本不存在，跳过测试"

fi

# 完成

log_info ""

log_info "========== v0.4 自动化部署完成 =========="

log_info ""

log_info "部署日志已保存到: $LOG_FILE"

log_info "服务日志: $HOME/gemini-audio-service.log"

log_info ""

log_info "下一步操作："

log_info "1. 检查服务状态: ps aux | grep 'python.*main.py'"

log_info "2. 查看服务日志: tail -f $HOME/gemini-audio-service.log"

log_info "3. 测试API接口: curl http://localhost:8001/api/v1/skills"

log_info "4. 验证技能化架构: 上传音频文件并生成策略，检查是否使用技能化架构"
