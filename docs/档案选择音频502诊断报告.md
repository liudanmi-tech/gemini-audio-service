# 档案选择音频 502 诊断报告

## 服务端日志分析结论

### 1. 请求流程（正常部分）

- **POST extract-segment** 收到请求
- **OSS 下载原音频**：成功（约 30MB，2 秒内完成）
- **pydub/ffmpeg 剪切**：已开始执行
- **无 [Response] 日志**：说明请求在返回响应前异常结束

### 2. 可能原因

| 情况 | 说明 |
|------|------|
| **处理超时** | 剪切 30MB 音频 + 上传片段可能超过某处 60s 限制，导致 Nginx 返回 502 |
| **片段上传 OSS 失败** | 若 OSS `put_object` 失败且之前无正确异常处理，可能导致异常中断 |
| **返回本地路径** | 之前 OSS 失败时退回本地路径，客户端得到非 HTTP URL 无法使用 |

### 3. 已做修复

1. **upload_segment_bytes**  
   - OSS 失败时直接抛出异常，不再返回本地路径  
   - 增加日志，便于排查  

2. **extract-segment API**  
   - 捕获上传异常并返回 503，附带清晰错误信息  
   - 增加成功/失败日志  

3. **客户端**  
   - 已支持解析 502/503 的 FastAPI `detail` 并展示给用户  

## 后续建议

1. **部署更新**：上传并部署 `api/audio_segments.py`、`utils/audio_storage.py`  
2. **再次验证**：重新执行一次「选择音频」流程  
3. **若仍失败**：在服务器执行  
   ```bash
   tail -f ~/gemini-audio-service.log | grep -E "extract|片段|503|502"
   ```  
   观察日志中 `extract-segment` 和 `片段上传 OSS` 相关输出。
