# 20MB+ 音频上传 502 错误修复说明

## 问题现象

- 上传进度显示到 100%，但最终提示「本地上传失败」
- 服务端返回 **502 Bad Gateway**（Nginx 错误页 HTML，非 JSON）
- 常见于 **20MB 以上** 的录音文件

## 原因分析

1. **Nginx 超时**：上传大文件时，Nginx 转发请求体到 Python 后端需要较长时间；若 `proxy_send_timeout` / `proxy_read_timeout` 过短（如 60s），会触发 502
2. **请求体大小限制**：`client_max_body_size` 若小于文件大小，可能被拒绝或导致异常

## 修复步骤

### 1. 在服务器上执行 Nginx 修复脚本（推荐）

在**项目根目录**执行：

```bash
chmod +x SSH修复Nginx502大文件上传.sh
./SSH修复Nginx502大文件上传.sh
```

脚本会：
- 将 `client_max_body_size` 设为 100M
- 将 `proxy_read_timeout`、`proxy_send_timeout`、`proxy_connect_timeout` 设为 600 秒

### 2. 若无法执行脚本，可手动修改 Nginx 配置

SSH 登录服务器后：

```bash
# 编辑 API 站点配置（按实际路径选择）
sudo nano /etc/nginx/sites-available/gemini-and-api
# 或
sudo nano /etc/nginx/sites-available/default
```

在 `location /api/` 或代理到 8000 端口的 `location` 块内添加/修改：

```nginx
client_max_body_size 100M;
client_body_buffer_size 128k;
proxy_read_timeout 600s;
proxy_connect_timeout 600s;
proxy_send_timeout 600s;
```

保存后：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 3. iOS 端超时已调整

`NetworkManager` 中上传超时已从 180 秒调整为 **600 秒**，以适配大文件上传。

## 验证

修复后，重新尝试上传 20MB+ 录音。若仍有问题，可在服务器查看日志：

```bash
tail -200 ~/gemini-audio-service.log | grep -E "收到音频|upload|ERROR"
```

确认是否出现「收到音频上传请求」等日志，以判断请求是否到达 Python 服务。
