# v0.4 测试注册完整步骤

## 在服务器上执行以下步骤

### 步骤1: 设置文件权限

```bash
cd ~/gemini-audio-service



# 设置所有脚本执行权限

chmod +x *.sh

chmod +x 注册技能到数据库.py 测试v0.4功能.py

chmod +x database/migrations/run_migration_v0.4.py



# 验证文件存在

ls -la 验证部署.sh 服务器执行v0.4部署.sh 注册技能到数据库.py
```

---

### 步骤2: 验证代码结构（可选）

```bash
# 检查skills目录结构

ls -la skills/

ls -la skills/*/SKILL.md



# 应该看到4个技能的SKILL.md文件

# - skills/workplace_jungle/SKILL.md

# - skills/family_relationship/SKILL.md

# - skills/education_communication/SKILL.md

# - skills/brainstorm/SKILL.md
```

---

### 步骤3: 执行数据库迁移

```bash
# 激活虚拟环境（如果存在）

source venv/bin/activate 2>/dev/null || true



# 执行数据库迁移

python3 database/migrations/run_migration_v0.4.py
```

**预期输出**: 应该看到 "数据库迁移完成" 或类似成功消息

**如果迁移失败**，检查：

- 数据库连接是否正常（检查 `.env` 文件中的 `DATABASE_URL`）

- 是否有执行权限：`ls -la database/migrations/run_migration_v0.4.py`

---

### 步骤4: 注册技能到数据库

```bash
# 注册所有技能（4个）

python3 注册技能到数据库.py
```

**预期输出**: 应该看到类似以下消息

```
✅ 技能 'workplace_jungle' 注册成功或已更新。

✅ 技能 'family_relationship' 注册成功或已更新。

✅ 技能 'education_communication' 注册成功或已更新。

✅ 技能 'brainstorm' 注册成功或已更新。
```

---

### 步骤5: 验证技能注册

#### 方法1: 使用Python脚本验证（推荐）

```bash
python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

try:

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')} (category: {skill.get('category')}, priority: {skill.get('priority', 0)})")

if len(skills) == 4:

print("\n✅ 所有技能注册成功！")

elif len(skills) < 4:

print(f"\n⚠️ 警告: 应该注册4个技能，但只找到 {len(skills)} 个")

else:

print(f"\n⚠️ 警告: 技能数量异常 ({len(skills)} 个)")

except Exception as e:

print(f"❌ 验证失败: {e}")

import traceback

traceback.print_exc()



asyncio.run(verify())

EOF
```

**预期输出**:

```
✅ 数据库中共有 4 个技能:

- workplace_jungle: 职场丛林法则 (category: workplace, priority: 100)

- family_relationship: 亲密关系技能 (category: family, priority: 90)

- education_communication: 孩子教育沟通 (category: education, priority: 85)

- brainstorm: 头脑风暴 (category: brainstorm, priority: 80)



✅ 所有技能注册成功！
```

#### 方法2: 使用测试脚本验证

```bash
# 运行架构验证脚本

./测试v0.4架构.sh
```

#### 方法3: 使用验证部署脚本

```bash
# 运行完整的验证脚本

./验证部署.sh
```

---

### 步骤6: 测试技能加载（可选）

```bash
python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import get_skill



async def test_skill_loading():

try:

async with AsyncSessionLocal() as db:

skill_ids = ["workplace_jungle", "family_relationship", "education_communication", "brainstorm"]

for skill_id in skill_ids:

skill = await get_skill(skill_id, db)

if skill:

print(f"✅ 技能 '{skill_id}' 加载成功: {skill.get('name')}")

else:

print(f"❌ 技能 '{skill_id}' 加载失败")

except Exception as e:

print(f"❌ 测试失败: {e}")

import traceback

traceback.print_exc()



asyncio.run(test_skill_loading())

EOF
```

---

### 步骤7: 完整功能测试（需要网络连接和Gemini API）

```bash
# 运行完整功能测试

python3 测试v0.4功能.py
```

**注意**: 此测试需要：

- 网络连接（访问Gemini API）

- `.env` 文件中配置的 `GEMINI_API_KEY`

- 可能需要代理配置（`PROXY_URL`）

**预期输出**:

```
========== 测试1: 场景识别 ==========

✅ 场景识别成功:

- 主要场景: workplace

- 识别的场景数量: 1



========== 测试2: 技能匹配 ==========

✅ 技能匹配成功，匹配到 1 个技能:

- workplace_jungle: 职场丛林法则 (优先级: 100, 场景置信度: 0.85)



========== 测试3: 技能加载 ==========

✅ 技能加载成功: workplace_jungle
```

---

## 快速执行（一键脚本）

在服务器上执行：

```bash
cd ~/gemini-audio-service && \

echo "========== 步骤1: 设置权限 ==========" && \

chmod +x *.sh 注册技能到数据库.py 测试v0.4功能.py database/migrations/run_migration_v0.4.py && \

echo "✅ 权限设置完成" && \

echo "" && \

echo "========== 步骤2: 执行数据库迁移 ==========" && \

source venv/bin/activate 2>/dev/null || true && \

python3 database/migrations/run_migration_v0.4.py && \

echo "" && \

echo "========== 步骤3: 注册技能到数据库 ==========" && \

python3 注册技能到数据库.py && \

echo "" && \

echo "========== 步骤4: 验证技能注册 ==========" && \

python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')}")

if len(skills) == 4:

print("\n✅ 所有技能注册成功！")

else:

print(f"\n⚠️ 应该注册4个技能，但只找到 {len(skills)} 个")



asyncio.run(verify())

EOF
```

---

## 故障排查

### 问题1: 数据库迁移失败

**症状**: `run_migration_v0.4.py` 执行失败

**解决方案**:

```bash
# 检查数据库连接

cat .env | grep DATABASE_URL



# 手动执行SQL（如果Python脚本失败）

psql $DATABASE_URL -f database/migrations/add_skills_tables.sql
```

### 问题2: 技能注册失败

**症状**: `注册技能到数据库.py` 报错 "技能文件不存在"

**解决方案**:

```bash
# 检查技能目录

ls -la skills/

ls -la skills/*/SKILL.md



# 检查Python文件

ls -la skills/*.py
```

### 问题3: 技能数量不对

**症状**: 验证时只看到少于4个技能

**解决方案**:

```bash
# 重新注册所有技能

python3 注册技能到数据库.py



# 再次验证

python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"技能数量: {len(skills)}")

for skill in skills:

print(f" - {skill['skill_id']}")



asyncio.run(verify())

EOF
```

---

## 验证清单

- [ ] 文件权限设置完成（`*.sh` 可执行）

- [ ] 数据库迁移成功（`skills` 和 `skill_executions` 表已创建）

- [ ] 技能注册成功（4个技能都注册到数据库）

- [ ] 技能验证通过（`list_skills` 返回4个技能）

- [ ] 技能加载测试通过（每个技能都能加载）

- [ ] （可选）功能测试通过（场景识别和技能匹配）

---

**文档版本**: v0.4

**创建日期**: 2026-01-16
