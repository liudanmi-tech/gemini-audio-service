# ============================================
# 最终修复方案 - 添加缺失的代码
# ============================================

cd /home/admin/gemini-audio-service && python3 << 'FIX'
import shutil, time

backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"✅ 备份: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 找到需要插入代码的位置
# 在 tasks_storage[session_id] = task_data 之后，asyncio.create_task 之前插入

old_code = '''        tasks_storage[session_id] = task_data

        asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'''

new_code = '''        tasks_storage[session_id] = task_data

        # 读取文件内容并保存到临时文件（必须在异步任务之前读取，因为 UploadFile 只能读取一次）
        file_content = await file.read()
        file_filename = file.filename or "audio.m4a"
        file_ext = Path(file_filename).suffix.lower() if file_filename else '.m4a'
        
        # 创建临时文件保存文件内容
        import tempfile
        temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
        temp_file.write(file_content)
        temp_file.close()
        temp_file_path = temp_file.name
        
        # 异步分析（传递临时文件路径和文件名，确保所有参数都正确传递）
        logger.info(f"创建异步分析任务: session_id={session_id}, file_path={temp_file_path}, filename={file_filename}")
        asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'''

if old_code in content:
    content = content.replace(old_code, new_code)
    print("✅ 已添加文件读取和临时文件创建代码")
    
    with open('main.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    import py_compile
    py_compile.compile('main.py', doraise=True)
    print("✅ 修复完成，需要重启服务")
else:
    print("⚠️  未找到预期的代码模式，可能需要手动检查")
    # 尝试另一种模式
    if 'tasks_storage[session_id] = task_data' in content and 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))' in content:
        # 找到 tasks_storage 的位置
        storage_pos = content.find('tasks_storage[session_id] = task_data')
        # 找到下一个 asyncio.create_task
        task_pos = content.find('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))', storage_pos)
        
        if task_pos > storage_pos:
            # 在这两行之间插入代码
            insert_code = '''
        
        # 读取文件内容并保存到临时文件（必须在异步任务之前读取，因为 UploadFile 只能读取一次）
        file_content = await file.read()
        file_filename = file.filename or "audio.m4a"
        file_ext = Path(file_filename).suffix.lower() if file_filename else '.m4a'
        
        # 创建临时文件保存文件内容
        import tempfile
        temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
        temp_file.write(file_content)
        temp_file.close()
        temp_file_path = temp_file.name
        
        # 异步分析（传递临时文件路径和文件名，确保所有参数都正确传递）
        logger.info(f"创建异步分析任务: session_id={session_id}, file_path={temp_file_path}, filename={file_filename}")
'''
            # 在 tasks_storage 之后插入
            insert_pos = storage_pos + len('tasks_storage[session_id] = task_data')
            content = content[:insert_pos] + insert_code + content[insert_pos:]
            
            with open('main.py', 'w', encoding='utf-8') as f:
                f.write(content)
            
            import py_compile
            py_compile.compile('main.py', doraise=True)
            print("✅ 修复完成（使用备用方法）")

print(f"备份文件: {backup}")
FIX

# 重启服务
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup ./venv/bin/python3 main.py > ~/gemini-service.log 2>&1 & sleep 3 && curl http://localhost:8001/health

