# 音频分析服务 v0.3 技术文档

**文档版本**: v0.3  
**创建日期**: 2026-01-16  
**最后更新**: 2026-01-16  
**状态**: ✅ 前后端已联通，功能正常，服务稳定运行  
**新增功能**: ✅ 用户认证系统、PostgreSQL数据库持久化、策略分析自动生成

---

## 📋 目录

1. [系统架构总览](#1-系统架构总览)
2. [技术栈选型](#2-技术栈选型)
3. [功能描述](#3-功能描述)
4. [技术实现方式](#4-技术实现方式)
5. [大模型调用协议](#5-大模型调用协议)
6. [API 接口文档](#6-api-接口文档)
7. [数据模型](#7-数据模型)
8. [交互链路](#8-交互链路)
9. [前端技术实现](#9-前端技术实现)
10. [后端技术实现](#10-后端技术实现)
11. [部署配置](#11-部署配置)
12. [关键问题解决方案](#12-关键问题解决方案)

---

## 1. 系统架构总览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    iOS 客户端 (SwiftUI)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  登录模块    │  │  录音模块    │  │  任务列表    │    │
│  │  ✅ 已实现   │  │  ✅ 已实现   │  │  ✅ 已实现   │    │
│  │  LoginView   │  │  AudioRecorder│  │  TaskList     │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  任务详情    │  │  策略分析    │  │  图片显示    │    │
│  │  ✅ 已实现   │  │  ✅ 已实现   │  │  ✅ 已实现   │    │
│  │  TaskDetail  │  │  Strategy    │  │  ImageLoader  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│         │                  │                  │            │
│         └──────────────────┼──────────────────┘            │
│                            │                                │
│                    NetworkManager                           │
│                    (Alamofire + Keychain)                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP (Alamofire)
                            │ BaseURL: http://47.79.254.213:8001/api/v1
                            │ Authorization: Bearer {JWT Token}
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              FastAPI 后端服务 (Python 3.12)                 │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Uvicorn ASGI Server                              │   │
│  │  Port: 8001                                       │   │
│  │  Host: 0.0.0.0                                    │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │  API Endpoints:                                   │   │
│  │  POST /api/v1/auth/send-code (发送验证码)        │   │
│  │  POST /api/v1/auth/login (登录)                  │   │
│  │  GET  /api/v1/auth/me (获取用户信息)             │   │
│  │  POST /api/v1/audio/upload (上传音频)           │   │
│  │  GET  /api/v1/tasks/sessions (任务列表)          │   │
│  │  GET  /api/v1/tasks/sessions/{id} (任务详情)     │   │
│  │  GET  /api/v1/tasks/sessions/{id}/status (状态)  │   │
│  │  POST /api/v1/tasks/sessions/{id}/strategies     │   │
│  │  GET  /api/v1/images/{session_id}/{index}       │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │  认证系统:                                        │   │
│  │  - JWT Token 生成和验证                           │   │
│  │  - 手机号+验证码登录                              │   │
│  │  - 用户数据隔离                                   │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │  数据存储:                                        │   │
│  │  - PostgreSQL (阿里云RDS)                        │   │
│  │  - SQLAlchemy Async ORM                          │   │
│  │  - 表: users, sessions, analysis_results,        │   │
│  │        strategy_analysis, verification_codes     │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │  图片生成与存储:                                  │   │
│  │  - Gemini Nano Banana: 图片生成                  │   │
│  │  - 阿里云 OSS: 图片存储                          │   │
│  │  - 路径: images/{user_id}/{session_id}/{index}.png│   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP (反向代理)
                            │ Proxy: http://47.79.254.213/secret-channel
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Nginx 反向代理服务器                            │
│  ┌────────────────────────────────────────────────────┐   │
│  │  服务器: 47.79.254.213 (阿里云新加坡)                │   │
│  │  路径: /secret-channel                              │   │
│  │  功能: 转发请求到 Google Gemini API                │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Google Gemini 3 Flash API                     │
│  ┌────────────────────────────────────────────────────┐   │
│  │  模型: gemini-3-flash-preview                      │   │
│  │  功能: 音频上传、转写、分析                        │   │
│  │  输出: 对话提取、情绪分析、风险识别                 │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS (google.genai SDK)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│          Google Gemini Nano Banana Image API              │
│  ┌────────────────────────────────────────────────────┐   │
│  │  模型: gemini-2.5-flash-image                      │   │
│  │  功能: 文本生成图片（火柴人动画）                    │   │
│  │  输出: PNG 图片 (1184x864, 4:3)                    │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 图片上传
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              阿里云 OSS (Object Storage Service)            │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Bucket: geminipicture2                            │   │
│  │  Endpoint: oss-cn-beijing.aliyuncs.com            │   │
│  │  路径: images/{user_id}/{session_id}/{index}.png  │   │
│  │  访问: 通过后端 API 代理访问（私有 bucket）         │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 数据库连接
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              阿里云 RDS (PostgreSQL)                        │
│  ┌────────────────────────────────────────────────────┐   │
│  │  数据库: PostgreSQL 14.19                         │   │
│  │  表: users, sessions, analysis_results,            │   │
│  │       strategy_analysis, verification_codes        │   │
│  │  连接: asyncpg (异步驱动)                          │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 数据存储

- **后端数据库**: PostgreSQL (阿里云RDS)
  - `users`: 用户表
  - `sessions`: 任务/会话表
  - `analysis_results`: 分析结果表
  - `strategy_analysis`: 策略分析表
  - `verification_codes`: 验证码表
- **前端**: 
  - Keychain: JWT Token 和 User ID 存储
  - 本地状态管理（`@Published` 属性）
- **图片存储**: 阿里云 OSS（`images/{user_id}/{session_id}/{image_index}.png`）
- **日志**: `~/gemini-audio-service.log`

---

## 2. 技术栈选型

### 2.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.12 | 运行环境 |
| FastAPI | 0.104.1+ | Web 框架，异步支持 |
| Uvicorn | 0.24.0+ | ASGI 服务器 |
| PostgreSQL | 14.19 | 关系型数据库 |
| SQLAlchemy | 2.0.0+ | 异步 ORM |
| asyncpg | 0.29.0+ | PostgreSQL 异步驱动 |
| python-jose | 3.3.0+ | JWT Token 处理 |
| google-generativeai | 0.8.6 | Gemini API SDK (文本分析) |
| google-genai | 0.2.0+ | Gemini API SDK (图片生成) |
| oss2 | 2.18.0+ | 阿里云 OSS SDK |
| Pydantic | 2.9.0+ | 数据验证和序列化 |
| python-dotenv | 1.0.0+ | 环境变量管理 |

### 2.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Swift | 5.9+ | 编程语言 |
| SwiftUI | - | UI 框架 |
| iOS | 16.0+ | 最低支持版本 |
| Alamofire | 5.8.0+ | 网络请求库 |
| AVFoundation | - | 音频录制框架 |
| Combine | - | 响应式编程框架 |
| Keychain | - | 安全存储（JWT Token） |

### 2.3 基础设施

| 组件 | 配置 | 用途 |
|------|------|------|
| 服务器 | 阿里云新加坡 | 后端服务部署 |
| Nginx | - | 反向代理，转发 Gemini API |
| 虚拟环境 | Python venv | 依赖隔离 |
| 阿里云 OSS | oss-cn-beijing | 图片存储服务 |
| 阿里云 RDS | PostgreSQL 14.19 | 数据库服务 |

---

## 3. 功能描述

### 3.1 核心功能

#### 3.1.1 用户认证系统（新增）
- **功能**: 手机号+验证码登录，JWT Token 认证
- **实现**: 
  - 发送验证码接口（开发阶段返回固定验证码 123456）
  - 登录接口（验证码验证，自动创建用户）
  - JWT Token 生成和验证
  - 用户信息查询接口
- **特性**:
  - 手机号格式验证
  - 验证码有效期（10分钟）
  - Token 有效期（24小时，可配置）
  - 用户数据隔离（每个用户只能访问自己的数据）

#### 3.1.2 音频录制
- **功能**: 在 iOS 设备上录制音频
- **格式**: M4A
- **实现**: `AudioRecorderService` 使用 AVFoundation
- **特性**:
  - 实时显示录制时长
  - 自动保存到 Documents 目录

#### 3.1.3 音频上传
- **功能**: 上传录制的音频文件到服务器
- **实现**: `NetworkManager.uploadAudio()` 使用 Alamofire multipart
- **特性**:
  - 显示上传进度
  - 错误处理和重试
  - JWT Token 自动添加到请求头
  - 详细日志记录

#### 3.1.4 音频分析
- **功能**: 使用 Gemini 3 Flash 模型分析音频
- **实现**: 异步后台任务 `analyze_audio_async()`
- **分析内容**:
  - 说话人识别和数量统计
  - 对话转录（按时间顺序）
  - 情绪分数（0-100）
  - 风险点识别
  - 对话总结
  - 统计信息（叹气次数、笑声次数）
- **数据存储**: 分析结果保存到 PostgreSQL 数据库

#### 3.1.5 任务管理
- **功能**: 管理录音和分析任务
- **实现**: PostgreSQL 数据库 + RESTful API
- **特性**:
  - 任务列表（分页、过滤、排序）
  - 任务详情（包含完整分析结果）
  - 任务状态查询
  - 用户数据隔离（仅显示当前用户的任务）
  - 即时显示优化（详情页先显示基本信息，后台加载完整数据）

#### 3.1.6 策略分析（Call #2）
- **功能**: 基于对话转录生成应对策略
- **实现**: 
  - 自动异步生成（音频分析完成后自动触发）
  - 数据库缓存（优先从数据库读取已生成的结果）
  - 手动触发接口（`POST /api/v1/tasks/sessions/{id}/strategies`）
- **输出**:
  - 视觉化数据（2-5个关键时刻，火柴人描述、内心OS）
  - 3 种应对策略（自主研判，非固定分类）
  - Markdown 格式的详细建议
  - 图片生成（Gemini Nano Banana，自动上传到 OSS）

### 3.2 辅助功能

#### 3.2.1 图片生成与存储
- **功能**: 为关键时刻生成火柴人图片
- **实现**: 
  - Gemini Nano Banana 模型生成图片
  - 自动上传到阿里云 OSS
  - 路径格式: `images/{user_id}/{session_id}/{image_index}.png`
  - 降级机制: OSS 失败时返回 Base64
- **特性**:
  - 自动重试机制（配额错误处理）
  - 图片访问接口（支持私有 OSS bucket）

#### 3.2.2 健康检查
- **端点**: `GET /health`
- **用途**: 服务状态监控

#### 3.2.3 日志系统
- **后端**: Python logging，输出到 `~/gemini-audio-service.log`
- **前端**: print 语句，输出到 Xcode 控制台
- **级别**: DEBUG（开发环境）

---

## 4. 技术实现方式

### 4.1 服务器端实现

#### 4.1.1 FastAPI 应用架构
- **框架**: FastAPI (Python 3.12)
- **服务器**: Uvicorn ASGI Server
- **端口**: 8001
- **主机**: 0.0.0.0（监听所有网络接口）

#### 4.1.2 数据库连接
- **数据库**: PostgreSQL (阿里云RDS)
- **连接方式**: SQLAlchemy Async Engine
- **驱动**: asyncpg
- **连接池**: 
  - `pool_size`: 10
  - `max_overflow`: 20
  - `pool_pre_ping`: True（连接前检查有效性）
- **会话管理**: AsyncSessionLocal（异步会话工厂）

#### 4.1.3 认证系统实现
- **JWT Token**:
  - 算法: HS256
  - 有效期: 24小时（可配置）
  - 密钥: 从环境变量 `JWT_SECRET_KEY` 读取
  - 生成: `create_access_token(user_id)`
  - 验证: `get_current_user()` / `get_current_user_id()`
- **验证码系统**:
  - 生成: 6位数字（开发阶段固定为 123456）
  - 有效期: 10分钟
  - 存储: PostgreSQL `verification_codes` 表
  - 验证: `verify_code(phone, code)`

#### 4.1.4 异步任务处理
- **音频分析**: `analyze_audio_async()`
  - 使用 `asyncio.create_task()` 创建后台任务
  - 创建独立的数据库会话（避免会话关闭问题）
  - 上传文件到 Gemini
  - 等待文件处理完成
  - 调用模型分析
  - 保存结果到数据库
  - 自动触发策略分析生成
- **策略分析**: `generate_strategies_async()`
  - 在音频分析完成后自动触发
  - 异步生成，不阻塞主流程
  - 保存到数据库供后续查询

#### 4.1.5 图片生成与存储
- **生成模型**: Gemini Nano Banana (`gemini-2.5-flash-image`)
- **配置**:
  - 宽高比: 4:3 (1184x864)
  - 格式: PNG
- **存储**:
  - 服务: 阿里云 OSS
  - 路径: `images/{user_id}/{session_id}/{image_index}.png`
  - 访问: 通过后端 API 代理（私有 bucket）
- **重试机制**:
  - 最大重试次数: 3次
  - 配额错误（429）: 等待15秒后重试
  - 其他错误: 指数退避（5秒、10秒、15秒）
- **降级机制**: OSS 失败时返回 Base64 编码

### 4.2 客户端实现

#### 4.2.1 认证流程
- **登录页面**: `LoginView`
  - 手机号输入（11位数字）
  - 验证码输入（6位数字）
  - 发送验证码按钮（带倒计时）
  - 登录按钮
- **Token 存储**: `KeychainManager`
  - 使用 iOS Keychain 安全存储
  - 存储 JWT Token 和 User ID
  - 自动读取和删除
- **状态管理**: `AuthManager`
  - `@Published var isLoggedIn: Bool`
  - `@Published var currentUser: UserInfo?`
  - 全局单例，应用启动时检查登录状态

#### 4.2.2 网络请求
- **基础配置**: `NetworkManager`
  - BaseURL: `http://47.79.254.213:8001/api/v1`
  - 自动添加 JWT Token 到请求头
  - 超时设置:
    - 任务列表/详情: 120秒
    - 音频上传/策略分析: 180秒
- **请求拦截**: 
  - 从 Keychain 读取 Token
  - 添加到 `Authorization: Bearer {token}` 头
  - 错误处理和重试

#### 4.2.3 任务详情页优化
- **即时显示**: 
  - 进入详情页时，先显示基本信息（从 TaskItem 创建临时 TaskDetailResponse）
  - 后台异步加载完整数据
  - 避免长时间显示加载状态
- **加载状态管理**:
  - `isLoading` 仅在无数据时显示
  - 已有临时数据时不显示加载动画
  - 错误信息友好提示

### 4.3 数据存储实现

#### 4.3.1 数据库表结构
- **users**: 用户表
  - `id`: UUID (主键)
  - `phone`: String(11) (唯一索引)
  - `created_at`: DateTime (时区感知)
  - `updated_at`: DateTime (时区感知)
  - `last_login_at`: DateTime (时区感知)
  - `is_active`: Boolean
- **sessions**: 任务/会话表
  - `id`: UUID (主键)
  - `user_id`: UUID (外键，索引)
  - `title`: String(255)
  - `start_time`: DateTime (时区感知)
  - `end_time`: DateTime (时区感知)
  - `duration`: Integer (秒)
  - `status`: String(50) (analyzing/archived/failed)
  - `emotion_score`: Integer
  - `speaker_count`: Integer
  - `tags`: ARRAY(String)
  - `created_at`: DateTime (时区感知，索引)
  - `updated_at`: DateTime (时区感知)
- **analysis_results**: 分析结果表
  - `id`: UUID (主键)
  - `session_id`: UUID (外键，唯一索引)
  - `dialogues`: JSONB (对话数组)
  - `risks`: ARRAY(String) (风险点数组)
  - `summary`: Text
  - `mood_score`: Integer
  - `stats`: JSONB (统计数据)
  - `transcript`: Text (JSON字符串)
  - `call1_result`: JSONB (Call #1 完整结果)
  - `created_at`: DateTime (时区感知)
  - `updated_at`: DateTime (时区感知)
- **strategy_analysis**: 策略分析表
  - `id`: UUID (主键)
  - `session_id`: UUID (外键，唯一索引)
  - `visual_data`: JSONB (VisualData数组)
  - `strategies`: JSONB (StrategyItem数组)
  - `created_at`: DateTime (时区感知)
  - `updated_at`: DateTime (时区感知)
- **verification_codes**: 验证码表
  - `id`: UUID (主键)
  - `phone`: String(11) (索引)
  - `code`: String(6)
  - `expires_at`: DateTime (时区感知，索引)
  - `used`: Boolean
  - `created_at`: DateTime (时区感知)

#### 4.3.2 OSS 存储结构
- **路径格式**: `images/{user_id}/{session_id}/{image_index}.png`
- **访问方式**: 通过后端 API (`GET /api/v1/images/{session_id}/{image_index}`)
- **权限**: 私有 bucket，需要 JWT 认证

### 4.4 大模型调用方式

#### 4.4.1 Gemini API 配置
- **API Key**: 从环境变量 `GEMINI_API_KEY` 读取
- **代理模式**: 
  - 启用: `USE_PROXY=true`
  - 代理URL: `PROXY_URL=http://47.79.254.213/secret-channel`
  - URL 重写: 自动将 `generativelanguage.googleapis.com` 替换为代理服务器
- **传输模式**: REST (google-generativeai SDK)

#### 4.4.2 音频分析调用流程
1. 上传文件到 Gemini (`genai.upload_file()`)
2. 等待文件状态变为 ACTIVE (`wait_for_file_active()`)
3. 调用模型分析 (`model.generate_content([file, prompt])`)
4. 解析 JSON 响应 (`parse_gemini_response()`)
5. 保存结果到数据库

#### 4.4.3 策略分析调用流程
1. 从数据库读取 transcript
2. 构建提示词（包含 transcript JSON）
3. 调用模型分析 (`model.generate_content(prompt)`)
4. 解析响应，提取 visual 和 strategies
5. 为每个关键时刻生成图片
6. 保存到数据库

#### 4.4.4 图片生成调用流程
1. 使用 `google-genai` SDK (`genai_new.Client()`)
2. 配置图片参数 (`GenerateContentConfig`, `ImageConfig`)
3. 调用图片生成 (`client.models.generate_content()`)
4. 获取图片字节流
5. 上传到 OSS 或返回 Base64

---

## 5. 大模型调用协议

### 5.1 Call #1 - 音频分析

#### 5.1.1 模型信息
- **模型名称**: `gemini-3-flash-preview`
- **SDK**: `google-generativeai`
- **用途**: 音频上传、转写、分析

#### 5.1.2 输入参数
- **文件**: 音频文件（通过 `genai.upload_file()` 上传）
  - 支持格式: M4A, MP3, WAV
  - 文件状态: 必须为 ACTIVE
- **提示词**: 文本提示词（见下方）

#### 5.1.3 提示词内容
```
角色: 你是一个专业的语音分析与行为观察专家。

任务: 请深入解析上传的音频文件，并输出严格格式化的 JSON 数据。

参数定义:
1. **mood_score**: (Integer, 0-100) 根据语调波动、语速变化及语义冲突程度对对话氛围进行建模评分。分数越高表示氛围越轻松愉快。
2. **sigh_count**: (Integer) 识别并统计 Speaker_1 (用户) 在音频中产生的长呼气或叹气次数。
3. **laugh_count**: (Integer) 识别并统计全场出现的所有类型笑声。
4. **summary**: (String) 对对话内容、核心矛盾及情绪转折点进行精炼总结（100-200字）。
5. **transcript**: (Array) 按时间顺序包含所有对话，每个对话包含：
   - speaker: 说话人标识（如：Speaker_0, Speaker_1，其中Speaker_1为用户）
   - text: 对话内容（完整原话）
   - timestamp: 时间戳（格式："MM:SS"）
   - is_me: (Boolean) 是否为用户说的（Speaker_1为true，其他为false）
6. **risks**: (Array) 关键风险点列表

返回格式必须严格遵循以下结构：
{
  "mood_score": 75,
  "sigh_count": 2,
  "laugh_count": 5,
  "summary": "对话气氛整体缓和...",
  "transcript": [
    {
      "speaker": "Speaker_0",
      "text": "具体说话内容",
      "timestamp": "00:01",
      "is_me": false
    },
    {
      "speaker": "Speaker_1",
      "text": "具体说话内容",
      "timestamp": "00:05",
      "is_me": true
    }
  ],
  "risks": ["风险点1", "风险点2", ...]
}
```

#### 5.1.4 输出格式
```json
{
  "mood_score": 75,
  "sigh_count": 2,
  "laugh_count": 5,
  "summary": "对话气氛整体缓和，但在周末加班的截止日期问题上存在明显的隐形拉锯，用户试图防御个人时间。",
  "transcript": [
    {
      "speaker": "Speaker_0",
      "text": "已经两点半了。",
      "timestamp": "00:00",
      "is_me": false
    },
    {
      "speaker": "Speaker_1",
      "text": "噢，好吧。你这次咋样？看看。",
      "timestamp": "00:01",
      "is_me": true
    }
  ],
  "risks": ["风险点1", "风险点2"]
}
```

#### 5.1.5 数据转换
- **后端处理**: 
  - 将 `transcript` 转换为 `DialogueItem` 列表
  - 计算 `speaker_count`（去重后的说话人数量）
  - 保存到 `AnalysisResult` 表

### 5.2 Call #2 - 策略分析

#### 5.2.1 模型信息
- **模型名称**: `gemini-3-flash-preview`
- **SDK**: `google-generativeai`
- **用途**: 基于对话转录生成应对策略和视觉化方案

#### 5.2.2 输入参数
- **transcript**: JSON 格式的对话转录数组（从 Call #1 获取）
- **提示词**: 文本提示词（见下方）

#### 5.2.3 提示词内容
```
角色: 你是一位精通博弈论、职场心理学与视觉修辞的深度沟通专家。

任务: 基于 Call #1 提供的对话转录音本，深入拆解双方的权力动态，并提供具备实战价值的应对策略与视觉化方案。

核心指令:
1. **博弈剖析**: 洞察对话文本背后的「权力位阶」与「隐性诉求」。
2. **自主策略研判**: **请勿使用固定分类**。请根据具体场景（如：需求加塞、情感勒索、沟通僵局），自主研判 3 种最具破局可能性的应对路径。每种策略需给出独特的 `label`（如：借力打力、柔性边界、认知对齐）。
3. **视觉建模**: 识别对话中的关键时刻（如情绪转折、冲突爆发、重要决策等），为每个关键时刻设计详细的火柴人绘图描述词。
   - **关键时刻识别**: 从对话转录中识别 2-5 个关键时刻
   - **构图规则**: 米色背景，极简火柴人线稿，左侧为用户，右侧为对方
   - **详细要求**: 每个 `image_prompt` 必须包含：
     * 说话人位置和身份标注（明确标注左侧是用户，右侧是对方）
     * 说话人情绪表现（通过肢体语言、表情、姿态展现）
     * 潜台词暗示（通过细微动作体现）
     * 当时的情景或心理状态描述

参数定义:
- **strategies**: 数组，每个策略包含 `id`, `label`, `emoji`, `title`, `content` (Markdown格式)
- **visual**: 数组，包含 2-5 个关键时刻的视觉数据。每个元素包含：
  * `transcript_index`: 关联的 transcript 数组索引
  * `speaker`: 说话人标识
  * `image_prompt`: 详细的火柴人绘图描述词
  * `emotion`: 说话人情绪
  * `subtext`: 潜台词
  * `context`: 当时的情景或心理状态
  * `my_inner`: 我的内心OS
  * `other_inner`: 对方的内心OS

返回格式:
{
  "visual": [
    {
      "transcript_index": 3,
      "speaker": "Speaker_1",
      "image_prompt": "米色背景，极简火柴人线稿。左侧为用户（Speaker_1），标注'我'，身体微微后倾，双手交叉胸前，表情略显紧张...",
      "emotion": "紧张、防御",
      "subtext": "感到被冒犯但试图保持礼貌",
      "context": "对方提出不合理要求，用户内心抗拒但表面配合",
      "my_inner": "感到被冒犯但保持礼貌",
      "other_inner": "试探对方的弹性"
    }
  ],
  "strategies": [
    {
      "id": "s1",
      "label": "借力打力",
      "emoji": "⚔️",
      "title": "策略标题",
      "content": "### 建议话术\n1. **心理逻辑**: ...\n2. **推荐话术**: '...'"
    }
  ]
}

对话转录:
{transcript_json}
```

#### 5.2.4 输出格式
```json
{
  "visual": [
    {
      "transcript_index": 3,
      "speaker": "Speaker_1",
      "image_prompt": "米色背景，极简火柴人线稿。左侧为用户（Speaker_1），标注'我'，身体微微后倾，双手交叉胸前，表情略显紧张，眼神看向右侧但不敢直视，手指在胸前轻敲，显示出内心的不安和防御。右侧为对方（Speaker_0），标注'对方'，身体前倾，右手指向左侧，表情严肃，显示出强势和施压的姿态。整体场景：办公室环境，双方隔着办公桌对峙，氛围紧张。",
      "emotion": "紧张、防御",
      "subtext": "感到被冒犯但试图保持礼貌",
      "context": "对方提出不合理要求，用户内心抗拒但表面配合，处于被动防御状态",
      "my_inner": "感到被冒犯但保持礼貌",
      "other_inner": "试探对方的弹性"
    }
  ],
  "strategies": [
    {
      "id": "s1",
      "label": "借力打力",
      "emoji": "⚔️",
      "title": "策略标题",
      "content": "### 建议话术\n1. **心理逻辑**: ...\n2. **推荐话术**: '...'"
    }
  ]
}
```

#### 5.2.5 后续处理
- **图片生成**: 为每个 `visual` 项生成图片（见 5.3 节）
- **数据保存**: 保存到 `StrategyAnalysis` 表

### 5.3 图片生成

#### 5.3.1 模型信息
- **模型名称**: `gemini-2.5-flash-image`
- **SDK**: `google-genai` (新 SDK)
- **用途**: 文本生成图片（火柴人动画）

#### 5.3.2 输入参数
- **image_prompt**: 文本描述（从 Call #2 的 `visual[].image_prompt` 获取）
- **配置参数**:
  - `aspect_ratio`: "4:3" (1184x864)
  - `image_config`: `ImageConfig(aspect_ratio="4:3")`

#### 5.3.3 调用方式
```python
client = genai_new.Client(api_key=GEMINI_API_KEY)
config = genai_types.GenerateContentConfig(
    image_config=genai_types.ImageConfig(
        aspect_ratio="4:3"
    )
)
response = client.models.generate_content(
    model="gemini-2.5-flash-image",
    contents=image_prompt,
    config=config
)
image_bytes = response.candidates[0].content.parts[0].inline_data.data
```

#### 5.3.4 输出格式
- **成功**: PNG 图片字节流
- **大小**: 约 1184x864 像素
- **格式**: PNG

#### 5.3.5 存储方式
1. **优先**: 上传到 OSS，返回 URL
   - 路径: `images/{user_id}/{session_id}/{image_index}.png`
   - URL: `https://{bucket}.{endpoint}/{path}` 或 CDN URL
2. **降级**: OSS 失败时返回 Base64 编码
   - 格式: `data:image/png;base64,{base64_string}`

#### 5.3.6 错误处理
- **429 配额错误**: 
  - 等待 15 秒后重试
  - 最多重试 3 次
- **其他错误**: 
  - 指数退避（5秒、10秒、15秒）
  - 最多重试 3 次
- **最终失败**: 返回 None，保留 visual_data（不含图片）

---

## 6. API 接口文档

### 6.1 通用响应格式

所有 API 接口使用统一的响应格式：

```json
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "timestamp": "2026-01-16T11:31:47.923Z"
}
```

**字段说明**:
- `code`: 状态码，200 表示成功
- `message`: 响应消息
- `data`: 响应数据（类型根据接口不同）
- `timestamp`: ISO 8601 格式的时间戳

### 6.2 认证接口

#### 6.2.1 发送验证码

**接口**: `POST /api/v1/auth/send-code`

**描述**: 向指定手机号发送验证码（开发阶段返回固定验证码 123456）

**请求**:
```json
{
  "phone": "13800138000"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "验证码已发送",
  "data": {
    "phone": "13800138000",
    "code": "123456"
  }
}
```

#### 6.2.2 登录

**接口**: `POST /api/v1/auth/login`

**描述**: 使用手机号和验证码登录，返回 JWT Token

**请求**:
```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": "3a12d3f8-52be-493c-b4de-6a6b51ee78fa",
    "expires_in": 86400
  }
}
```

#### 6.2.3 获取当前用户信息

**接口**: `GET /api/v1/auth/me`

**描述**: 获取当前登录用户的信息（需要 JWT 认证）

**请求头**: `Authorization: Bearer {token}`

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "user_id": "3a12d3f8-52be-493c-b4de-6a6b51ee78fa",
    "phone": "13800138000",
    "created_at": "2026-01-15T15:13:21.846416+00:00",
    "last_login_at": "2026-01-16T11:20:43.416185+00:00"
  }
}
```

### 6.3 任务接口

#### 6.3.1 上传音频

**接口**: `POST /api/v1/audio/upload`

**描述**: 上传音频文件并开始异步分析（需要 JWT 认证）

**请求**: `multipart/form-data`
- `file`: 音频文件（M4A/MP3/WAV）
- `title`: 任务标题（可选）

**请求头**: `Authorization: Bearer {token}`

**响应**:
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "session_id": "d12f253d-608e-442d-833b-92e874f1efc5",
    "user_id": "067aecd8-3c29-473d-964b-77a524014283",
    "audio_id": "d12f253d-608e-442d-833b-92e874f1efc5",
    "title": "录音 11:13",
    "status": "analyzing",
    "estimated_duration": 300,
    "created_at": "2026-01-16T11:13:54.340664"
  }
}
```

#### 6.3.2 获取任务列表

**接口**: `GET /api/v1/tasks/sessions`

**描述**: 获取任务列表，支持分页和过滤（需要 JWT 认证）

**请求参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20，最大100）
- `date`: 日期过滤（YYYY-MM-DD）
- `status`: 状态过滤（analyzing/archived/failed）

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sessions": [...],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  }
}
```

#### 6.3.3 获取任务详情

**接口**: `GET /api/v1/tasks/sessions/{session_id}`

**描述**: 获取任务的详细信息（需要 JWT 认证）

**响应**: 包含任务基本信息、对话列表、风险点、总结等

#### 6.3.4 查询任务状态

**接口**: `GET /api/v1/tasks/sessions/{session_id}/status`

**描述**: 查询任务的分析状态和进度

**响应**:
```json
{
  "code": 200,
  "data": {
    "session_id": "...",
    "status": "archived",
    "progress": 1.0,
    "estimated_time_remaining": 0
  }
}
```

#### 6.3.5 生成策略分析

**接口**: `POST /api/v1/tasks/sessions/{session_id}/strategies`

**描述**: 生成策略分析（优先从数据库读取，不存在则生成）

**响应**: 包含 visual 数组和 strategies 数组

#### 6.3.6 获取图片

**接口**: `GET /api/v1/images/{session_id}/{image_index}`

**描述**: 从 OSS 获取图片（支持私有 bucket）

**响应**: PNG 图片数据

---

## 7. 数据模型

### 7.1 数据库表结构

#### 7.1.1 users 表
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    phone VARCHAR(11) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE
);
CREATE INDEX idx_users_phone ON users(phone);
```

#### 7.1.2 sessions 表
```sql
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255),
    start_time TIMESTAMP WITH TIME ZONE,
    end_time TIMESTAMP WITH TIME ZONE,
    duration INTEGER,
    status VARCHAR(50),
    emotion_score INTEGER,
    speaker_count INTEGER,
    tags TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_sessions_created_at ON sessions(created_at);
```

#### 7.1.3 analysis_results 表
```sql
CREATE TABLE analysis_results (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_id UUID UNIQUE NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    dialogues JSONB NOT NULL,
    risks TEXT[],
    summary TEXT,
    mood_score INTEGER,
    stats JSONB,
    transcript TEXT,
    call1_result JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_analysis_results_session_id ON analysis_results(session_id);
```

#### 7.1.4 strategy_analysis 表
```sql
CREATE TABLE strategy_analysis (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_id UUID UNIQUE NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    visual_data JSONB NOT NULL,
    strategies JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_strategy_analysis_session_id ON strategy_analysis(session_id);
```

#### 7.1.5 verification_codes 表
```sql
CREATE TABLE verification_codes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    phone VARCHAR(11) NOT NULL,
    code VARCHAR(6) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_verification_codes_phone ON verification_codes(phone);
CREATE INDEX idx_verification_codes_expires_at ON verification_codes(expires_at);
```

### 7.2 后端数据模型（Pydantic）

#### 7.2.1 APIResponse
```python
class APIResponse(BaseModel):
    code: int
    message: str
    data: Optional[dict] = None
    timestamp: Optional[str] = None
```

#### 7.2.2 Call1Response
```python
class Call1Response(BaseModel):
    mood_score: int  # 0-100
    stats: dict  # {"sigh": int, "laugh": int}
    summary: str
    transcript: List[TranscriptItem]
```

#### 7.2.3 Call2Response
```python
class Call2Response(BaseModel):
    visual: List[VisualData]  # 视觉数据数组
    strategies: List[StrategyItem]  # 策略列表
```

### 7.3 前端数据模型（Swift）

#### 7.3.1 Task
```swift
struct Task: Codable, Identifiable {
    let id: String  // session_id
    let title: String
    let startTime: Date
    let endTime: Date?
    let duration: Int
    let tags: [String]
    let status: TaskStatus
    let emotionScore: Int?
    let speakerCount: Int?
}
```

#### 7.3.2 TaskDetailResponse
```swift
struct TaskDetailResponse: Codable {
    let sessionId: String
    let title: String
    let startTime: Date
    let endTime: Date?
    let duration: Int
    let tags: [String]
    let status: String
    let emotionScore: Int?
    let speakerCount: Int?
    let dialogues: [DialogueItem]
    let risks: [String]
    let summary: String?
}
```

#### 7.3.3 StrategyAnalysisResponse
```swift
struct StrategyAnalysisResponse: Codable {
    let visual: [VisualData]
    let strategies: [StrategyItem]
}
```

---

## 8. 交互链路

### 8.1 用户登录流程

```
iOS客户端 → POST /api/v1/auth/send-code (发送验证码)
         → POST /api/v1/auth/login (登录，获取Token)
         → 保存Token到Keychain
         → 更新AuthManager状态
```

### 8.2 音频上传与分析流程

```
iOS客户端 → POST /api/v1/audio/upload (上传音频，立即返回)
         → 后台异步: analyze_audio_async()
         → 上传文件到Gemini
         → 调用模型分析
         → 保存结果到数据库
         → 自动触发策略分析生成
         → iOS客户端轮询状态
```

### 8.3 任务详情加载流程

```
iOS客户端 → 进入详情页
         → 立即显示基本信息（从TaskItem创建临时数据）
         → 后台: GET /api/v1/tasks/sessions/{id}
         → 更新完整数据
         → 显示对话列表、总结等
```

---

## 9. 前端技术实现

### 9.1 认证模块

- **LoginView**: 登录页面UI
- **AuthViewModel**: 登录业务逻辑
- **AuthManager**: 全局认证状态管理
- **KeychainManager**: Token安全存储

### 9.2 网络模块

- **NetworkManager**: 统一网络请求管理
- **自动添加JWT Token**: 从Keychain读取并添加到请求头
- **超时配置**: 不同接口设置不同超时时间

### 9.3 任务模块

- **TaskListView**: 任务列表UI
- **TaskDetailView**: 任务详情UI（即时显示优化）
- **StrategyAnalysisView**: 策略分析UI（包含图片显示）

---

## 10. 后端技术实现

### 10.1 认证系统

- **JWT处理**: `auth/jwt_handler.py`
- **验证码管理**: `auth/verification.py`
- **认证接口**: `api/auth.py`

### 10.2 数据库操作

- **连接管理**: `database/connection.py`
- **模型定义**: `database/models.py`
- **异步会话**: 使用 `AsyncSessionLocal`

### 10.3 异步任务

- **音频分析**: `analyze_audio_async()`
- **策略生成**: `generate_strategies_async()`
- **独立会话**: 每个异步任务创建新的数据库会话

---

## 11. 部署配置

### 11.1 环境变量

```env
# Gemini API
GEMINI_API_KEY=your_api_key_here
PROXY_URL=http://47.79.254.213/secret-channel
USE_PROXY=true

# 数据库
DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname

# JWT
JWT_SECRET_KEY=your-secret-key-here
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# OSS
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_ENDPOINT=oss-cn-beijing.aliyuncs.com
OSS_BUCKET_NAME=geminipicture2
OSS_CDN_DOMAIN=可选CDN域名

# 验证码（开发阶段）
VERIFICATION_CODE_MOCK=true
```

### 11.2 启动服务

```bash
cd ~/gemini-audio-service
source venv/bin/activate
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
```

---

## 12. 关键问题解决方案

### 12.1 数据库会话管理

**问题**: 异步任务中使用主请求的数据库会话会失败

**解决方案**: 每个异步任务创建独立的数据库会话
```python
async with AsyncSessionLocal() as db:
    # 异步任务代码
```

### 12.2 策略分析自动生成

**问题**: 策略分析生成耗时，按需生成导致详情页加载慢

**解决方案**: 
- 音频分析完成后自动异步生成策略分析
- 策略分析接口优先从数据库读取已生成的结果
- 详情页即时显示基本信息，后台加载完整数据

### 12.3 用户数据隔离

**问题**: 确保用户只能访问自己的数据

**解决方案**: 
- 所有任务相关接口使用 `get_current_user_id()` 依赖
- 数据库查询时添加 `user_id` 过滤条件

### 12.4 图片访问安全

**问题**: OSS bucket 设置为私有，不能直接访问

**解决方案**: 
- 通过后端 API 代理访问图片
- 验证任务属于当前用户
- 从 OSS 获取图片并返回

---

## 附录

### A. 版本历史

- **v0.1** (2026-01-09): 初始版本，基础功能实现
- **v0.2** (2026-01-14): 图片生成与显示（Gemini Nano Banana + OSS）
- **v0.3** (2026-01-16): 用户认证系统、PostgreSQL数据库持久化、策略分析自动生成

### B. 待实现功能

- [ ] 实时分析进度推送（WebSocket）
- [ ] 音频文件存储（OSS/S3）
- [ ] 任务搜索功能
- [ ] 批量操作
- [ ] 导出功能
- [ ] 用户头像和昵称

### C. 性能优化建议

- [ ] 实现 Redis 缓存
- [ ] 数据库索引优化
- [ ] CDN 加速图片访问
- [ ] 音频文件压缩

### D. 安全建议

- [ ] HTTPS 支持
- [ ] API 限流
- [ ] 文件大小限制
- [ ] 验证码发送频率限制

---

**文档结束**
