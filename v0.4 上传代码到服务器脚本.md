#!/bin/bash

# v0.4 上传代码到服务器脚本

# 使用方法: 在本地执行此脚本

set -e

# 配置

SERVER_USER="admin"

SERVER_IP="47.79.254.213"

SERVER_PATH="~/gemini-audio-service"

LOCAL_PATH="$(pwd)"

# 颜色输出

GREEN='\033[0;32m'

YELLOW='\033[1;33m'

RED='\033[0;31m'

NC='\033[0m'

echo -e "${GREEN}========== v0.4 代码上传到服务器 ==========${NC}"

echo ""

echo "服务器: $SERVER_USER@$SERVER_IP"

echo "目标路径: $SERVER_PATH"

echo "本地路径: $LOCAL_PATH"

echo ""

# 检查SSH密钥配置

echo -e "${YELLOW}检查SSH密钥配置...${NC}"

if ssh -o BatchMode=yes -o ConnectTimeout=5 $SERVER_USER@$SERVER_IP "echo '测试连接'" 2>/dev/null; then

echo -e "${GREEN}✅ SSH免密登录已配置${NC}"

USE_SSH_KEY=true

else

echo -e "${YELLOW}⚠️ SSH免密登录未配置，将使用密码登录${NC}"

USE_SSH_KEY=false

fi

echo ""

# 需要上传的文件和目录列表

FILES_TO_UPLOAD=(

# skills目录（整个目录，包含所有技能）

"skills/"

# 数据库迁移文件

"database/migrations/run_migration_v0.4.py"

"database/migrations/add_skills_tables.sql"

# 数据库模型

"database/models.py"

# API文件

"api/skills.py"

# 主程序

"main.py"

# Python脚本

"注册技能到数据库.py"

"测试v0.4功能.py"

# Shell脚本

"测试v0.4架构.sh"

"服务器执行v0.4部署.sh"

"在服务器上执行.sh"

"v0.4自动化部署脚本.sh"

"验证部署.sh"

)

echo -e "${YELLOW}准备上传以下文件和目录:${NC}"

for item in "${FILES_TO_UPLOAD[@]}"; do

if [ -e "$LOCAL_PATH/$item" ]; then

echo " ✅ $item"

else

echo -e " ${RED}❌ $item (不存在)${NC}"

fi

done

echo ""

# 确认上传

read -p "是否继续上传? (y/n) " -n 1 -r

echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then

echo "取消上传"

exit 0

fi

# 上传函数

upload_file() {

local source_file="$1"

local target_file="$2"

if [ -d "$source_file" ]; then

# 目录上传

echo "上传目录: $source_file -> $target_file"

if [ "$USE_SSH_KEY" = true ]; then

scp -r "$source_file" "$SERVER_USER@$SERVER_IP:$target_file" 2>&1

else

echo "请输入服务器密码:"

scp -r "$source_file" "$SERVER_USER@$SERVER_IP:$target_file" 2>&1

fi

else

# 文件上传

echo "上传文件: $source_file -> $target_file"

if [ "$USE_SSH_KEY" = true ]; then

scp "$source_file" "$SERVER_USER@$SERVER_IP:$target_file" 2>&1

else

echo "请输入服务器密码:"

scp "$source_file" "$SERVER_USER@$SERVER_IP:$target_file" 2>&1

fi

fi

}

# 步骤1: 确保服务器目录存在

echo -e "${YELLOW}步骤1: 确保服务器目录存在...${NC}"

if [ "$USE_SSH_KEY" = true ]; then

ssh $SERVER_USER@$SERVER_IP "mkdir -p $SERVER_PATH/database/migrations $SERVER_PATH/api $SERVER_PATH/skills" 2>&1

else

echo "请输入服务器密码:"

ssh $SERVER_USER@$SERVER_IP "mkdir -p $SERVER_PATH/database/migrations $SERVER_PATH/api $SERVER_PATH/skills" 2>&1

fi

echo -e "${GREEN}✅ 目录创建完成${NC}"

echo ""

# 步骤2: 上传skills目录（整个目录）

echo -e "${YELLOW}步骤2: 上传skills目录...${NC}"

if [ -d "$LOCAL_PATH/skills" ]; then

# 先上传所有SKILL.md文件

for skill_dir in skills/*/; do

if [ -d "$skill_dir" ]; then

skill_name=$(basename "$skill_dir")

echo "上传技能: $skill_name"

upload_file "$skill_dir" "$SERVER_PATH/skills/"

fi

done

# 上传skills目录下的Python文件

if ls skills/*.py 1> /dev/null 2>&1; then

upload_file "skills/*.py" "$SERVER_PATH/skills/"

fi

echo -e "${GREEN}✅ skills目录上传完成${NC}"

else

echo -e "${RED}❌ skills目录不存在${NC}"

fi

echo ""

# 步骤3: 上传数据库迁移文件

echo -e "${YELLOW}步骤3: 上传数据库迁移文件...${NC}"

upload_file "database/migrations/run_migration_v0.4.py" "$SERVER_PATH/database/migrations/"

upload_file "database/migrations/add_skills_tables.sql" "$SERVER_PATH/database/migrations/"

echo -e "${GREEN}✅ 数据库迁移文件上传完成${NC}"

echo ""

# 步骤4: 上传数据库模型

echo -e "${YELLOW}步骤4: 上传数据库模型...${NC}"

upload_file "database/models.py" "$SERVER_PATH/database/"

echo -e "${GREEN}✅ 数据库模型上传完成${NC}"

echo ""

# 步骤5: 上传API文件

echo -e "${YELLOW}步骤5: 上传API文件...${NC}"

upload_file "api/skills.py" "$SERVER_PATH/api/"

echo -e "${GREEN}✅ API文件上传完成${NC}"

echo ""

# 步骤6: 上传main.py

echo -e "${YELLOW}步骤6: 上传main.py...${NC}"

upload_file "main.py" "$SERVER_PATH/"

echo -e "${GREEN}✅ main.py上传完成${NC}"

echo ""

# 步骤7: 上传脚本文件

echo -e "${YELLOW}步骤7: 上传脚本文件...${NC}"

upload_file "注册技能到数据库.py" "$SERVER_PATH/"

upload_file "测试v0.4功能.py" "$SERVER_PATH/"

upload_file "测试v0.4架构.sh" "$SERVER_PATH/"

upload_file "服务器执行v0.4部署.sh" "$SERVER_PATH/"

upload_file "在服务器上执行.sh" "$SERVER_PATH/"

upload_file "v0.4自动化部署脚本.sh" "$SERVER_PATH/"

upload_file "验证部署.sh" "$SERVER_PATH/"

echo -e "${GREEN}✅ 脚本文件上传完成${NC}"

echo ""

# 步骤8: 设置脚本执行权限

echo -e "${YELLOW}步骤8: 设置脚本执行权限...${NC}"

if [ "$USE_SSH_KEY" = true ]; then

ssh $SERVER_USER@$SERVER_IP "cd $SERVER_PATH && chmod +x *.sh 注册技能到数据库.py 测试v0.4功能.py database/migrations/run_migration_v0.4.py 2>&1" 2>&1

else

echo "请输入服务器密码:"

ssh $SERVER_USER@$SERVER_IP "cd $SERVER_PATH && chmod +x *.sh 注册技能到数据库.py 测试v0.4功能.py database/migrations/run_migration_v0.4.py 2>&1" 2>&1

fi

echo -e "${GREEN}✅ 权限设置完成${NC}"

echo ""

# 完成

echo -e "${GREEN}========== 上传完成 ==========${NC}"

echo ""

echo "下一步操作："

echo "1. SSH连接到服务器: ssh $SERVER_USER@$SERVER_IP"

echo "2. 进入项目目录: cd $SERVER_PATH"

echo "3. 执行部署脚本: ./服务器执行v0.4部署.sh"

echo " 或: ./在服务器上执行.sh"

echo ""
