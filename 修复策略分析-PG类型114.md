# 修复策略分析「Unknown PG numeric type: 114」错误

## 如何看当前流程卡在哪一步

服务端已在策略流程各关键点打了日志，格式为 `[策略流程] 步骤X: ...`。请求策略分析后，看**最后一条** `[策略流程]` 日志出现在哪一步，即可判断卡点：

| 最后一条 [策略流程] 日志 | 卡点 | 可能原因（114） |
|-------------------------|------|-----------------|
| 步骤0: 读取已有策略分析... | 读已有策略 | `strategy_analysis` 表 `visual_data`/`strategies`/`applied_skills` 为 json |
| 步骤0: 完成 existing=... | 通过步骤0 | - |
| 步骤1: 读取分析结果... | 读分析结果 | `analysis_results` 表 `dialogues`/`call1_result`/`stats`/`speaker_mapping` 为 json |
| 步骤1: 完成 analysis_result_db=... | 通过步骤1 | - |
| 步骤2: 调用 _generate_strategies_core... | 进入核心生成 | - |
| 步骤2.1: 场景识别... | 场景识别(Gemini) | 一般不是 114 |
| 步骤2.1: 完成 primary_scene=... | 通过 2.1 | - |
| 步骤2.2: 技能匹配... | 技能匹配(查 skills 表) | `skills` 表 `metadata` 为 json（若存在） |
| 步骤2.2: 完成 匹配到 N 个技能 | 通过 2.2 | - |
| 步骤2.3: 技能执行... | transcript+技能→Gemini | 一般不是 114 |
| 步骤2.3a: 完成 关键时刻=... | 通过 2.3a 融合 | - |
| 步骤2.3b: 图片生成完成 | 通过图片生成 | - |
| 步骤2.4: 写入策略分析到数据库... | 写 strategy_analysis | 写入时或 commit 后驱动反序列化时，列为 json |
| 步骤2.4: 已保存/已更新到数据库 | 通过 2.4 | - |
| 步骤2: _generate_strategies_core 返回成功 | 核心生成全部完成 | - |
| 步骤3: 读取刚写入的策略分析... | 读刚写入的策略(取技能信息) | `strategy_analysis` 表列为 json |

若报错前**没有**任何 `[策略流程]` 日志，说明在「验证任务 / 查 Session」或更早；若有，以**最后一条**为准判断卡点。

---

## 问题出在哪个环节

报错 **「生成策略失败: Unknown PG numeric type: 114」** 出在**数据库读写**环节，不是「summary → 技能匹配 → Gemini」的业务逻辑。

- **PostgreSQL 的 OID 114** 对应的是 `json` 类型（不是 `jsonb`）。
- 服务端代码里 `StrategyAnalysis`、`AnalysisResult` 的 `visual_data`、`strategies`、`applied_skills`、`dialogues`、`call1_result`、`speaker_mapping` 等字段在模型里是 **JSONB**。
- 若建表或历史迁移把这些列建成了 **json**，asyncpg 读取时会报 `Unknown PG numeric type: 114`。
- 报错可能出现在：**读已有策略**（如 `existing_strategy`）、**写策略后再次读**（如 `strategy_after`）、或**读分析结果**（如 `analysis_result_db`）时，只要涉及上述列且库里仍是 `json`，就会触发。

因此：**问题环节 = 数据库里这些列仍是 `json`，需要改成 `jsonb`。**

---

## 当前策略生成流程（便于对照）

当前实现是「**transcript（对话转录）→ 场景识别 → 技能匹配 → transcript + 技能 → Gemini → 策略**」，并不是「summary → 技能匹配 → summary+技能 → Gemini」：

1. **步骤 1：场景识别**  
   用 **transcript** 调 Gemini（`classify_scene`），得到 `scene_result`（如 primary_scene、scenes 及置信度）。

2. **步骤 2：技能匹配**  
   用 **scene_result** 在技能库里做 `match_skills`，得到匹配的技能列表（含 skill_id、priority、confidence 等）。

3. **步骤 3：技能执行**  
   对每个匹配到的技能：用 **transcript + 该技能的 prompt 模板** 调 Gemini，得到该技能下的策略与视觉描述。

4. **步骤 4：合并与落库**  
   `composer` 合并各技能结果 → 得到 `call2_result`（visual、strategies）→ 写入 **strategy_analysis** 表（visual_data、strategies、applied_skills、scene_category、scene_confidence）。  
   **报错就发生在这里的读/写**：若这些列在库里是 `json`，asyncpg 会报 114。

你希望的「**summary 总结 → 技能匹配 → summary + 某技能 → Gemini 出策略**」是另一套产品设计，需要单独改流程（例如用 summary 替代或补充 transcript 做场景/技能输入、再拼 summary+技能给 Gemini）。当前 500 错误与流程设计无关，先修库表类型即可。

---

## 修复步骤（在服务器上执行）

### 1）先检查哪些列仍是 json（可选）

在**项目根目录**执行（会读 .env 的 DATABASE_URL）：

```bash
cd ~/gemini-audio-service
source venv/bin/activate
python3 database/migrations/check_json_columns.py
```

输出会列出各列当前是 `json` 还是 `jsonb`，标出「需执行迁移」的列。

### 2）执行 json → jsonb 迁移

**必须在项目根目录**执行（否则 .env 可能未加载、DATABASE_URL 不对）：

```bash
cd ~/gemini-audio-service
source venv/bin/activate
# 确保 .env 中 DATABASE_URL 与 main.py 使用的库一致
python3 database/migrations/run_fix_json_to_jsonb.py
```

脚本会把以下列从 `json` 改为 `jsonb`（若已是 jsonb 会跳过或报“已存在”类信息，可忽略）：

- **strategy_analysis**：`visual_data`、`strategies`、`applied_skills`
- **analysis_results**：`dialogues`、`stats`、`call1_result`、`speaker_mapping`
- **skills**：`metadata`（技能匹配时读取，若为 json 也会触发 114）

执行成功后**必须重启应用**（否则可能仍用旧连接）：

```bash
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py >> ~/gemini-audio-service.log 2>&1 &
```

再请求策略分析接口，114 错误应消失。若仍报 114，请再次运行 `check_json_columns.py` 确认是否连错库或列未改成功。

---

## 若无法用脚本（手动 SQL）

若服务器上没有 Python 环境或无法跑上述脚本，可在**同一台机的 PostgreSQL** 上用 `psql` 或管理控制台执行：

```sql
-- strategy_analysis
ALTER TABLE strategy_analysis ALTER COLUMN visual_data TYPE jsonb USING visual_data::jsonb;
ALTER TABLE strategy_analysis ALTER COLUMN strategies TYPE jsonb USING strategies::jsonb;
ALTER TABLE strategy_analysis ALTER COLUMN applied_skills TYPE jsonb USING COALESCE(applied_skills::jsonb, '[]'::jsonb);

-- analysis_results
ALTER TABLE analysis_results ALTER COLUMN dialogues TYPE jsonb USING dialogues::jsonb;
ALTER TABLE analysis_results ALTER COLUMN stats TYPE jsonb USING stats::jsonb;
ALTER TABLE analysis_results ALTER COLUMN call1_result TYPE jsonb USING call1_result::jsonb;
ALTER TABLE analysis_results ALTER COLUMN speaker_mapping TYPE jsonb USING speaker_mapping::jsonb;
```

执行完后同样需要重启应用。

---

## 小结

- **问题环节**：数据库里与策略/分析相关的 JSON 列仍是 **json（OID 114）**，导致 asyncpg 报错。
- **修复**：在服务器上执行 `run_fix_json_to_jsonb.py` 或上述 SQL，把这些列改为 **jsonb**，然后重启应用。
- **流程**：当前是 transcript → 场景 → 技能匹配 → transcript+技能 → Gemini → 策略；若要改成「summary + 技能 → Gemini」，需要在此基础上再改产品与接口设计。
