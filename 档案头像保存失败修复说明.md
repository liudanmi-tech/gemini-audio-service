# 档案头像保存失败修复说明

## 问题分析

用户报告"档案中头像的图片保存失败"，主要问题包括：

1. **图片上传超时**：图片上传到OSS需要时间，30秒超时可能不够
2. **上传失败后覆盖原有头像**：如果新图片上传失败，保存时会用`nil`覆盖原有的`photoUrl`
3. **缺少用户反馈**：上传失败时没有明确的错误提示
4. **上传状态不明确**：用户不知道图片是否正在上传

## 修复内容

### 1. 图片上传超时修复 (`NetworkManager.swift`)

- ✅ **增加超时时间**：从30秒增加到60秒
- ✅ **修复重复序列化问题**：避免调用两次`serializingData()`和`serializingDecodable()`
- ✅ **添加上传进度监听**：显示上传进度，便于调试
- ✅ **改进错误处理**：检查HTTP状态码和响应数据，提供更详细的错误信息

### 2. 头像保存逻辑优化 (`ProfileEditView.swift`)

#### 2.1 添加上传状态管理
- ✅ **`isUploadingPhoto`**：跟踪图片是否正在上传
- ✅ **`photoUploadError`**：保存上传错误信息
- ✅ **`originalPhotoUrl`**：保存原始photoUrl，用于上传失败时恢复
- ✅ **`showUploadErrorAlert`**：显示上传失败确认对话框
- ✅ **`pendingSaveAction`**：保存待执行的保存操作

#### 2.2 上传状态显示
- ✅ 在"档案照片"标题旁显示上传进度指示器
- ✅ 上传失败时显示错误图标
- ✅ 上传中显示"上传中..."文字

#### 2.3 保存逻辑优化
- ✅ **上传中阻止保存**：如果图片正在上传，不允许保存，提示用户等待
- ✅ **上传失败提示**：如果上传失败，显示确认对话框，询问是否继续保存（保留原有头像）
- ✅ **保护原有头像**：更新档案时，只有在`photoUrl`不为`nil`时才更新，避免覆盖原有头像
- ✅ **恢复机制**：如果用户选择继续保存，恢复原始`photoUrl`

#### 2.4 错误处理改进
- ✅ 上传失败时显示详细的错误信息
- ✅ 提供"取消"和"继续保存"两个选项
- ✅ 如果用户选择继续保存，清除上传错误状态并恢复原始头像

## 代码变更

### `ProfileEditView.swift`

1. **新增状态变量**：
```swift
@State private var isUploadingPhoto = false
@State private var photoUploadError: String?
@State private var originalPhotoUrl: String?
@State private var showUploadErrorAlert = false
@State private var pendingSaveAction: (() -> Void)?
```

2. **改进图片选择处理**：
- 保存原始`photoUrl`
- 设置上传状态
- 上传失败时恢复原始`photoUrl`
- 显示错误提示

3. **改进保存按钮逻辑**：
- 检查上传状态
- 上传失败时显示确认对话框
- 提取保存逻辑到`performSave()`函数

4. **新增`performSave()`函数**：
- 统一处理创建和更新逻辑
- 更新档案时保护原有头像

## 用户体验改进

1. **明确的状态反馈**：
   - 上传中：显示进度指示器和"上传中..."文字
   - 上传失败：显示错误图标和错误信息
   - 上传成功：正常显示图片

2. **智能的保存保护**：
   - 上传中不允许保存，避免数据不一致
   - 上传失败时询问用户是否继续保存
   - 保护原有头像不被意外覆盖

3. **友好的错误提示**：
   - 详细的错误信息
   - 明确的用户选择
   - 清晰的操作指引

## 测试建议

1. **测试图片上传**：
   - ✅ 选择小图片（<1MB），应该快速上传成功
   - ✅ 选择大图片（>5MB），应该能正常上传（60秒超时）
   - ✅ 网络较慢时，应该显示上传进度
   - ✅ 上传失败时，应该显示错误提示

2. **测试保存逻辑**：
   - ✅ 上传中点击保存，应该提示等待
   - ✅ 上传失败后点击保存，应该询问是否继续保存
   - ✅ 选择继续保存，应该保留原有头像
   - ✅ 选择取消，应该不执行保存操作

3. **测试头像保护**：
   - ✅ 编辑已有头像的档案，上传新图片失败后保存，应该保留原头像
   - ✅ 创建新档案，上传图片失败后保存，应该创建无头像的档案

## 注意事项

1. **超时时间**：如果图片仍然超时，可以考虑：
   - 客户端压缩图片（减小文件大小）
   - 使用异步上传（不阻塞保存操作）
   - 进一步增加超时时间到90秒或更长

2. **网络环境**：在网络较慢的环境下，60秒可能仍然不够，建议：
   - 添加图片压缩功能
   - 显示上传进度百分比
   - 支持取消上传操作

3. **错误恢复**：如果上传失败，用户可以选择：
   - 取消保存，重新选择图片
   - 继续保存，保留原有头像（编辑时）或创建无头像档案（创建时）

## 部署说明

此修复仅涉及客户端代码（`ProfileEditView.swift`），需要：
1. 在Xcode中重新编译项目
2. 运行应用进行测试
3. 验证图片上传和保存功能

服务端代码（`NetworkManager.swift`）的图片上传超时修复也需要重新编译才能生效。
