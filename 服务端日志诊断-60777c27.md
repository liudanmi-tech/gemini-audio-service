# 服务端日志诊断：session 60777c27 / 轮询超时

## 一、日志分析结论

### 1. 上传与分析流程（正常）

| 时间 | 事件 |
|------|------|
| 07:56:27 | 客户端上传成功，返回 200 |
| 07:58:17 | 服务端从 OSS 下载原音频（67MB）用于声纹 |
| 07:58:24 | 声纹处理：Speaker_0、Speaker_1，写入 speaker_mapping |
| 07:58:25 | **status 接口返回 200，耗时 8.5 秒** |
| 07:58:29 | 任务详情接口返回 200，耗时 3.2 秒 |
| 07:58:47 | conversation_summary、记忆 B 钩子写入 |

### 2. 档案匹配（已正确）

```
[声纹] speaker_mapping 已写入: {'Speaker_1': '01b97e6e-a2da-472e-ad05-d541152b25d5'}
[任务详情] 使用 transcript+is_me 计算 speaker_names: {'Speaker_1': '梁志远（自己）'}，未映射者显示为 Speaker_X
```

- Speaker_1 → 梁志远（自己）✓
- Speaker_0 → 未映射，显示 Speaker_0 ✓

### 3. 轮询超时原因

- **status 接口单次耗时约 8.5 秒**：分析阶段会从 OSS 下载大文件（约 67MB），同步下载会阻塞事件循环，导致其他请求排队
- **客户端原超时 60 秒**：在分析密集期，若多次 status 请求排队，可能累积到 60 秒才返回，客户端提前超时
- **调整**：已将 status 轮询超时从 60 秒改为 90 秒，提高成功率

## 二、后续可优化方向

1. **OSS 下载改为异步**：在 `get_session_audio_local_path` 中用 `run_in_executor` 执行同步下载，避免阻塞事件循环
2. **首次轮询延后**：客户端可在上传成功后等待 5–10 秒再开始轮询，减少与分析的竞争
