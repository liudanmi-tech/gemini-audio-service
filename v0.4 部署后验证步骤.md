# v0.4 部署后验证步骤

## 部署完成后的验证流程

部署脚本执行完成后，需要验证以下几个方面：

---

## 第一步：验证服务状态

### 1.1 检查服务进程

```bash
# 在服务器上执行

ps aux | grep '[p]ython.*main.py'
```

**预期结果**: 应该看到一个Python进程正在运行，进程ID（PID）类似：`admin 12345 0.5 2.0 ... python3 main.py`

### 1.2 检查服务端口

```bash
# 检查8001端口是否在监听

netstat -tlnp | grep 8001

# 或使用 ss 命令

ss -tlnp | grep 8001
```

**预期结果**: 应该看到 `0.0.0.0:8001` 正在监听

### 1.3 查看服务日志

```bash
# 查看最近50行日志

tail -50 ~/gemini-audio-service.log



# 查看启动相关日志

tail -100 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|Application startup|ERROR"



# 实时查看日志（按Ctrl+C退出）

tail -f ~/gemini-audio-service.log
```

**预期结果**: 应该看到 "Uvicorn running on http://0.0.0.0:8001" 或 "Application startup complete"

---

## 第二步：验证基础API

### 2.1 健康检查

```bash
# 测试服务是否响应

curl http://localhost:8001/



# 或测试根路径

curl http://localhost:8001/health
```

**预期结果**: 应该返回JSON格式的服务信息或 "OK"

### 2.2 获取技能列表（需要认证）

```bash
# 先登录获取Token

TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \

-H "Content-Type: application/json" \

-d '{"phone": "13800138000", "code": "123456"}' | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['token'])")



# 测试获取技能列表

curl -X GET "http://localhost:8001/api/v1/skills" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | python3 -m json.tool
```

**预期结果**: 应该返回4个技能的列表（workplace_jungle, family_relationship, education_communication, brainstorm）

---

## 第三步：验证数据库

### 3.1 验证技能注册

在服务器上执行：

```bash
python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')} (category: {skill.get('category')})")

if len(skills) != 4:

print(f"⚠️ 警告: 应该注册4个技能，但只找到 {len(skills)} 个")



asyncio.run(verify())

EOF
```

**预期结果**: 应该看到4个技能都已注册

### 3.2 验证数据库表结构

```bash
# 连接到数据库（需要根据实际配置调整）

psql $DATABASE_URL -c "\d skills"

psql $DATABASE_URL -c "\d skill_executions"

psql $DATABASE_URL -c "\d strategy_analysis" | grep -E "applied_skills|scene_category|scene_confidence"
```

**预期结果**: 应该看到 `skills`、`skill_executions` 表，以及 `strategy_analysis` 表的新字段

---

## 第四步：运行功能测试

### 4.1 运行完整功能测试

```bash
cd ~/gemini-audio-service

python3 测试v0.4功能.py
```

**预期结果**:

- ✅ 技能列表查询成功

- ✅ 技能加载成功

- ✅ 场景识别成功（需要网络连接和Gemini API）

- ✅ 技能匹配成功

**注意**: 如果网络连接或Gemini API有问题，场景识别测试可能会失败，但其他测试应该通过。

### 4.2 测试场景识别API

```bash
# 先登录获取Token（如果还没有）

TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \

-H "Content-Type: application/json" \

-d '{"phone": "13800138000", "code": "123456"}' | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['token'])")



# 获取一个已有的session_id（从任务列表中获取）

SESSION_ID=$(curl -s -X GET "http://localhost:8001/api/v1/tasks/sessions?page=1&page_size=1" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['data']['sessions'][0]['session_id'] if data['data']['sessions'] else '')")



# 测试场景识别

if [ -n "$SESSION_ID" ]; then

curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/classify-scene" \

-H "Authorization: Bearer $TOKEN" \

-H "Content-Type: application/json" | python3 -m json.tool

else

echo "⚠️ 没有找到可用的session_id，跳过场景识别测试"

fi
```

**预期结果**: 应该返回场景识别结果，包含 `primary_scene`、`scenes` 等字段

---

## 第五步：端到端测试（可选）

### 5.1 上传音频并验证策略生成

如果条件允许，可以：

1. **通过iOS客户端上传音频**

2. **等待音频分析完成**（status变为 `archived`）

3. **查看策略生成结果**，验证：
- `applied_skills` 字段是否包含技能列表

- `scene_category` 字段是否包含识别的场景类别

- `scene_confidence` 字段是否包含置信度

- 策略内容是否符合技能化架构的输出

---

## 快速验证脚本

将以下脚本保存为 `验证部署.sh`，在服务器上执行：

```bash
#!/bin/bash

# v0.4 部署后验证脚本



echo "========== v0.4 部署后验证 =========="

echo ""



# 1. 检查服务进程

echo "1. 检查服务进程..."

if ps aux | grep '[p]ython.*main.py' > /dev/null; then

echo "✅ 服务进程运行中"

ps aux | grep '[p]ython.*main.py' | head -1

else

echo "❌ 服务进程未运行"

fi

echo ""



# 2. 检查端口

echo "2. 检查端口..."

if netstat -tlnp 2>/dev/null | grep -q ":8001" || ss -tlnp 2>/dev/null | grep -q ":8001"; then

echo "✅ 端口8001正在监听"

else

echo "❌ 端口8001未监听"

fi

echo ""



# 3. 检查服务日志

echo "3. 检查服务日志..."

if tail -100 ~/gemini-audio-service.log 2>/dev/null | grep -q "Uvicorn running\|Application startup complete"; then

echo "✅ 服务启动成功"

else

echo "⚠️ 未在日志中发现启动成功信息"

fi

echo ""



# 4. 健康检查

echo "4. 健康检查..."

if curl -s http://localhost:8001/ > /dev/null 2>&1; then

echo "✅ 服务响应正常"

curl -s http://localhost:8001/ | head -1

else

echo "❌ 服务无响应"

fi

echo ""



# 5. 验证技能注册

echo "5. 验证技能注册..."

python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

try:

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')}")

if len(skills) != 4:

print(f"⚠️ 警告: 应该注册4个技能，但只找到 {len(skills)} 个")

except Exception as e:

print(f"❌ 验证失败: {e}")



asyncio.run(verify())

EOF



echo ""

echo "========== 验证完成 =========="
```

---

## 常见问题排查

### 问题1: 服务未启动

**症状**: `ps aux | grep python.*main.py` 没有输出

**解决方案**:

```bash
# 查看启动日志

tail -100 ~/gemini-audio-service.log



# 手动启动服务

cd ~/gemini-audio-service

source venv/bin/activate

nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
```

### 问题2: 端口未监听

**症状**: `netstat -tlnp | grep 8001` 没有输出

**解决方案**:

- 检查防火墙设置

- 检查服务是否真的在监听（查看日志）

### 问题3: 技能未注册

**症状**: 技能列表查询返回空或少于4个

**解决方案**:

```bash
# 重新注册技能

cd ~/gemini-audio-service

python3 注册技能到数据库.py
```

### 问题4: API返回401或403

**症状**: API调用返回 "Not authenticated" 或 "Not authorized"

**解决方案**:

- 检查Token是否有效

- 重新登录获取新Token

---

## 下一步操作

如果所有验证都通过，可以：

1. **监控日志**: `tail -f ~/gemini-audio-service.log`，观察服务运行情况

2. **测试实际场景**: 通过iOS客户端上传真实音频，验证技能化架构的效果

3. **优化配置**: 根据实际效果调整技能的优先级、Prompt模板等

4. **添加新技能**: 按照规范添加新的场景类型和技能

---

**文档版本**: v0.4

**创建日期**: 2026-01-16
