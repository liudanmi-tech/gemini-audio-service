# ============================================
# å®Œæ•´ä¿®å¤æ–¹æ¡ˆ - å…ˆæ£€æŸ¥å†ä¿®å¤
# ============================================

# ============================================
# ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä»£ç ç»“æ„
# ============================================
cd /home/admin/gemini-audio-service && python3 << 'CHECK'
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

print("ğŸ” æ£€æŸ¥ä»£ç ç»“æ„...")
print("")

# æ£€æŸ¥æ˜¯å¦æœ‰ temp_file_path
if 'temp_file_path' in content:
    print("âœ… æ‰¾åˆ° temp_file_path å˜é‡")
else:
    print("âŒ æœªæ‰¾åˆ° temp_file_path å˜é‡")

# æ£€æŸ¥æ˜¯å¦æœ‰ file_filename
if 'file_filename' in content:
    print("âœ… æ‰¾åˆ° file_filename å˜é‡")
else:
    print("âŒ æœªæ‰¾åˆ° file_filename å˜é‡")

# æ£€æŸ¥å‡½æ•°è°ƒç”¨
if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
    print("âŒ å‡½æ•°è°ƒç”¨ä½¿ç”¨æ—§ç‰ˆæœ¬: (session_id, file, task_data)")
elif 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))' in content:
    print("âœ… å‡½æ•°è°ƒç”¨ä½¿ç”¨æ–°ç‰ˆæœ¬: (session_id, temp_file_path, file_filename, task_data)")
else:
    print("âš ï¸  æœªçŸ¥çš„è°ƒç”¨æ ¼å¼")

print("")
print("æ£€æŸ¥ upload_audio_api å‡½æ•°ä¸­æ˜¯å¦æœ‰æ–‡ä»¶è¯»å–ä»£ç ...")
if 'file_content = await file.read()' in content:
    print("âœ… æ‰¾åˆ°æ–‡ä»¶è¯»å–ä»£ç ")
else:
    print("âŒ æœªæ‰¾åˆ°æ–‡ä»¶è¯»å–ä»£ç ï¼Œå¯èƒ½éœ€è¦æ·»åŠ ")
CHECK

# ============================================
# ç¬¬äºŒæ­¥ï¼šæ ¹æ®æ£€æŸ¥ç»“æœæ‰§è¡Œä¿®å¤
# ============================================

# å¦‚æœç¬¬ä¸€æ­¥æ˜¾ç¤ºéœ€è¦ä¿®å¤ï¼Œæ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼š

cd /home/admin/gemini-audio-service && python3 << 'FIX'
import shutil, time

backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"âœ… å¤‡ä»½: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# ä¿®å¤1: å‡½æ•°è°ƒç”¨
if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
    content = content.replace(
        'asyncio.create_task(analyze_audio_async(session_id, file, task_data))',
        'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'
    )
    print("âœ… ä¿®å¤1: å‡½æ•°è°ƒç”¨å·²æ›´æ–°")

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ–‡ä»¶è¯»å–ä»£ç 
if 'file_content = await file.read()' not in content and 'asyncio.create_task(analyze_audio_async' in content:
    # éœ€è¦åœ¨è°ƒç”¨å‰æ·»åŠ æ–‡ä»¶è¯»å–ä»£ç 
    # æŸ¥æ‰¾è°ƒç”¨ä½ç½®
    call_pos = content.find('asyncio.create_task(analyze_audio_async')
    if call_pos != -1:
        # æŸ¥æ‰¾è¿™ä¸€è¡Œçš„å¼€å§‹ä½ç½®
        line_start = content.rfind('\n', 0, call_pos) + 1
        indent = len(content[line_start:call_pos]) - len(content[line_start:call_pos].lstrip())
        
        # æ£€æŸ¥å‰é¢æ˜¯å¦æœ‰æ–‡ä»¶è¯»å–ä»£ç 
        before_call = content[max(0, call_pos-500):call_pos]
        if 'file_content = await file.read()' not in before_call:
            # éœ€è¦æ·»åŠ æ–‡ä»¶è¯»å–å’Œä¸´æ—¶æ–‡ä»¶åˆ›å»ºä»£ç 
            insert_code = f'''
        # è¯»å–æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆå¿…é¡»åœ¨å¼‚æ­¥ä»»åŠ¡ä¹‹å‰è¯»å–ï¼Œå› ä¸º UploadFile åªèƒ½è¯»å–ä¸€æ¬¡ï¼‰
        file_content = await file.read()
        file_filename = file.filename or "audio.m4a"
        file_ext = Path(file_filename).suffix.lower() if file_filename else '.m4a'
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜æ–‡ä»¶å†…å®¹
        import tempfile
        temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
        temp_file.write(file_content)
        temp_file.close()
        temp_file_path = temp_file.name
        
        # å¼‚æ­¥åˆ†æï¼ˆä¼ é€’ä¸´æ—¶æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åï¼Œç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½æ­£ç¡®ä¼ é€’ï¼‰
        logger.info(f"åˆ›å»ºå¼‚æ­¥åˆ†æä»»åŠ¡: session_id={{session_id}}, file_path={{temp_file_path}}, filename={{file_filename}}")
'''
            # åœ¨è°ƒç”¨å‰æ’å…¥
            content = content[:call_pos] + insert_code + content[call_pos:]
            print("âœ… ä¿®å¤2: æ·»åŠ äº†æ–‡ä»¶è¯»å–å’Œä¸´æ—¶æ–‡ä»¶åˆ›å»ºä»£ç ")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

import py_compile
py_compile.compile('main.py', doraise=True)
print("âœ… ä¿®å¤å®Œæˆï¼Œéœ€è¦é‡å¯æœåŠ¡")
FIX

# é‡å¯æœåŠ¡
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && echo "âœ… æœåŠ¡å·²é‡å¯" && curl -s http://localhost:8001/health

