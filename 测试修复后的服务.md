# 测试修复后的服务

## 步骤 1: 确认服务器代码已修复

在命令助手中执行：

```bash
cd /home/admin/gemini-audio-service
grep -n "analyze_audio_from_path" main.py | head -5
```

如果看到输出，说明代码已修复。如果没有输出，需要先应用修复（见下面的"如果代码未修复"）。

## 步骤 2: 检查 analyze_audio_async 函数

```bash
grep -A 10 "async def analyze_audio_async" main.py | head -15
```

应该看到类似这样的代码：
```python
async def analyze_audio_async(...):
    ...
    result = await analyze_audio_from_path(temp_file_path, file_filename)
```

**不应该**看到：
```python
result = await analyze_audio(new_file)
```

## 步骤 3: 如果代码未修复，应用修复

在命令助手中执行：

```bash
cd /home/admin/gemini-audio-service
cp main.py main.py.backup7

# 修复关键行
sed -i 's/result = await analyze_audio(new_file)/result = await analyze_audio_from_path(temp_file_path, file_filename)/g' main.py

# 检查语法
python3 -m py_compile main.py && echo "✅ 语法OK" || (echo "❌ 语法错误，恢复备份" && cp main.py.backup7 main.py)

# 如果语法OK，重启服务
if [ $? -eq 0 ]; then
    pkill -f "python3 main.py" || true
    sleep 2
    source venv/bin/activate
    nohup python3 main.py > ~/gemini-service.log 2>&1 &
    sleep 5
    curl http://localhost:8001/health
fi
```

## 步骤 4: 测试 iOS 客户端

1. **在 iOS 模拟器中打开应用**
2. **点击录制按钮**，录制一段音频（5-10秒即可）
3. **停止录制**，观察：
   - 列表是否立即出现新的"分析中"任务
   - 等待一段时间后，任务状态是否变为"已完成"
   - 点击任务，查看详情是否包含对话和风险分析

## 步骤 5: 查看服务器日志

如果测试失败，查看日志：

```bash
tail -100 ~/gemini-audio-service.log | grep -i "error\|exception\|失败\|analyze_audio"
```

或者实时查看日志：

```bash
tail -f ~/gemini-audio-service.log
```

## 步骤 6: 如果还有问题

如果仍然出现 "I/O operation on closed file" 错误，可能需要：

1. **检查 analyze_audio_from_path 函数是否存在**：
```bash
grep -n "async def analyze_audio_from_path" main.py
```

2. **如果不存在，需要完整替换 main.py 文件**（使用 base64 方法）

3. **或者检查 analyze_audio_async 函数中是否还有创建 UploadFile 的代码**：
```bash
grep -A 20 "async def analyze_audio_async" main.py | grep -i "uploadfile\|bytesio"
```

如果还有这些代码，需要删除它们。

