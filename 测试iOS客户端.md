# 测试 iOS 客户端 - 完整流程

## ✅ 服务器代码已修复

已确认服务器上的 `main.py` 已修复，`analyze_audio_from_path` 函数正在被调用。

## 测试步骤

### 1. 在 Xcode 中运行 iOS 应用

- 确保选择正确的模拟器（iOS 16.0+）
- 点击运行按钮（Cmd + R）

### 2. 测试录制和上传功能

1. **打开应用**，应该看到"任务"标签页
2. **点击底部的录制按钮**（麦克风图标）
3. **录制一段音频**（5-10秒即可，可以说几句话）
4. **停止录制**（再次点击录制按钮）

### 3. 观察预期行为

#### 立即（0-2秒内）：
- ✅ 任务列表应该**立即**出现一个新的任务
- ✅ 任务标题应该是"录音 XX:XX"（当前时间）
- ✅ 任务状态应该显示为"分析中"或"analyzing"
- ✅ 任务应该显示一个加载动画或进度指示器

#### 等待 30-60 秒后：
- ✅ 任务状态应该从"分析中"变为"已完成"或"archived"
- ✅ 任务应该显示情绪分数（0-100）
- ✅ 任务应该显示说话人数量
- ✅ 任务应该显示标签（如 #正常、#PUA预警 等）

#### 点击任务查看详情：
- ✅ 应该显示完整的对话列表
- ✅ 每个对话应该包含：说话人、内容、语气
- ✅ 应该显示风险点列表

### 4. 如果出现问题

#### 问题 1: 列表中没有出现新任务

**检查**：
- 查看 Xcode 控制台日志，搜索 `📝 [TaskListViewModel]` 或 `📢 [RecordingViewModel]`
- 确认是否看到 "NewTaskCreated 通知" 或 "任务已添加"

**可能原因**：
- 上传失败
- 通知没有正确发送/接收

#### 问题 2: 任务一直显示"分析中"

**检查服务器日志**：
```bash
tail -100 ~/gemini-audio-service.log | grep -i "error\|exception\|失败\|分析音频失败"
```

**可能原因**：
- Gemini API 调用失败
- 文件上传到 Gemini 失败
- 网络问题

#### 问题 3: 任务状态变为"失败"

**检查服务器日志**：
```bash
tail -200 ~/gemini-audio-service.log | grep -A 20 "分析音频失败"
```

**可能原因**：
- 仍然有 "I/O operation on closed file" 错误（说明修复不完整）
- Gemini API 配额问题
- 音频文件格式问题

### 5. 实时监控日志

在测试时，可以在服务器上实时查看日志：

```bash
tail -f ~/gemini-audio-service.log
```

或者只看错误：

```bash
tail -f ~/gemini-audio-service.log | grep -i "error\|exception\|失败"
```

## 预期成功的日志示例

如果一切正常，你应该在服务器日志中看到：

```
INFO: 上传音频文件
INFO: ========== 文件上传处理开始 ==========
INFO: ========== 开始上传文件到 Gemini ==========
INFO: ✅ 文件上传成功！
INFO: ========== 等待文件处理完成 ==========
INFO: ✅ 文件处理完成，状态: ACTIVE
INFO: ========== 开始调用 Gemini 模型分析音频 ==========
INFO: ✅ 模型调用成功
INFO: 任务 xxxxx 分析完成
```

## 下一步

1. **先测试一次完整的流程**
2. **如果成功**，恭喜！系统已经正常工作了
3. **如果失败**，把错误信息发给我，我会帮你排查

开始测试吧！🎉

