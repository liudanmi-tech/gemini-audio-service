# 服务端问题排查清单

## 一、本机执行诊断（若 SSH 可用）

在项目目录执行：
```bash
bash 本地执行-SSH诊断列表超时.sh
```
或直接执行 `阿里云远程连接-诊断列表超时.txt` 中的命令（通过 SSH 或阿里云 Workbench）。

---

## 二、已知服务端问题（来自此前诊断）

### 1. 应用曾未运行
- **现象**：无 uvicorn 进程，8000 端口无监听
- **处理**：已通过 `--workers 4` 重启；若再次宕机需排查启动失败原因

### 2. Gemini 文件上传 TypeError
- **日志**：`TypeError: string indices must be integers, not 'str'`
- **位置**：`genai.upload_file()` / `create_file`，解析 Gemini 返回结构时
- **影响**：录音上传后，分析流程中的 Gemini 文件上传可能失败，导致分析卡住或报错
- **可能原因**：代理返回 HTML 错误页（如 502）或非预期 JSON 结构

### 3. googleapiclient 兼容性告警
- **日志**：`execute() takes at most 1 positional argument (3 given)`
- **影响**：Gemini API 调用可能异常

### 4. 上传接口响应延迟
- **现象**：客户端显示 100% 后长时间无响应
- **原因**：服务端需完成：收包 → 落盘 → 上传 OSS → 上传 Gemini → 创建异步分析任务 → 返回。大文件时整体耗时可到数十秒。

---

## 三、建议在服务器上执行的命令

通过阿里云 Workbench 或本地 SSH 登录后执行：

```bash
# 1. 应用与端口
ps aux | grep uvicorn | grep -v grep
ss -tlnp | grep 8000

# 2. 健康检查
curl -s --max-time 5 http://127.0.0.1:8000/health

# 3. 最近错误
tail -200 ~/gemini-audio-service.log | grep -E "ERROR|TypeError|Exception"

# 4. 上传相关日志
tail -300 ~/gemini-audio-service.log | grep -E "收到音频|upload|audio/upload|Response.*upload"
```

---

## 四、录音分析轮询超时（status 一直 analyzing）

- **现象**：上传成功，客户端轮询约 50 次后超时，status 始终为 analyzing
- **可能原因**：OSS 上传阻塞、Gemini 文件上传失败（TypeError）、或分析流程未正确更新 status
- **排查命令**（在服务器上执行）：
  ```bash
  # 查看指定 session 的分析日志（替换 SESSION_ID）
  tail -500 ~/gemini-audio-service.log | grep -E "SESSION_ID|开始异步分析|oss_upload|gemini_analysis|分析音频失败|archived|failed"
  # 查看 Gemini 上传/分析相关错误
  tail -500 ~/gemini-audio-service.log | grep -E "TypeError|genai.upload|上传失败|分析音频失败"
  ```
- **新增改进**：`analysis_stage` 列已加入，分析过程会写入 oss_upload/gemini_analysis/voiceprint，客户端可展示更细进度。需执行迁移：
  ```bash
  # 在服务器上执行迁移
  psql "$DATABASE_URL" -f database/migrations/add_session_analysis_stage.sql
  # 然后重启服务
  ```

---

## 五、若本机 SSH 超时

1. 使用阿里云 Workbench：控制台 → ECS → 实例 → 远程连接 → 通过 Workbench 连接
2. 检查本机网络/代理：关闭 VPN 或切换网络后再试
3. 检查安全组：确认 22 端口已放行
