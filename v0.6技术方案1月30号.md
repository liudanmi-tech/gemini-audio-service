# v0.6 技术方案（2026年1月30日）

本文档整理当前服务端技术方案，包含接口清单与数据库表名，便于前后端对齐与运维参考。

---

## 一、技术方案概述

- **服务**：FastAPI 音频分析微服务，基于 Google Gemini API 做语音转写、场景识别与策略生成。
- **认证**：JWT（Bearer），默认有效期 168 小时（7 天），可通过 `JWT_EXPIRATION_HOURS` 配置。
- **部署**：Uvicorn 监听 8000，对外经 Nginx 80 端口转发；客户端建议使用 `http://{host}/api/v1`（80 端口）。
- **技能架构**：技能目录 `skills/{skill_id}/SKILL.md`，启动时加载并落库；策略生成流程：场景识别 → 技能匹配 → 单技能执行/多技能融合 → 写库与图片生成。

---

## 二、接口文档

除注明外，接口均需在请求头携带：`Authorization: Bearer <token>`。

**基础路径**：`/api/v1`（示例：`http://47.79.254.213/api/v1`）

### 2.1 认证（/api/v1/auth）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/auth/send-code` | 发送验证码。Body: `{"phone": "11位手机号"}`。返回 `code/message/data{phone, code?}`。 |
| POST | `/api/v1/auth/login` | 登录。Body: `{"phone": "11位手机号", "code": "6位验证码"}`。返回 `data: {token, user_id, expires_in}`。 |
| GET  | `/api/v1/auth/me` | 获取当前用户信息。需 Bearer。返回 `data: {user_id, phone, created_at, last_login_at}`。 |

### 2.2 任务/录音（/api/v1/tasks/sessions）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/audio/upload` | 上传音频并创建分析任务。Body: multipart/form-data，字段 `file`。返回 `data: {session_id, ...}`。 |
| GET  | `/api/v1/tasks/sessions` | 任务列表（分页）。Query: `page`, `page_size`。返回 `data: {sessions[], pagination}`。 |
| GET  | `/api/v1/tasks/sessions/{session_id}` | 任务详情。返回会话、分析摘要、策略摘要等。 |
| GET  | `/api/v1/tasks/sessions/{session_id}/status` | 任务分析状态。返回 `status/progress/estimatedTimeRemaining/failureReason` 等。 |
| POST | `/api/v1/tasks/sessions/{session_id}/classify-scene` | 仅做场景分类（内部或调试用）。 |
| POST | `/api/v1/tasks/sessions/{session_id}/strategies` | 生成策略分析（情商教练）。触发场景识别、技能匹配、Gemini 策略生成与写库。 |
| GET  | `/api/v1/tasks/sessions/{session_id}/audio-segments` | 获取该会话的音频片段列表（按说话人/时间）。 |
| POST | `/api/v1/tasks/sessions/{session_id}/extract-segment` | 按时间范围剪切并上传片段。Body: `{start_time, end_time, speaker}`。 |

### 2.3 图片

| 方法 | 路径 | 说明 |
|------|------|------|
| GET  | `/api/v1/images/{session_id}/{image_index}` | 获取策略中某张图片。需 Bearer。支持私有 OSS 或本地文件。 |

### 2.4 技能（/api/v1/skills）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET  | `/api/v1/skills` | 技能列表。Query: `enabled`（可选）。返回技能 id/name/description/category 等。 |
| GET  | `/api/v1/skills/{skill_id}` | 技能详情。 |
| POST | `/api/v1/skills` | 创建技能（管理员）。 |
| PUT  | `/api/v1/skills/{skill_id}` | 更新技能。 |
| POST | `/api/v1/skills/{skill_id}/reload` | 重新加载该技能（文件变更后）。 |

### 2.5 档案（/api/v1/profiles）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET  | `/api/v1/profiles` | 档案列表（当前用户）。 |
| POST | `/api/v1/profiles` | 创建档案。 |
| PUT  | `/api/v1/profiles/{profile_id}` | 更新档案。 |
| DELETE | `/api/v1/profiles/{profile_id}` | 删除档案。 |
| POST | `/api/v1/profiles/upload-photo` | 上传档案照片。Body: multipart，字段 `file`，Query: `profile_id`。 |

### 2.6 其他

| 方法 | 路径 | 说明 |
|------|------|------|
| GET  | `/health` | 健康检查。无需认证。返回 `{"status":"ok", ...}`。 |
| GET  | `/api/v1/admin/cleanup-images` | 清理过期图片（按天数）。Query: `days`（默认 7）。 |

---

## 三、数据库表名称

| 表名 | 说明 |
|------|------|
| **users** | 用户。字段：id, phone, created_at, updated_at, last_login_at, is_active。 |
| **sessions** | 会话/任务。字段：id, user_id, title, start_time, end_time, duration, status, error_message, emotion_score, speaker_count, tags, audio_url, audio_path, created_at, updated_at。 |
| **analysis_results** | 分析结果。字段：id, session_id, dialogues, risks, summary, mood_score, stats, transcript, call1_result, speaker_mapping, conversation_summary, created_at, updated_at。 |
| **strategy_analysis** | 策略分析。字段：id, session_id, visual_data, strategies, applied_skills, scene_category, scene_confidence, created_at, updated_at。 |
| **skills** | 技能库。字段：skill_id(PK), name, description, category, skill_path, priority, enabled, version, prompt_template, metadata, created_at, updated_at。 |
| **skill_executions** | 技能执行记录。字段：id, session_id, skill_id, scene_category, confidence_score, execution_time_ms, success, error_message, created_at。 |
| **verification_codes** | 验证码。字段：id, phone, code, expires_at, used, created_at。 |
| **profiles** | 档案。字段：id, user_id, name, relationship, photo_url, notes, audio_session_id, audio_segment_id, audio_start_time, audio_end_time, audio_url, created_at, updated_at。 |

---

## 四、v0.6 变更摘要（相对 v0.4/v0.5）

- **认证**：JWT 默认 168 小时；登录/发送验证码错误时解析 FastAPI `detail`，避免客户端解码失败。
- **策略**：`strategy_analysis.scene_confidence`、`skill_executions.confidence_score` 为 **double precision**；提供迁移脚本与 Nginx 504 超时修复（/api 代理 300s）。
- **部署**：客户端 API 使用 80 端口经 Nginx 转发；SSH 脚本：修复 Nginx 502、504 超时、自动重启服务；可选 systemd 与 confidence 修复并重启脚本。
- **档案/声纹**：v0.5 档案匹配方案文档；当前支持 `speaker_mapping`、`conversation_summary`、音频片段与剪切接口，声纹匹配与自动关联可按 v0.5 文档迭代。

---

## 五、文档与脚本索引

- 策略类型修复：`策略分析confidence_score类型修复说明.md`
- Nginx：`SSH修复Nginx502.sh`、`SSH修复Nginx504超时.sh`
- 部署与重启：`SSH自动重启服务.sh`、`服务器上执行-策略confidence_score修复并重启.sh`
- 档案匹配方案：`v0.5档案匹配0130.md`
- 技术检查：`v0.4_技术实现检查报告.md`
