# 服务端连接问题排查

## 问题现象

iOS 客户端报错：
```
Response could not be serialized, input data was nil or zero length.
```

测试连接服务端失败：
```
Failed to connect to 47.79.254.213 port 8001
```

## 问题原因

服务端 `http://47.79.254.213:8001` 无法连接，可能的原因：

1. **服务端未运行**
2. **端口 8001 未对外开放**
3. **防火墙阻止连接**

## 解决方案

### 方案 1: 检查服务端是否运行

在服务器上执行：
```bash
# 检查服务是否运行
ps aux | grep python3 | grep main.py

# 检查端口是否监听
netstat -tlnp | grep 8001
# 或
ss -tlnp | grep 8001
```

如果没有运行，启动服务：
```bash
cd /opt/work-survival-backend  # 或你的项目目录
source venv/bin/activate
python3 main.py
```

### 方案 2: 使用 Nginx 反向代理（推荐）

如果已经配置了 Nginx 反向代理，应该使用 80 端口而不是 8001。

**修改 iOS 客户端配置**：

在 `NetworkManager.swift` 中：
```swift
// 如果使用 Nginx 反向代理，使用 80 端口
private let baseURL = "http://47.79.254.213/api/v1"
```

**配置 Nginx**（如果还没有配置）：

在服务器上编辑 Nginx 配置：
```nginx
server {
    listen 80;
    server_name 47.79.254.213;

    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

然后重启 Nginx：
```bash
sudo nginx -t  # 测试配置
sudo systemctl reload nginx  # 重新加载配置
```

### 方案 3: 开放端口 8001

如果直接使用 8001 端口，需要：

1. **检查防火墙**：
```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 8001

# CentOS/RHEL
sudo firewall-cmd --list-ports
sudo firewall-cmd --permanent --add-port=8001/tcp
sudo firewall-cmd --reload
```

2. **检查阿里云安全组**：
   - 登录阿里云控制台
   - 进入 ECS 实例
   - 配置安全组规则
   - 添加入站规则：端口 8001，协议 TCP

### 方案 4: 使用本地测试（开发阶段）

如果服务端在本地运行，可以：

1. **修改 iOS 客户端配置**：
```swift
// 本地测试
private let baseURL = "http://localhost:8001/api/v1"
```

2. **在模拟器中访问本地服务**：
   - 模拟器使用 `localhost` 或 `127.0.0.1`
   - 真机需要使用电脑的局域网 IP（如 `192.168.1.100:8001`）

## 验证连接

配置完成后，测试连接：

```bash
# 测试服务端是否可访问
curl http://47.79.254.213:8001/health
# 或
curl http://47.79.254.213/api/v1/health
```

应该返回：
```json
{"message": "音频分析服务正在运行", "status": "ok"}
```

## 下一步

1. **确认服务端运行状态**
2. **选择上述方案之一**
3. **更新 iOS 客户端配置**
4. **重新测试**

---

**现在我已经添加了详细的响应日志，重新运行应用后，控制台会显示：**
- 原始响应数据
- 响应内容
- 解析后的响应

这样可以帮助进一步诊断问题。

