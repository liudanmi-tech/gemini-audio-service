# 服务器启动服务指南

## 当前状态
- ❌ 服务端未运行
- ❌ 端口 8001 未监听

## 启动步骤

### 1. 找到项目目录

```bash
# 查找项目目录
find ~ -name "main.py" -type f 2>/dev/null | grep gemini
# 或
find /opt -name "main.py" -type f 2>/dev/null
# 或
find /home -name "main.py" -type f 2>/dev/null
```

如果找不到，可能需要先上传项目文件到服务器。

### 2. 进入项目目录

假设项目在 `/opt/work-survival-backend` 或 `~/gemini-audio-service`：

```bash
cd /opt/work-survival-backend
# 或
cd ~/gemini-audio-service
```

### 3. 激活虚拟环境

```bash
source venv/bin/activate
# 如果没有虚拟环境，创建：
# python3 -m venv venv
# source venv/bin/activate
```

### 4. 安装依赖（如果需要）

```bash
pip3 install -r requirements.txt
```

### 5. 检查环境变量

```bash
# 检查 .env 文件
cat .env
# 应该包含：
# GEMINI_API_KEY=your_key
# PROXY_URL=http://47.79.254.213/secret-channel
# USE_PROXY=true
```

### 6. 启动服务（前台测试）

```bash
python3 main.py
```

如果看到类似输出，说明启动成功：
```
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001
```

### 7. 后台运行服务（推荐）

#### 方法 1: 使用 nohup

```bash
# 停止前台运行（Ctrl+C）
# 然后使用 nohup 后台运行
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &

# 查看进程
ps aux | grep python3 | grep main.py

# 查看日志
tail -f /tmp/gemini-service.log
```

#### 方法 2: 使用 systemd（推荐用于生产环境）

创建服务文件：
```bash
sudo nano /etc/systemd/system/gemini-audio.service
```

内容：
```ini
[Unit]
Description=Gemini Audio Service
After=network.target

[Service]
Type=simple
User=admin
WorkingDirectory=/opt/work-survival-backend
Environment="PATH=/opt/work-survival-backend/venv/bin"
ExecStart=/opt/work-survival-backend/venv/bin/python3 /opt/work-survival-backend/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable gemini-audio.service
sudo systemctl start gemini-audio.service
sudo systemctl status gemini-audio.service
```

### 8. 验证服务运行

```bash
# 检查进程
ps aux | grep python3 | grep main.py

# 检查端口
sudo netstat -tlnp | grep 8001
# 或
sudo ss -tlnp | grep 8001

# 测试 API
curl http://localhost:8001/health
curl http://localhost:8001/api/v1/tasks/sessions
```

### 9. 开放防火墙端口（如果需要）

```bash
# Ubuntu/Debian
sudo ufw allow 8001/tcp
sudo ufw status

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8001/tcp
sudo firewall-cmd --reload
```

### 10. 配置阿里云安全组

1. 登录阿里云控制台
2. 进入 ECS 实例
3. 配置安全组规则
4. 添加入站规则：
   - 端口范围：8001/8001
   - 协议类型：TCP
   - 授权对象：0.0.0.0/0（或你的 IP）

## 快速启动命令（如果项目在 ~/gemini-audio-service）

```bash
cd ~/gemini-audio-service
source venv/bin/activate
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &
```

## 查看日志

```bash
# 实时查看日志
tail -f /tmp/gemini-service.log

# 或查看系统日志（如果使用 systemd）
sudo journalctl -u gemini-audio.service -f
```

## 停止服务

```bash
# 如果使用 nohup
pkill -f "python3 main.py"

# 如果使用 systemd
sudo systemctl stop gemini-audio.service
```


