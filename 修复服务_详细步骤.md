# 修复服务 - 详细步骤

## 📍 命令执行位置说明

- **本地 Mac 终端**：在你的 Mac 上打开 Terminal（终端）
- **远程服务器**：通过 SSH 连接后，在服务器上执行

## 🔧 方法 1: 分步执行（推荐，更清晰）

### 步骤 1: 在本地 Mac 终端执行（上传文件）

打开 Terminal，执行：

```bash
cd ~/Desktop/AI军师/gemini-audio-service
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py
```

**说明**：
- `scp` = 安全复制文件
- `main.py` = 本地文件
- `admin@47.79.254.213:~/gemini-audio-service/main.py` = 服务器上的目标路径
- 会提示输入服务器密码

### 步骤 2: 在本地 Mac 终端执行（连接服务器）

```bash
ssh admin@47.79.254.213
```

**说明**：
- 会提示输入服务器密码
- 连接成功后，提示符会变成 `admin@iZt4netdjt0adf5p1zrsbaZ:~$`
- 此时你已经在**远程服务器**上了

### 步骤 3: 在远程服务器执行（以下命令都在服务器上）

连接成功后，在服务器上依次执行：

```bash
# 进入项目目录
cd ~/gemini-audio-service

# 激活虚拟环境
source venv/bin/activate

# 停止旧进程
pkill -f "python3 main.py"

# 等待进程停止
sleep 2

# 检查语法
python3 -m py_compile main.py

# 如果语法检查通过（无错误输出），启动服务
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &

# 等待启动
sleep 3

# 检查进程是否运行
ps aux | grep python3 | grep main.py | grep -v grep

# 测试健康检查
curl http://localhost:8001/health
```

### 步骤 4: 退出服务器（可选）

```bash
exit
```

## 🔧 方法 2: 一行命令执行（更快速）

在**本地 Mac 终端**执行（一条命令完成所有操作）：

```bash
cd ~/Desktop/AI军师/gemini-audio-service && \
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py && \
ssh admin@47.79.254.213 "cd ~/gemini-audio-service && source venv/bin/activate && pkill -f 'python3 main.py' && sleep 2 && python3 -m py_compile main.py && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl http://localhost:8001/health"
```

**说明**：
- `&&` = 前一个命令成功后才执行下一个
- `\` = 换行符，让命令更易读
- 会多次提示输入服务器密码

## 🔧 方法 3: 使用脚本（最简单）

在**本地 Mac 终端**执行：

```bash
cd ~/Desktop/AI军师/gemini-audio-service
./修复并重启服务.sh
```

**说明**：
- 脚本会自动执行所有步骤
- 会提示输入服务器密码

## ✅ 验证服务是否启动成功

在**本地 Mac 终端**执行：

```bash
curl http://47.79.254.213:8001/health
```

应该返回：
```json
{"message":"音频分析服务正在运行","status":"ok"}
```

## 📋 完整操作示例

### 示例 1: 分步执行

```bash
# ===== 在本地 Mac 终端 =====

# 1. 进入项目目录
cd ~/Desktop/AI军师/gemini-audio-service

# 2. 上传文件（会提示输入密码）
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py

# 3. 连接服务器（会提示输入密码）
ssh admin@47.79.254.213

# ===== 现在在远程服务器上 =====

# 4. 进入项目目录
cd ~/gemini-audio-service

# 5. 激活虚拟环境
source venv/bin/activate

# 6. 停止旧进程
pkill -f "python3 main.py"
sleep 2

# 7. 检查语法
python3 -m py_compile main.py

# 8. 启动服务
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &

# 9. 等待启动
sleep 3

# 10. 验证
curl http://localhost:8001/health

# 11. 退出服务器
exit

# ===== 回到本地 Mac 终端 =====

# 12. 从本地测试
curl http://47.79.254.213:8001/health
```

## ❓ 常见问题

### Q: 提示 "Permission denied"？
**A**: 检查服务器密码是否正确，或者 SSH 密钥是否配置

### Q: 提示 "command not found: scp"？
**A**: macOS 应该自带 `scp`，如果没有，可以使用 `rsync` 或手动创建文件

### Q: 如何查看服务器日志？
**A**: 
```bash
# 在本地 Mac 终端
ssh admin@47.79.254.213 "tail -50 /tmp/gemini-service.log"
```

## 🎯 推荐方法

**如果你是第一次操作**，推荐使用**方法 1（分步执行）**，这样可以看到每一步的结果，更容易排查问题。

