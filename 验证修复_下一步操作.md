# 验证修复 - 下一步操作

## ✅ 当前状态

服务已重启，健康检查正常：
```json
{"message":"音频分析服务正在运行","status":"ok"}
```

## 📋 下一步操作

### 步骤1：验证代码是否已修复

在阿里云控制台"命令助手"中执行以下命令，检查代码是否已修复：

```bash
cd /home/admin/gemini-audio-service && echo "=== 检查函数定义 ===" && grep "async def analyze_audio_async" main.py && echo "" && echo "=== 检查函数调用 ===" && grep "asyncio.create_task(analyze_audio_async" main.py
```

**期望结果：**
- 函数定义应该包含 `task_data: dict` 参数
- 函数调用应该包含 `task_data` 参数

### 步骤2：如果代码未修复，执行修复

如果步骤1显示代码还没有修复，执行以下命令：

```bash
cd /home/admin/gemini-audio-service && python3 << 'FIX'
import shutil, time
backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):' in content:
    content = content.replace('async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):', 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):')
    print("✅ 修复1: 函数定义添加task_data")

if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))' in content:
    content = content.replace('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))', 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))')
    print("✅ 修复2: 函数调用添加task_data")

if 'from fastapi import FastAPI, UploadFile, File, HTTPException' in content and 'Query' not in content:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    print("✅ 修复3: 添加Query导入")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

import py_compile
py_compile.compile('main.py', doraise=True)
print(f"✅ 修复完成！备份: {backup}")
FIX
```

然后重启服务：
```bash
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl -s http://localhost:8001/health
```

### 步骤3：测试客户端上传功能

1. **在 iOS 客户端录制一段音频并上传**
2. **观察客户端日志**，应该看到：
   - ✅ 上传成功
   - ✅ 返回 session_id
   - ❌ 不应该再出现 `missing 1 required positional argument: 'task_data'` 错误

### 步骤4：验证任务列表

上传成功后，检查任务列表接口：

```bash
curl http://47.79.254.213:8001/api/v1/tasks/sessions
```

或者在客户端刷新任务列表，应该能看到新上传的任务记录。

### 步骤5：查看服务器日志（如果还有问题）

如果上传后仍然有问题，查看服务器日志：

```bash
tail -50 /tmp/gemini-service.log
# 或者
tail -50 ~/gemini-audio-service.log
```

## 🎯 成功标志

修复成功的标志：
1. ✅ 客户端上传音频不再报错
2. ✅ 任务列表能显示新上传的任务
3. ✅ 任务状态从 "analyzing" 变为 "archived"（分析完成后）

## ⚠️ 如果还有问题

如果步骤3测试时仍然出现错误，请：
1. 复制完整的错误信息
2. 查看服务器日志的最后50行
3. 告诉我具体的错误内容

