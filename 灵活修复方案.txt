# ============================================
# 灵活修复方案 - 使用更宽松的匹配
# ============================================

cd /home/admin/gemini-audio-service && python3 << 'FIX'
import shutil, time, re

backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"✅ 备份: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 查找 tasks_storage[session_id] = task_data 的位置
storage_pos = content.find('tasks_storage[session_id] = task_data')
if storage_pos == -1:
    print("❌ 未找到 tasks_storage[session_id] = task_data")
    exit(1)

print(f"✅ 找到 tasks_storage 位置: {storage_pos}")

# 查找下一个 asyncio.create_task(analyze_audio_async 的位置
task_pos = content.find('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))', storage_pos)
if task_pos == -1:
    print("❌ 未找到 asyncio.create_task 调用")
    exit(1)

print(f"✅ 找到 asyncio.create_task 位置: {task_pos}")

# 检查这两行之间是否有文件读取代码
between_code = content[storage_pos:task_pos]
if 'file_content = await file.read()' in between_code:
    print("✅ 文件读取代码已存在，检查其他问题...")
else:
    print("❌ 缺少文件读取代码，开始修复...")
    
    # 找到 tasks_storage 这一行的结束位置（换行符）
    storage_line_end = content.find('\n', storage_pos) + 1
    
    # 插入代码
    insert_code = '''        # 读取文件内容并保存到临时文件（必须在异步任务之前读取，因为 UploadFile 只能读取一次）
        file_content = await file.read()
        file_filename = file.filename or "audio.m4a"
        file_ext = Path(file_filename).suffix.lower() if file_filename else '.m4a'
        
        # 创建临时文件保存文件内容
        import tempfile
        temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=file_ext)
        temp_file.write(file_content)
        temp_file.close()
        temp_file_path = temp_file.name
        
        # 异步分析（传递临时文件路径和文件名，确保所有参数都正确传递）
        logger.info(f"创建异步分析任务: session_id={session_id}, file_path={temp_file_path}, filename={file_filename}")
        
'''
    
    # 在 tasks_storage 行之后插入
    content = content[:storage_line_end] + insert_code + content[storage_line_end:]
    
    print("✅ 已插入文件读取和临时文件创建代码")

# 写入文件
with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

# 检查语法
import py_compile
py_compile.compile('main.py', doraise=True)
print("✅ 语法检查通过")
print(f"✅ 修复完成！备份: {backup}")
FIX

# 重启服务
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup ./venv/bin/python3 main.py > ~/gemini-service.log 2>&1 & sleep 3 && curl http://localhost:8001/health

