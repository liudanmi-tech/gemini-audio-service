# 测试图片生成功能

## 测试步骤

### 1. 获取一个已有的 session_id

你需要有一个已经完成音频分析的 session_id。可以通过以下方式获取：

**方式 A: 从客户端上传音频后获取**

**方式 B: 在服务器上查看最近的 session**

```bash
# 查看日志，找到最近的 session_id
tail -100 ~/gemini-audio-service.log | grep -E "session_id|任务.*分析完成" | tail -5
```

### 2. 调用策略分析接口（生成图片）

在服务器上执行：

```bash
# 替换为你的 session_id
SESSION_ID="你的session_id"

# 调用策略分析接口（这会触发图片生成）
curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/strategies" \
  -H "Content-Type: application/json" | python3 -m json.tool > response.json
```

### 3. 检查返回数据

```bash
# 检查返回的 JSON 结构
python3 -c "
import json
with open('response.json', 'r') as f:
    data = json.load(f)
    
if data.get('code') == 200:
    visual_list = data.get('data', {}).get('visual', [])
    print(f'关键时刻数量: {len(visual_list)}')
    print()
    
    for i, v in enumerate(visual_list):
        has_image = '✅' if v.get('image_base64') else '❌'
        image_size = len(v.get('image_base64', '')) if v.get('image_base64') else 0
        print(f'关键时刻 {i+1}:')
        print(f'  - transcript_index: {v.get(\"transcript_index\")}')
        print(f'  - speaker: {v.get(\"speaker\")}')
        print(f'  - emotion: {v.get(\"emotion\")}')
        print(f'  - 图片: {has_image} (Base64 大小: {image_size} 字符)')
        if image_size > 0:
            print(f'  - 图片前50字符: {v.get(\"image_base64\", \"\")[:50]}...')
        print()
else:
    print(f'❌ 请求失败: {data.get(\"message\")}')
"
```

### 4. 查看服务器日志

```bash
# 查看图片生成相关的日志
tail -100 ~/gemini-audio-service.log | grep -E "图片生成|关键时刻|image_base64|gemini-2.5-flash-image"
```

应该看到：
- "========== 开始为 X 个关键时刻生成图片 =========="
- "生成图片 1/X: ..."
- "✅ 图片生成成功，耗时: X 秒"
- "✅ 图片 Base64 编码完成，大小: X 字符"

### 5. 验证图片数据（可选）

如果返回了 `image_base64`，可以验证是否是有效的图片：

```bash
python3 -c "
import json
import base64

with open('response.json', 'r') as f:
    data = json.load(f)

visual_list = data.get('data', {}).get('visual', [])
if visual_list and visual_list[0].get('image_base64'):
    image_base64 = visual_list[0]['image_base64']
    try:
        image_bytes = base64.b64decode(image_base64)
        print(f'✅ Base64 解码成功，图片大小: {len(image_bytes)} 字节')
        
        # 检查是否是 PNG 格式（PNG 文件头）
        if image_bytes[:8] == b'\\x89PNG\\r\\n\\x1a\\n':
            print('✅ 图片格式: PNG')
        else:
            print('⚠️ 图片格式未知')
            
        # 保存第一张图片用于验证
        with open('test_image.png', 'wb') as f:
            f.write(image_bytes)
        print('✅ 图片已保存为 test_image.png')
    except Exception as e:
        print(f'❌ Base64 解码失败: {e}')
else:
    print('❌ 没有找到图片数据')
"
```

### 6. 从客户端测试（推荐）

最好的测试方式是从 iOS 客户端上传音频，然后调用策略分析接口，查看返回的数据。

## 预期结果

1. ✅ 每个关键时刻都有对应的图片（`image_base64` 不为空）
2. ✅ Base64 数据可以正确解码为 PNG 图片
3. ✅ 图片大小合理（每张约 100-500KB Base64 编码）
4. ✅ 日志显示图片生成成功

## 可能的问题

### 问题 1: image_base64 为空

**可能原因**：
- 图片生成失败
- SDK 配置问题
- 代理连接问题

**解决方法**：
- 查看日志中的错误信息
- 检查 `google-genai` SDK 是否正确安装
- 检查代理配置

### 问题 2: 图片生成很慢

**说明**：
- 每张图片生成需要 5-10 秒是正常的
- 如果有 3-5 个关键时刻，总耗时可能需要 15-50 秒

### 问题 3: SDK 导入错误

如果看到 `ImportError: cannot import name 'genai' from 'google'`：

```bash
pip3 install --upgrade google-genai
```

## 快速测试脚本

创建一个测试脚本：

```bash
cat > ~/test_image_generation.sh << 'EOF'
#!/bin/bash

echo "请输入 session_id:"
read SESSION_ID

echo ""
echo "========== 调用策略分析接口 =========="
curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/strategies" \
  -H "Content-Type: application/json" -o response.json

echo ""
echo "========== 检查返回数据 =========="
python3 -c "
import json
with open('response.json', 'r') as f:
    data = json.load(f)
    
if data.get('code') == 200:
    visual_list = data.get('data', {}).get('visual', [])
    print(f'关键时刻数量: {len(visual_list)}')
    
    for i, v in enumerate(visual_list):
        has_image = '✅' if v.get('image_base64') else '❌'
        image_size = len(v.get('image_base64', '')) if v.get('image_base64') else 0
        print(f'关键时刻 {i+1}: {has_image} (Base64 大小: {image_size} 字符)')
else:
    print(f'❌ 请求失败: {data.get(\"message\")}')
"

echo ""
echo "========== 查看日志 =========="
tail -30 ~/gemini-audio-service.log | grep -E "图片生成|关键时刻"
EOF

chmod +x ~/test_image_generation.sh
```

然后执行：

```bash
~/test_image_generation.sh
```
