# 服务器代码修复指南

由于 SSH 认证失败，请使用以下方法在阿里云控制台修复代码。

## 方法：使用阿里云控制台"命令助手"

### 步骤 1: 打开命令助手

1. 登录阿里云控制台
2. 进入轻量应用服务器
3. 找到你的服务器实例
4. 点击"命令助手"标签
5. 点击"执行命令"

### 步骤 2: 执行修复脚本

**方法 A: 使用简单修复脚本（推荐）**

复制以下完整脚本，粘贴到命令助手中执行：

```python
cd ~/gemini-audio-service && python3 << 'PYEOF'
import os, shutil, time
os.chdir(os.path.expanduser('~/gemini-audio-service'))
backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"✅ 备份: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

changes = []
# 修复 1: 添加 Query
if 'Query' not in content.split('from fastapi import')[1].split('\n')[0]:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    changes.append("添加 Query")

# 修复 2: file_filename
if 'file_filename = file.filename or' not in content:
    content = content.replace('file_filename = file.filename', 'file_filename = file.filename or "audio.m4a"')
    changes.append("修复 file_filename")

# 修复 3: 添加日志
if 'logger.info(f"创建异步分析任务:' not in content:
    content = content.replace('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))', 'logger.info(f"创建异步分析任务: session_id={session_id}, file_path={temp_file_path}, filename={file_filename}")\n        asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))')
    changes.append("添加日志")

# 修复 4: 添加验证（简单方法）
if 'logger.info(f"========== 开始异步分析音频 ==========")' not in content:
    old_try = '    try:\n        # 直接使用临时文件路径调用 analyze_audio_from_path\n        result = await analyze_audio_from_path(temp_file_path, file_filename)'
    new_try = '''    try:
        logger.info(f"========== 开始异步分析音频 ==========")
        logger.info(f"session_id: {session_id}")
        logger.info(f"temp_file_path: {temp_file_path}")
        logger.info(f"file_filename: {file_filename}")
        logger.info(f"task_data keys: {list(task_data.keys()) if task_data else 'None'}")
        
        # 验证参数
        if not task_data:
            raise ValueError("task_data 参数不能为空")
        if not session_id:
            raise ValueError("session_id 参数不能为空")
        if not temp_file_path:
            raise ValueError("temp_file_path 参数不能为空")
        
        # 直接使用临时文件路径调用 analyze_audio_from_path
        result = await analyze_audio_from_path(temp_file_path, file_filename or "audio.m4a")'''
    if old_try in content:
        content = content.replace(old_try, new_try)
        changes.append("添加验证")
    else:
        # 备用方法：只修复函数调用
        content = content.replace('await analyze_audio_from_path(temp_file_path, file_filename)', 'await analyze_audio_from_path(temp_file_path, file_filename or "audio.m4a")')
        changes.append("修复函数调用")

# 修复 5: 确保函数调用正确
if 'await analyze_audio_from_path(temp_file_path, file_filename)' in content:
    content = content.replace('await analyze_audio_from_path(temp_file_path, file_filename)', 'await analyze_audio_from_path(temp_file_path, file_filename or "audio.m4a")')
    if "修复函数调用" not in str(changes):
        changes.append("修复函数调用")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

print(f"✅ 修复完成，共 {len(changes)} 处修改")
for c in changes:
    print(f"  - {c}")

import py_compile
try:
    py_compile.compile('main.py', doraise=True)
    print("✅ 语法检查通过")
except Exception as e:
    print(f"❌ 语法错误: {e}")
    shutil.copy(backup, 'main.py')
    raise
print(f"✅ 修复成功！备份: {backup}")
PYEOF
```

**方法 B: 使用文件修复脚本（如果方法 A 失败）**

如果上面的脚本执行失败，可以使用项目中的 `服务器修复脚本_简单版.py` 文件内容。
import os
import shutil
import re
import time

# 备份原文件
backup_file = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup_file)
print(f"✅ 已备份: {backup_file}")

# 读取文件
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

changes = []

# 修复 1: 添加 Query 导入
if 'Query' not in content.split('from fastapi import')[1].split('\n')[0]:
    content = content.replace(
        'from fastapi import FastAPI, UploadFile, File, HTTPException',
        'from fastapi import FastAPI, UploadFile, File, HTTPException, Query'
    )
    changes.append("添加 Query 导入")

# 修复 2: 修复 file_filename
if 'file_filename = file.filename or' not in content:
    content = content.replace(
        'file_filename = file.filename',
        'file_filename = file.filename or "audio.m4a"'
    )
    changes.append("修复 file_filename")

# 修复 3: 添加日志
if 'logger.info(f"创建异步分析任务:' not in content:
    content = re.sub(
        r'(asyncio\.create_task\(analyze_audio_async\(session_id, temp_file_path, file_filename, task_data\)\))',
        r'logger.info(f"创建异步分析任务: session_id={session_id}, file_path={temp_file_path}, filename={file_filename}")\n        \1',
        content
    )
    changes.append("添加日志")

# 修复 4: 在 analyze_audio_async 中添加验证
if 'logger.info(f"========== 开始异步分析音频 ==========")' not in content:
    # 查找并替换
    old_pattern = r'(async def analyze_audio_async\(session_id: str, temp_file_path: str, file_filename: str, task_data: dict\):.*?from datetime import datetime.*?try:)'
    new_code = r'\1\n        logger.info(f"========== 开始异步分析音频 ==========")\n        logger.info(f"session_id: {session_id}")\n        logger.info(f"temp_file_path: {temp_file_path}")\n        logger.info(f"file_filename: {file_filename}")\n        logger.info(f"task_data keys: {list(task_data.keys()) if task_data else \'None\'}")\n        \n        # 验证参数\n        if not task_data:\n            raise ValueError("task_data 参数不能为空")\n        if not session_id:\n            raise ValueError("session_id 参数不能为空")\n        if not temp_file_path:\n            raise ValueError("temp_file_path 参数不能为空")\n        \n        '
    content = re.sub(old_pattern, new_code, content, flags=re.DOTALL)
    changes.append("添加参数验证")

# 修复 5: 修复 analyze_audio_from_path 调用
content = content.replace(
    'await analyze_audio_from_path(temp_file_path, file_filename)',
    'await analyze_audio_from_path(temp_file_path, file_filename or "audio.m4a")'
)
changes.append("修复函数调用")

# 写入文件
with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

print(f"✅ 修复完成，共 {len(changes)} 处修改")
for c in changes:
    print(f"  - {c}")

# 检查语法
import py_compile
try:
    py_compile.compile('main.py', doraise=True)
    print("✅ 语法检查通过")
except Exception as e:
    print(f"❌ 语法错误: {e}")
    shutil.copy(backup_file, 'main.py')
    raise

print(f"\n✅ 修复成功！备份: {backup_file}")
PYEOF
```

### 步骤 3: 重启服务

修复完成后，执行以下命令重启服务：

```bash
cd ~/gemini-audio-service
pkill -f "python3 main.py"
sleep 2
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &
sleep 3
curl http://localhost:8001/health
tail -20 /tmp/gemini-service.log
```

### 步骤 4: 验证修复

检查服务是否正常运行：

```bash
curl http://localhost:8001/health
```

如果返回 `{"message":"音频分析服务正在运行","status":"ok"}` 说明服务正常。

## 修复内容说明

本次修复解决了以下问题：

1. **添加 Query 导入** - 修复了 `get_task_list` 函数中缺少 `Query` 导入的问题
2. **修复 file_filename** - 确保 `file_filename` 不为 `None`
3. **添加日志记录** - 在创建异步任务时添加详细日志
4. **添加参数验证** - 在 `analyze_audio_async` 函数中添加参数验证，确保所有必需参数都存在
5. **修复函数调用** - 确保 `analyze_audio_from_path` 调用时使用正确的参数

修复后，客户端上传音频时应该能够正常创建任务记录。

