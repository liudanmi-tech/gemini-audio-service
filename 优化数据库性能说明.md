# 数据库性能优化说明

## 问题分析

数据保存在RDS后保存很慢的主要原因：

1. **RDS网络延迟**：每次数据库操作都需要网络往返，RDS在阿里云上，可能有网络延迟
2. **不必要的数据库查询**：更新和创建操作后使用了`db.refresh()`，会额外查询一次数据库
3. **连接池配置不够优化**：连接池大小和连接复用策略可以改进

## 优化措施

### 1. 优化连接池配置 (`database/connection.py`)

- **增加连接池大小**：`pool_size` 从 10 增加到 20
- **增加溢出连接数**：`max_overflow` 从 20 增加到 30
- **添加连接回收时间**：`pool_recycle=3600` 秒，避免连接过期
- **添加TCP keepalive设置**：减少连接断开，提高连接稳定性
  - `tcp_keepalives_idle`: 600秒
  - `tcp_keepalives_interval`: 30秒
  - `tcp_keepalives_count`: 3次

### 2. 移除不必要的数据库查询 (`api/profiles.py`)

- **移除`db.refresh()`调用**：
  - 更新档案时：对象已经更新，不需要再次查询
  - 创建档案时：`created_at`和`updated_at`由数据库自动生成，但对象中已有值

这样可以减少每次保存操作的数据库往返次数，从2次减少到1次。

### 3. 性能提升预期

- **减少数据库往返**：每次保存操作减少1次数据库查询
- **提高连接复用**：更大的连接池和keepalive设置减少连接建立开销
- **预期提升**：保存速度应该提升30-50%

## 部署步骤

1. 上传更新后的文件到服务器：
```bash
scp database/connection.py admin@47.79.254.213:~/gemini-audio-service/database/
scp api/profiles.py admin@47.79.254.213:~/gemini-audio-service/api/
```

2. 重启服务：
```bash
ssh admin@47.79.254.213
cd ~/gemini-audio-service
pkill -f "python3 main.py"
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
```

## 注意事项

- 连接池大小增加会占用更多数据库连接，确保RDS的最大连接数足够
- 如果RDS连接数有限制，可以适当调整`pool_size`和`max_overflow`
- 监控数据库连接数，避免连接数过多导致问题
