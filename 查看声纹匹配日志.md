# 查看声纹匹配日志与诊断

当任务详情里「对话总结」仍显示 Speaker_0 / Speaker_1 而非档案名时，可按下面步骤在服务器上排查。

## 1. 查服务端日志（是否执行了声纹流程）

在服务器上查看应用日志（根据实际部署方式选一种）：

```bash
# 若用 systemd
journalctl -u your-service-name -n 2000 --no-pager | grep -E "声纹|speaker_mapping|0e63e91d-56c3-4599-935c-d892dd89348f"

# 若用 gunicorn/uvicorn 且日志重定向到文件
grep -E "\[声纹\]|speaker_mapping|0e63e91d-56c3-4599-935c-d892dd89348f" /path/to/your/app.log
```

关注这些日志含义：

| 日志内容 | 含义 |
|---------|------|
| `[声纹] session_id=xxx transcript_len=... has_audio=...` | 是否进入声纹流程、是否有 transcript、是否有原音频 |
| `[声纹] session_id=xxx 无 transcript，跳过声纹匹配` | 第一次 Gemini 未返回 transcript，不会做声纹 |
| `[声纹] session_id=xxx 无原音频 URL/路径，跳过声纹匹配` | 该任务未保存原音频（如旧任务或持久化失败） |
| `[声纹] session_id=xxx 本地音频 local_path=... profile_count=...` | 是否拿到本地音频、当前用户档案数量 |
| `[声纹] session_id=xxx 当前用户无档案，跳过声纹匹配` | 该用户下没有档案，无法做说话人→档案映射 |
| `声纹匹配: Speaker_0 -> profile_id=xxx confidence=...` | 某说话人与档案匹配成功（来自 voiceprint_service） |
| `[声纹] session_id=xxx speaker_mapping 已写入: {...}` | 映射已写入 DB |
| `[声纹] session_id=xxx speaker_mapping 为空，未写入` | 没有匹配到任何档案 |

## 2. 查数据库（该任务是否已有映射）

在服务器上执行诊断脚本（需能连到同一 PostgreSQL）：

```bash
cd /path/to/gemini-audio-service
export DATABASE_URL="postgresql+asyncpg://用户:密码@主机:5432/库名"
python3 check_speaker_mapping.py 0e63e91d-56c3-4599-935c-d892dd89348f
```

脚本会输出：

- **Session**：`audio_url`、`audio_path` 是否有值（无则声纹流程会跳过）
- **AnalysisResult**：`speaker_mapping`、`conversation_summary` 是否已有
- 若有 `speaker_mapping`，会解析并打印「说话人 -> 档案名」

若 `audio_url`/`audio_path` 为空，说明该任务分析时未保存原音频（例如是部署新代码之前就分析完的旧任务），需要**重新上传并分析**该录音，新分析才会跑声纹并写入映射。

## 3. 常见原因小结

- **该任务是旧任务**：在加「原音频持久化 + 声纹」之前就分析完了，DB 里没有 `audio_url`/`audio_path`，也不会写 `speaker_mapping`。解决：重新上传该录音并再分析一次。
- **当前用户下没有档案**：声纹占位实现需要至少一个档案才会写入映射。解决：先为该用户创建至少一个档案，再重新分析或等后续支持「分析后补跑声纹」。
- **原音频下载/本地路径失败**：若用 OSS，可能下载失败；若用本地路径，可能文件已被删。解决：看日志里 `本地音频 local_path=False` 或 `无法获取本地音频`，检查 OSS/本地存储配置与文件是否存在。

完成上述检查后，把日志片段或 `check_speaker_mapping.py` 的输出贴出来，可以进一步精确定位问题。
