# ============================================
# 修复函数调用 - 简单版（直接复制执行）
# ============================================

cd /home/admin/gemini-audio-service && python3 << 'FIX'
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 检查并修复
if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
    # 直接替换
    content = content.replace(
        'asyncio.create_task(analyze_audio_async(session_id, file, task_data))',
        'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'
    )
    print("✅ 修复函数调用：从 (session_id, file, task_data) 改为 (session_id, temp_file_path, file_filename, task_data)")
    
    with open('main.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    import py_compile
    py_compile.compile('main.py', doraise=True)
    print("✅ 修复完成，需要重启服务")
else:
    print("✅ 函数调用已经是正确版本，无需修改")
FIX

# 重启服务
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && echo "✅ 服务已重启" && curl -s http://localhost:8001/health

