# 数据库设置指南

> **注意**：本指南提供两种部署方式：
> 1. **在应用服务器上安装PostgreSQL**（适合小规模应用，零额外成本）
> 2. **使用阿里云RDS PostgreSQL**（推荐生产环境，更专业稳定）
> 
> 如果选择RDS，请参考 `阿里云RDS设置指南.md`

## 方式一：在应用服务器上安装PostgreSQL

## 一、安装PostgreSQL

### macOS
```bash
brew install postgresql@14
brew services start postgresql@14
```

### Ubuntu/Debian
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### CentOS/RHEL
```bash
sudo yum install postgresql-server postgresql-contrib
sudo postgresql-setup initdb
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

## 二、创建数据库和用户

```bash
# 切换到postgres用户
sudo -u postgres psql

# 在PostgreSQL命令行中执行：
CREATE DATABASE gemini_audio_db;
CREATE USER gemini_user WITH PASSWORD 'your_password_here';
GRANT ALL PRIVILEGES ON DATABASE gemini_audio_db TO gemini_user;

# 退出
\q
```

## 三、配置环境变量

在 `.env` 文件中添加或更新以下配置：

```env
# 数据库配置
DATABASE_URL=postgresql+asyncpg://gemini_user:your_password_here@localhost:5432/gemini_audio_db

# JWT配置
JWT_SECRET_KEY=your-secret-key-here-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# 验证码配置（开发阶段）
VERIFICATION_CODE_MOCK=true
VERIFICATION_CODE_MOCK_VALUE=123456
VERIFICATION_CODE_EXPIRY_MINUTES=5
```

## 四、初始化数据库表

有两种方式初始化数据库表：

### 方式1：使用SQL脚本（推荐）

```bash
psql -U gemini_user -d gemini_audio_db -f database/migrations/init_tables.sql
```

### 方式2：使用Python脚本

```bash
python3 database/migrations/init_db.py
```

### 方式3：自动初始化（应用启动时）

应用启动时会自动创建表（如果不存在）。

## 五、安装Python依赖

```bash
pip install -r requirements.txt
```

## 六、启动服务

```bash
python3 main.py
```

服务启动后会自动：
1. 初始化数据库连接
2. 创建表（如果不存在）
3. 启动FastAPI服务

## 七、测试认证接口

### 1. 发送验证码
```bash
curl -X POST "http://localhost:8001/api/v1/auth/send-code" \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000"}'
```

### 2. 登录（开发阶段使用固定验证码123456）
```bash
curl -X POST "http://localhost:8001/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000", "code": "123456"}'
```

响应示例：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGc...",
    "user_id": "uuid",
    "expires_in": 86400
  }
}
```

### 3. 使用Token访问受保护的接口

```bash
TOKEN="your_token_here"

# 上传音频
curl -X POST "http://localhost:8001/api/v1/audio/upload" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@audio.m4a"

# 获取任务列表
curl -X GET "http://localhost:8001/api/v1/tasks/sessions" \
  -H "Authorization: Bearer $TOKEN"
```

## 八、常见问题

### 1. 数据库连接失败

检查：
- PostgreSQL服务是否运行：`sudo systemctl status postgresql`
- 数据库URL是否正确
- 用户权限是否正确

### 2. 表已存在错误

如果表已存在，可以：
- 删除旧表：`DROP TABLE IF EXISTS ...`
- 或使用迁移工具更新表结构

### 3. 认证失败

检查：
- JWT_SECRET_KEY是否设置
- Token是否过期
- Token格式是否正确（Bearer {token}）

## 方式二：使用阿里云RDS PostgreSQL（推荐）

请参考 `阿里云RDS设置指南.md` 获取详细的RDS配置步骤。

### 快速步骤：
1. 在阿里云控制台创建RDS PostgreSQL实例
2. 配置白名单（添加应用服务器IP）
3. 创建数据库和账号
4. 更新 `.env` 文件中的 `DATABASE_URL`（使用RDS内网地址）
5. 初始化数据库表

## 九、生产环境注意事项

1. **修改JWT密钥**：使用强随机密钥
2. **修改数据库密码**：使用强密码
3. **启用真实短信服务**：设置 `VERIFICATION_CODE_MOCK=false`
4. **配置HTTPS**：使用反向代理（如Nginx）配置SSL
5. **数据库备份**：定期备份数据库
6. **监控和日志**：配置日志收集和监控系统
