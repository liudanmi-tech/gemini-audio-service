# æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆ - ä½¿ç”¨ç°æœ‰é˜¿é‡Œäº‘æœåŠ¡å™¨

## ğŸ¯ ç­”æ¡ˆï¼šå¯ä»¥ä½¿ç”¨åŒä¸€å°æœåŠ¡å™¨ï¼

**ç»“è®º**ï¼šä½ å¯ä»¥åœ¨**åŒä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨**ï¼ˆ47.79.254.213ï¼‰ä¸Šè¿è¡Œ FastAPI åç«¯æœåŠ¡ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸éœ€è¦é¢å¤–æœåŠ¡å™¨ï¼ŒèŠ‚çœæˆæœ¬
- âœ… ç½‘ç»œå»¶è¿Ÿæ›´ä½ï¼ˆåç«¯å’Œ Gemini ä»£ç†åœ¨åŒä¸€å°æœåŠ¡å™¨ï¼‰
- âœ… é…ç½®æ›´ç®€å•
- âœ… ç»´æŠ¤æ›´æ–¹ä¾¿

---

## ğŸ“‹ å½“å‰æ¶æ„

### ç°çŠ¶ï¼š
```
iOS å®¢æˆ·ç«¯ â†’ é˜¿é‡Œäº‘æœåŠ¡å™¨ (47.79.254.213)
                â†“
            Nginx (åå‘ä»£ç†)
                â†“
            Google Gemini API
```

### ç›®æ ‡æ¶æ„ï¼š
```
iOS å®¢æˆ·ç«¯ â†’ é˜¿é‡Œäº‘æœåŠ¡å™¨ (47.79.254.213)
                â†“
            Nginx (API Gateway)
                â”œâ”€â†’ FastAPI åç«¯æœåŠ¡ (ç«¯å£ 8001)
                â””â”€â†’ Google Gemini API (åå‘ä»£ç†)
```

---

## ğŸ—ï¸ éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

åœ¨åŒä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šï¼š
1. **è¿è¡Œ FastAPI åç«¯æœåŠ¡**ï¼ˆç«¯å£ 8001ï¼‰
2. **Nginx åŒæ—¶ä½œä¸º**ï¼š
   - API Gatewayï¼šæ¥æ”¶ iOS å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè½¬å‘åˆ° FastAPI
   - åå‘ä»£ç†ï¼šè½¬å‘ Gemini API è¯·æ±‚

---

## ğŸ“ è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½² FastAPI åç«¯

#### 1.1 è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh admin@47.79.254.213
```

#### 1.2 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/work-survival-backend
cd /opt/work-survival-backend
```

#### 1.3 ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

å°†ä»¥ä¸‹æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š
- `main.py`
- `requirements.txt`
- `.env`ï¼ˆåŒ…å« GEMINI_API_KEYï¼‰

**ä¸Šä¼ æ–¹æ³•**ï¼š
```bash
# åœ¨æœ¬åœ° Mac ä¸Šæ‰§è¡Œ
scp main.py requirements.txt admin@47.79.254.213:/opt/work-survival-backend/
scp .env admin@47.79.254.213:/opt/work-survival-backend/
```

#### 1.4 å®‰è£… Python å’Œä¾èµ–

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
# å®‰è£… Python 3.14ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
sudo apt update
sudo apt install python3.14 python3.14-venv python3-pip -y

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.14 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

#### 1.5 é…ç½®ç¯å¢ƒå˜é‡

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

ç¡®ä¿ `.env` æ–‡ä»¶åŒ…å«ï¼š
```
GEMINI_API_KEY=AIzaSyCiOOgxgMkTuqw6sXTT08WbD7R6kMK-k08
PROXY_URL=http://47.79.254.213/secret-channel
USE_PROXY=true
```

#### 1.6 æµ‹è¯•è¿è¡Œ

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# è¿è¡ŒæœåŠ¡ï¼ˆæµ‹è¯•ï¼‰
python3 main.py
```

å¦‚æœè¿è¡ŒæˆåŠŸï¼Œåº”è¯¥èƒ½çœ‹åˆ°æœåŠ¡å¯åŠ¨åœ¨ `http://0.0.0.0:8001`

---

### æ­¥éª¤ 2: é…ç½® Nginx ä½œä¸º API Gateway

#### 2.1 ç¼–è¾‘ Nginx é…ç½®

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
sudo nano /etc/nginx/sites-available/default
```

#### 2.2 æ·»åŠ  FastAPI åç«¯ä»£ç†é…ç½®

åœ¨ç°æœ‰çš„ Nginx é…ç½®ä¸­ï¼Œ**æ·»åŠ **ä»¥ä¸‹é…ç½®ï¼ˆä¸è¦åˆ é™¤ç°æœ‰çš„ `/secret-channel` é…ç½®ï¼‰ï¼š

```nginx
# FastAPI åç«¯æœåŠ¡ä»£ç†ï¼ˆæ–°å¢ï¼‰
location /api/ {
    proxy_pass http://127.0.0.1:8001/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ 
    client_max_body_size 100M;
    client_body_buffer_size 128k;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    
    # ç¦ç”¨ç¼“å†²ï¼ˆç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼‰
    proxy_buffering off;
    proxy_request_buffering off;
}

# Gemini API åå‘ä»£ç†ï¼ˆä¿æŒç°æœ‰é…ç½®ï¼‰
location /secret-channel {
    rewrite ^/secret-channel(.*) $1 break;
    proxy_pass https://generativelanguage.googleapis.com;
    proxy_set_header Host generativelanguage.googleapis.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    client_max_body_size 100M;
    proxy_read_timeout 600s;
}

location /upload {
    proxy_pass https://generativelanguage.googleapis.com;
    proxy_set_header Host generativelanguage.googleapis.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    client_max_body_size 100M;
    proxy_read_timeout 600s;
}
```

#### 2.3 æµ‹è¯• Nginx é…ç½®

```bash
# æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
sudo nginx -t
```

å¦‚æœæ˜¾ç¤º `syntax is ok` å’Œ `test is successful`ï¼Œè¯´æ˜é…ç½®æ­£ç¡®ã€‚

#### 2.4 é‡æ–°åŠ è½½ Nginx

```bash
# é‡æ–°åŠ è½½ Nginx é…ç½®
sudo systemctl reload nginx
```

---

### æ­¥éª¤ 3: é…ç½® FastAPI æœåŠ¡è‡ªåŠ¨å¯åŠ¨

#### 3.1 åˆ›å»º systemd æœåŠ¡æ–‡ä»¶

```bash
sudo nano /etc/systemd/system/work-survival-backend.service
```

#### 3.2 æ·»åŠ æœåŠ¡é…ç½®

```ini
[Unit]
Description=Work Survival Guide Backend API
After=network.target

[Service]
Type=simple
User=admin
WorkingDirectory=/opt/work-survival-backend
Environment="PATH=/opt/work-survival-backend/venv/bin"
ExecStart=/opt/work-survival-backend/venv/bin/python3 main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 3.3 å¯åŠ¨æœåŠ¡

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start work-survival-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable work-survival-backend

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status work-survival-backend
```

---

### æ­¥éª¤ 4: é…ç½®é˜²ç«å¢™

```bash
# ç¡®ä¿ 80 ç«¯å£ï¼ˆHTTPï¼‰å’Œ 443 ç«¯å£ï¼ˆHTTPSï¼Œå¦‚æœé…ç½®äº† SSLï¼‰å·²å¼€æ”¾
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status
```

---

## ğŸ”§ ä¿®æ”¹ iOS å®¢æˆ·ç«¯ API åœ°å€

### åœ¨ NetworkManager.swift ä¸­ä¿®æ”¹

1. **æ‰“å¼€ `Services/NetworkManager.swift`**

2. **æ‰¾åˆ° `baseURL` è¿™ä¸€è¡Œ**ï¼ˆå¤§çº¦ç¬¬ 17 è¡Œï¼‰

3. **ä¿®æ”¹ä¸º**ï¼š
   ```swift
   private let baseURL = "http://47.79.254.213/api/v1"
   ```
   æˆ–è€…å¦‚æœé…ç½®äº† HTTPSï¼š
   ```swift
   private let baseURL = "https://47.79.254.213/api/v1"
   ```

4. **ä¿å­˜æ–‡ä»¶**

---

## ğŸ“Š æœ€ç»ˆæ¶æ„

```
iOS å®¢æˆ·ç«¯
    â†“
    http://47.79.254.213/api/v1/...
    â†“
é˜¿é‡Œäº‘æœåŠ¡å™¨ (47.79.254.213)
    â†“
Nginx (ç«¯å£ 80)
    â”œâ”€â†’ /api/ â†’ FastAPI åç«¯ (127.0.0.1:8001)
    â”‚       â†“
    â”‚   FastAPI è°ƒç”¨ Gemini API
    â”‚       â†“
    â””â”€â†’ /secret-channel â†’ Google Gemini API (åå‘ä»£ç†)
```

---

## âœ… éªŒè¯éƒ¨ç½²

### 1. æµ‹è¯•åç«¯æœåŠ¡

åœ¨æœåŠ¡å™¨ä¸Šï¼š
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
sudo systemctl status work-survival-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u work-survival-backend -f
```

### 2. æµ‹è¯• API æ¥å£

åœ¨æœ¬åœ° Mac ä¸Šï¼š
```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://47.79.254.213/api/v1/health

# åº”è¯¥è¿”å›ï¼š
# {"message":"éŸ³é¢‘åˆ†ææœåŠ¡æ­£åœ¨è¿è¡Œ","status":"ok"}
```

### 3. æµ‹è¯• iOS å®¢æˆ·ç«¯

åœ¨ iOS å®¢æˆ·ç«¯ä¸­ï¼š
- ä¿®æ”¹ `NetworkManager.swift` ä¸­çš„ `baseURL` ä¸º `http://47.79.254.213/api/v1`
- è¿è¡Œé¡¹ç›®
- æµ‹è¯•ä¸Šä¼ éŸ³é¢‘åŠŸèƒ½

---

## ğŸ”’ å®‰å…¨å»ºè®®ï¼ˆå¯é€‰ï¼‰

### é…ç½® HTTPSï¼ˆæ¨èï¼‰

1. **å®‰è£… Certbot**ï¼š
   ```bash
   sudo apt install certbot python3-certbot-nginx -y
   ```

2. **ç”³è¯· SSL è¯ä¹¦**ï¼š
   ```bash
   sudo certbot --nginx -d your-domain.com
   ```

3. **ä¿®æ”¹ iOS å®¢æˆ·ç«¯**ï¼š
   ```swift
   private let baseURL = "https://your-domain.com/api/v1"
   ```

---

## ğŸ“ æ€»ç»“

### âœ… å¯ä»¥ä½¿ç”¨åŒä¸€å°æœåŠ¡å™¨

**ä¼˜åŠ¿**ï¼š
- èŠ‚çœæˆæœ¬ï¼ˆä¸éœ€è¦é¢å¤–æœåŠ¡å™¨ï¼‰
- é…ç½®ç®€å•ï¼ˆNginx åŒæ—¶å¤„ç†ä¸¤ä¸ªåŠŸèƒ½ï¼‰
- æ€§èƒ½æ›´å¥½ï¼ˆåç«¯å’Œä»£ç†åœ¨åŒä¸€å°æœåŠ¡å™¨ï¼‰

**éœ€è¦åšçš„**ï¼š
1. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½² FastAPI åç«¯
2. é…ç½® Nginx åŒæ—¶ä½œä¸º API Gateway å’Œåå‘ä»£ç†
3. ä¿®æ”¹ iOS å®¢æˆ·ç«¯çš„ API åœ°å€

**ä¸éœ€è¦åšçš„**ï¼š
- âŒ ä¸éœ€è¦è´­ä¹°æ–°æœåŠ¡å™¨
- âŒ ä¸éœ€è¦æ­å»ºæ–°çš„ Nginx

---

## ğŸ†˜ å¦‚æœé‡åˆ°é—®é¢˜

### é—®é¢˜ 1: ç«¯å£å†²çª

å¦‚æœ 8001 ç«¯å£è¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ï¼š
- `main.py` ä¸­çš„ç«¯å£å·
- Nginx é…ç½®ä¸­çš„ `proxy_pass` åœ°å€

### é—®é¢˜ 2: æœåŠ¡æ— æ³•å¯åŠ¨

æ£€æŸ¥ï¼š
- Python ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®
- ä¾èµ–æ˜¯å¦å®‰è£…å®Œæ•´
- `.env` æ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®

### é—®é¢˜ 3: Nginx é…ç½®é”™è¯¯

æ£€æŸ¥ï¼š
- `sudo nginx -t` æµ‹è¯•é…ç½®
- æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`

---

**ç°åœ¨ä½ å¯ä»¥åœ¨åŒä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²åç«¯æœåŠ¡äº†ï¼**

éœ€è¦æˆ‘å¸®ä½ ç”Ÿæˆå…·ä½“çš„éƒ¨ç½²è„šæœ¬å—ï¼Ÿ

