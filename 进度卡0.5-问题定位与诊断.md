# 进度卡在 0.5（正在分析对话…）问题定位

## 结论

**是的，这是 Gemini 相关的问题**，具体是 **Gemini Files API（`genai.upload_file`）** 在上传音频文件时失败或挂起，导致分析流程无法进入后续阶段。

---

## 流程与卡点

### 分析各阶段对应关系

| analysis_stage | progress | 客户端展示           | 实际在做的事            |
|----------------|----------|----------------------|-------------------------|
| oss_upload     | 0.15     | 正在上传到云端…      | 上传原音频到 OSS        |
| gemini_analysis| **0.5**  | **正在分析对话…**     | 上传到 Gemini + 调用模型 |
| voiceprint     | 0.9      | 声纹匹配中           | 声纹识别                |
| (完成)         | 1.0      | 已完成               | -                       |

### 卡住位置

- 轮询返回 `progress: 0.5`、`stage: 正在分析对话…` 表示 `analysis_stage = "gemini_analysis"`
- 该阶段在 OSS 上传完成后立即被设置（`main.py` 约 1297 行）
- 随后在 **`genai.upload_file()`** 处阻塞或失败，导致分析永远不完成

```
OSS 上传完成 → analysis_stage = "gemini_analysis" → genai.upload_file() 卡住/失败
```

---

## 根因：Gemini 文件上传失败

### 1. TypeError: string indices must be integers

- **出现时机**：`resumable=True`（分片上传）时，约 1 秒内
- **原因**：代理或 Gemini 返回了非 JSON 响应（如 HTML 502 错误页），SDK 解析时按 dict 处理字符串，触发 `TypeError`

### 2. resumable=False 挂起

- **现象**：`resumable=True` 失败后，自动切换为 `resumable=False`，之后无任何日志
- **可能原因**：
  - 直连（NO_PROXY）时，Files API 端点连接挂起（超时逻辑未如期触发）
  - 或代理对 Files API 的请求处理异常

### 3. 与 list_models / generate_content 的差异

- `list_models`、`generate_content` 能成功，说明 **常规 Gemini API 可达**
- Files API 使用不同的 discovery 文档和上传端点（如 `generativelanguage.googleapis.com/upload/...`）
- 文件上传对网络、代理、上游响应格式更敏感

---

## 排查步骤

### 1. 在服务器上测试**文件上传**（而非仅 list_models）

```bash
cd ~/gemini-audio-service
source venv/bin/activate
python scripts/test_gemini_file_upload.py
```

（若项目中有该脚本）该脚本会真实调用 `genai.upload_file()` 上传一个小音频。

### 2. 查看服务端日志中的上传错误

```bash
tail -300 ~/gemini-audio-service.log | grep -E "upload_file|上传失败|TypeError|resumable"
```

关注是否有：
- `❌ 上传失败`
- `TypeError: string indices must be integers`
- `尝试上传（第 X/3 次，resumable=False`

### 3. 确认当前代理 / NO_PROXY 配置

```bash
grep -E "GEMINI_FILE_UPLOAD_NO_PROXY|PROXY_URL" ~/gemini-audio-service/.env
```

---

## 建议措施

### 方案 A：新加坡服务器 + 直连（NO_PROXY=true）

1. 确认 `GEMINI_FILE_UPLOAD_NO_PROXY=true` 已设置
2. 确认 `GEMINI_UPLOUT_TIMEOUT` 足够大（如 180 秒）
3. 若仍卡住，检查：
   - Files API 是否被防火墙/安全组限制
   - 是否只有 upload 端点不可达

### 方案 B：改回代理模式

1. 在 `.env` 中删除或注释 `GEMINI_FILE_UPLOAD_NO_PROXY=true`
2. 重启服务，使 `genai.upload_file` 走代理
3. 历史记录显示：**代理 + resumable=False 曾成功**（2026-02-15）

### 方案 C：尝试新 SDK 的文件上传

当前使用 `google-generativeai`（旧 SDK）。项目中已有 `google-genai`（新 SDK），可尝试：

```python
# 新 SDK 示例
from google import genai as genai_new
client = genai_new.Client(api_key=GEMINI_API_KEY)
myfile = client.files.upload(file=temp_file_path)
# 然后使用 myfile 进行 generate_content
```

新 SDK 的 Files API 实现可能与旧版不同，有机会规避当前 TypeError 或挂起问题。

---

## 总结

| 问题         | 回答                                   |
|--------------|----------------------------------------|
| 是 Gemini 的问题吗？ | **是**，具体是 Files API 上传阶段 |
| 卡在哪？     | `genai.upload_file()`（analysis_stage = gemini_analysis） |
| 可能原因     | 1. 代理返回非 JSON 导致 TypeError<br>2. 直连时 Files API 挂起或超时未生效 |
| 优先尝试     | 1. 检查/测试真实文件上传<br>2. 若直连失败，改回代理模式 |
