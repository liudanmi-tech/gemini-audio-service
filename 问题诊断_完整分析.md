# 问题诊断 - 完整分析

## 📊 当前状态梳理

### 已完成的修复
1. ✅ 函数定义已修复：`async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict)`
2. ✅ 函数调用已修复：从 `(session_id, file, task_data)` 改为 `(session_id, temp_file_path, file_filename, task_data)`

### 当前问题
- 服务无法正常启动或检查
- 不确定代码是否完全修复

## 🔍 问题定位步骤

### 第一步：检查代码完整性

需要确认服务器上的代码是否真的修复了。执行以下命令：

```bash
cd /home/admin/gemini-audio-service && python3 << 'CHECK'
print("=" * 50)
print("代码完整性检查")
print("=" * 50)

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 检查1: 函数定义
print("\n1. 检查函数定义:")
if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):' in content:
    print("   ✅ 函数定义正确")
elif 'async def analyze_audio_async(' in content:
    func_line = [line for line in content.split('\n') if 'async def analyze_audio_async(' in line][0]
    print(f"   ❌ 函数定义不正确: {func_line.strip()}")
else:
    print("   ❌ 未找到函数定义")

# 检查2: 函数调用
print("\n2. 检查函数调用:")
if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))' in content:
    print("   ✅ 函数调用正确")
elif 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
    print("   ❌ 函数调用还是旧版本: (session_id, file, task_data)")
elif 'asyncio.create_task(analyze_audio_async(' in content:
    call_line = [line for line in content.split('\n') if 'asyncio.create_task(analyze_audio_async(' in line][0]
    print(f"   ⚠️  函数调用: {call_line.strip()}")
else:
    print("   ❌ 未找到函数调用")

# 检查3: 是否有 temp_file_path 和 file_filename
print("\n3. 检查变量:")
if 'temp_file_path' in content and 'file_filename' in content:
    print("   ✅ 找到 temp_file_path 和 file_filename 变量")
else:
    print("   ❌ 缺少必要的变量")

# 检查4: 语法检查
print("\n4. 语法检查:")
try:
    import py_compile
    py_compile.compile('main.py', doraise=True)
    print("   ✅ 语法正确")
except Exception as e:
    print(f"   ❌ 语法错误: {e}")

# 检查5: 导入检查
print("\n5. 检查导入:")
if 'from fastapi import' in content and 'Query' in content.split('from fastapi import')[1].split('\n')[0]:
    print("   ✅ Query 已导入")
else:
    print("   ⚠️  Query 可能未导入")

print("\n" + "=" * 50)
CHECK
```

### 第二步：检查服务状态

```bash
# 检查是否有 Python 进程
ps aux | grep python3 | grep main.py

# 检查端口
netstat -tlnp 2>/dev/null | grep 8001 || ss -tlnp 2>/dev/null | grep 8001

# 测试接口
curl -v http://localhost:8001/health 2>&1
```

### 第三步：尝试启动服务并查看错误

```bash
cd /home/admin/gemini-audio-service && python3 main.py 2>&1 | head -20
```

这会显示服务启动时的前20行输出，可以看到是否有错误。

## 🎯 可能的问题原因

### 问题1: 代码修复不完整
- **症状**: 函数调用还是旧版本
- **解决**: 重新执行修复命令

### 问题2: 缺少必要的变量
- **症状**: 代码中调用了 `temp_file_path` 和 `file_filename`，但这些变量不存在
- **解决**: 需要检查 `upload_audio_api` 函数是否创建了这些变量

### 问题3: 语法错误
- **症状**: 代码有语法错误，无法启动
- **解决**: 修复语法错误

### 问题4: 依赖问题
- **症状**: 缺少必要的 Python 包
- **解决**: 安装依赖

## 🔧 快速诊断命令（一键执行）

```bash
cd /home/admin/gemini-audio-service && python3 << 'DIAG'
import sys
print("Python 版本:", sys.version)
print("=" * 50)

# 检查文件
import os
if os.path.exists('main.py'):
    print("✅ main.py 存在")
    size = os.path.getsize('main.py')
    print(f"文件大小: {size} 字节")
else:
    print("❌ main.py 不存在")
    sys.exit(1)

# 检查代码
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

issues = []

# 检查函数定义
if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):' not in content:
    issues.append("函数定义不正确")

# 检查函数调用
if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))' not in content:
    if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
        issues.append("函数调用还是旧版本")
    else:
        issues.append("函数调用格式未知")

# 检查变量
if 'temp_file_path' not in content or 'file_filename' not in content:
    issues.append("缺少 temp_file_path 或 file_filename 变量")

# 语法检查
try:
    import py_compile
    py_compile.compile('main.py', doraise=True)
except Exception as e:
    issues.append(f"语法错误: {e}")

# 输出结果
if issues:
    print("❌ 发现问题:")
    for issue in issues:
        print(f"  - {issue}")
else:
    print("✅ 代码检查通过")

print("=" * 50)

# 尝试导入检查
try:
    import fastapi
    print("✅ fastapi 已安装")
except ImportError:
    print("❌ fastapi 未安装")

try:
    import google.generativeai
    print("✅ google-generativeai 已安装")
except ImportError:
    print("❌ google-generativeai 未安装")
DIAG
```

## 📝 下一步行动

1. **先执行快速诊断命令**，看看到底哪里有问题
2. **根据诊断结果**，针对性修复
3. **测试服务启动**，查看具体错误信息

