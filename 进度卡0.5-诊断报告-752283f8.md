# 进度卡 0.5 诊断报告 - session 752283f8

## 诊断结论：**Gemini 大文件上传问题**（非服务器故障）

---

## 1. 现象

- 进度停在 0.5（「正在分析对话」）
- Session: `752283f8-85ae-4d5b-8843-a7c7416dcccf`
- 文件大小：**63.94 MB** (upload_7689A532...MP3)

---

## 2. 日志分析

| 时间 | 阶段 | 说明 |
|------|------|------|
| 19:15:05 | step_async1 | 分析任务开始 |
| 19:15:08 | - | OSS 上传开始 |
| 19:15:21 | - | OSS 上传完成 ✅ |
| 19:15:24 | step_async2 | 设置 gemini_analysis（进度 0.5）|
| 19:15:27 | step3 | 开始 `genai.upload_file`（超时 180s）|
| **之后** | **无 step4** | 上传一直未返回 |

**结论**：卡在 `genai.upload_file()`，从未出现 step4（上传成功）或超时/错误日志。

---

## 3. 验证结果

| 测试项 | 结果 |
|--------|------|
| Gemini 连接（list_models）| ✅ 成功 |
| Gemini 文本生成 | ✅ 成功 |
| 小文件（1KB）upload_file | ✅ 约 2.7 秒成功 |
| OSS 上传 64MB | ✅ 成功 |
| 服务器状态 | ✅ 正常 |

**结论**：服务器和 Gemini 连接正常，问题集中在 **64MB 大文件** 的 upload_file 调用上。

---

## 4. 根因分析

- 小文件上传 2–3 秒完成，大文件（64MB）长时间无返回。
- 可能原因：
  1. **带宽/延迟**：新加坡服务器直连 Google，64MB 上传耗时长。
  2. **超时未触发**：`fut.result(timeout=180)` 在长时间阻塞 I/O 下可能未按预期抛超时。
  3. **上传仍在进行**：大文件上传实际在进行，但超过 180s 尚未完成。

---

## 5. 建议方案

### 方案 A：提高上传超时（推荐）

在服务器 `.env` 中增加超时时间：

```bash
# 在服务器执行
cd ~/gemini-audio-service
grep -q "GEMINI_UPLOAD_TIMEOUT" .env && sed -i 's/^GEMINI_UPLOAD_TIMEOUT=.*/GEMINI_UPLOAD_TIMEOUT=600/' .env || echo "GEMINI_UPLOAD_TIMEOUT=600" >> .env
# 然后重启服务
pkill -f "uvicorn main:app" 2>/dev/null; sleep 3
nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2 >> ~/gemini-audio-service.log 2>&1 &
```

将 180 秒改为 **600 秒**（10 分钟），给大文件更多上传时间。

### 方案 B：改用代理上传（可选）

若直连上传仍不稳定，可尝试走代理：

```bash
# 在 .env 中设置
GEMINI_FILE_UPLOAD_NO_PROXY=false
```

需确保 Nginx `/secret-channel` 正确转发到 Gemini，并配置 `client_max_body_size 100M` 及以上。

### 方案 C：客户端压缩/分段（长期）

- 在客户端对录音做压缩或分段上传；
- 或限制单次录音时长（如 20 分钟内），减小单文件体积。

---

## 6. 当前 session 状态

该 session 可能仍在后台等待 6 分钟总超时（19:21:27 左右）。超时后应出现「分析超时」日志，并可将 session 标记为失败。可后续在日志中确认：

```bash
grep "752283f8" ~/gemini-audio-service.log | tail -20
```
