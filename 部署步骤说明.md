# 部署步骤说明

## 命令执行位置说明

### ✅ 在本地 Mac 终端执行（已完成）

```bash
# 1. 上传代码到服务器
cd ~/Desktop/AI军师/gemini-audio-service
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py
```

**状态**: ✅ 已完成（从你的终端输出可以看到）

---

### 🔧 在服务器上执行（SSH 登录后）

以下所有命令都需要先 SSH 登录到服务器：

```bash
# 首先 SSH 登录到服务器
ssh admin@47.79.254.213
```

登录后，在服务器上执行以下步骤：

#### 步骤 1: 检查依赖（在服务器执行）

```bash
# 进入项目目录
cd ~/gemini-audio-service

# 激活虚拟环境
source venv/bin/activate

# 检查是否已安装 google-genai SDK
pip3 list | grep google-genai
```

**如果输出为空**（没有找到 google-genai），需要安装：

```bash
# 安装 google-genai SDK（在服务器执行）
pip3 install google-genai>=0.2.0
```

**如果输出类似这样**，说明已安装：
```
google-genai    0.2.0
```

#### 步骤 2: 重启服务（在服务器执行）

```bash
# 确保在项目目录
cd ~/gemini-audio-service

# 激活虚拟环境
source venv/bin/activate

# 停止旧服务
pkill -f 'python.*main.py'

# 等待 2 秒
sleep 2

# 启动新服务
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &

# 等待 3 秒
sleep 3

# 检查服务是否启动
ps aux | grep 'python.*main.py' | grep -v grep
```

**如果看到进程**，说明服务已启动：
```
admin  12345  0.5  2.1  python3 main.py
```

#### 步骤 3: 验证服务（在服务器执行）

```bash
# 测试健康检查接口
curl http://localhost:8001/health
```

**应该返回**：
```json
{"message":"音频分析服务正在运行","status":"ok"}
```

#### 步骤 4: 查看日志（在服务器执行）

```bash
# 查看最近的日志
tail -50 ~/gemini-audio-service.log

# 或者实时查看日志
tail -f ~/gemini-audio-service.log
```

---

## 完整操作流程

### 本地 Mac 终端（已完成 ✅）

```bash
cd ~/Desktop/AI军师/gemini-audio-service
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py
```

### 服务器（SSH 登录后执行）

```bash
# 1. SSH 登录
ssh admin@47.79.254.213

# 2. 进入项目目录并激活虚拟环境
cd ~/gemini-audio-service
source venv/bin/activate

# 3. 检查依赖
pip3 list | grep google-genai

# 4. 如果没有，安装依赖
pip3 install google-genai>=0.2.0

# 5. 重启服务
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
sleep 3

# 6. 检查服务状态
ps aux | grep 'python.*main.py' | grep -v grep

# 7. 验证服务
curl http://localhost:8001/health

# 8. 查看日志（如果有问题）
tail -50 ~/gemini-audio-service.log
```

---

## 快速检查脚本（在服务器执行）

你也可以创建一个检查脚本，在服务器上执行：

```bash
# 在服务器上创建脚本
cat > ~/check_and_restart.sh << 'EOF'
#!/bin/bash

cd ~/gemini-audio-service
source venv/bin/activate

echo "========== 检查依赖 =========="
if pip3 list | grep -q google-genai; then
    echo "✅ google-genai 已安装"
else
    echo "❌ google-genai 未安装，正在安装..."
    pip3 install google-genai>=0.2.0
fi

echo ""
echo "========== 重启服务 =========="
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
sleep 3

echo ""
echo "========== 检查服务状态 =========="
if ps aux | grep -q '[p]ython.*main.py'; then
    echo "✅ 服务已启动"
    curl http://localhost:8001/health
else
    echo "❌ 服务启动失败，查看日志："
    tail -30 ~/gemini-audio-service.log
fi
EOF

# 给脚本添加执行权限
chmod +x ~/check_and_restart.sh

# 执行脚本
~/check_and_restart.sh
```

---

## 总结

| 操作 | 执行位置 | 说明 |
|------|---------|------|
| 上传代码 | 本地 Mac 终端 | ✅ 已完成 |
| 检查依赖 | 服务器（SSH 后） | 需要执行 |
| 安装依赖 | 服务器（SSH 后） | 如果没有则执行 |
| 重启服务 | 服务器（SSH 后） | 需要执行 |
| 验证服务 | 服务器（SSH 后） | 需要执行 |
| 查看日志 | 服务器（SSH 后） | 如有问题则执行 |
