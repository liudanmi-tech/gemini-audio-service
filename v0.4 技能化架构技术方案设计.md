--

name: v0.4技能化架构设计

overview: 设计基于技能库的动态策略生成架构，实现场景自动识别、技能自动挂载、多技能组合执行的技术方案。

todos:

- id: design-skill-registry

content: 设计技能库数据结构和存储方案（数据库+配置文件）

status: completed

- id: design-router

content: 设计场景路由器（场景识别、技能匹配算法）

status: completed

- id: design-executor

content: 设计技能执行器（动态Prompt组装、策略生成）

status: completed

dependencies:

- design-skill-registry

- id: design-composer

content: 设计多技能组合器（结果融合、去重、排序）

status: completed

dependencies:

- design-executor

- id: design-database

content: 设计数据库表结构（skills、skill_executions）

status: completed

- id: design-api

content: 设计API接口（技能管理、场景识别、策略生成更新）

status: completed

dependencies:

- design-router

- design-executor

- id: create-document

content: 创建v0.4技术文档讨论0116.md，包含完整技术方案

status: completed

dependencies:

- design-skill-registry

- design-router

- design-executor

- design-composer

- design-database

- design-api

---

# v0.4 技能化架构技术方案设计

## 目标

从固定的Call #2提示词架构，升级为类似Claude Skills的模块化、可组合技能架构，实现根据场景自动识别并挂载对应技能。

## 核心架构

### 三层架构设计

```
┌─────────────────────────────────────────────────────────┐

│ 感知层 (Perception Layer) │

│ - 场景识别 (Scene Classification) │

│ - 上下文理解 (Context Understanding) │

│ - 上下文理解 (Context Understanding) │

└──────────────────────┬──────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────┐

│ 调度层 (Orchestration Layer) │

│ - 技能路由 (Skill Router) │

│ - 技能组合 (Skill Composition) │

│ - 优先级管理 (Priority Management) │

└──────────────────────┬──────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────┐

│ 执行层 (Execution Layer) │

│ - 技能加载 (Skill Loading) │

│ - Prompt组装 (Prompt Assembly) │

│ - 策略生成 (Strategy Generation) │

│ - 结果融合 (Result Fusion) │

└─────────────────────────────────────────────────────────┘
```

## 技术实现方案

### 1. 技能库设计 (Skill Registry) - Claude Skills格式

#### 1.1 数据结构（Claude Skills格式）

**目录结构**:

```
skills/

├── workplace_jungle/ # 职场丛林法则技能

│ ├── SKILL.md # 主文档（包含YAML frontmatter和Prompt模板）

│ ├── scripts/ # 可执行代码（可选）

│ │ ├── preprocess.py # 预处理脚本

│ │ └── postprocess.py # 后处理脚本

│ ├── references/ # 参考文档（可选）

│ │ ├── knowledge_base.md # 知识库内容

│ │ └── examples.md # 示例

│ └── assets/ # 资源文件（可选）

│ └── templates/ # 模板文件

├── family_relationship/ # 亲密关系技能

│ ├── SKILL.md

│ └── ...

├── education_communication/ # 孩子教育沟通技能

│ ├── SKILL.md

│ └── ...

└── brainstorm/ # 头脑风暴技能

├── SKILL.md

└── ...
```

**数据库表设计** (`skills` 表):

- `skill_id`: String (主键，对应目录名，如 "workplace_jungle")

- `name`: String (技能名称，从SKILL.md的frontmatter读取)

- `description`: Text (技能描述，从SKILL.md的frontmatter读取)

- `category`: String (分类：workplace/family/education/brainstorm，从frontmatter读取)

- `skill_path`: String (技能目录路径，如 "skills/workplace_jungle")

- `priority`: Integer (优先级，从frontmatter读取，数字越大优先级越高)

- `enabled`: Boolean (是否启用，从frontmatter读取)

- `version`: String (版本号，从frontmatter读取)

- `metadata`: JSONB (元数据：从SKILL.md frontmatter读取keywords、scenarios等)

- `created_at`: DateTime

- `updated_at`: DateTime

**注意**: `prompt_template` 和 `knowledge_base` 不再存储在数据库中，而是从 `SKILL.md` 文件动态读取。

#### 1.2 SKILL.md 格式示例

```markdown
---

name: workplace_jungle

description: 适用于职场沟通、上下级关系、同事协作等场景的策略分析技能

category: workplace

priority: 100

version: "1.0.0"

enabled: true

keywords:

- "老板"

- "同事"

- "项目"

- "汇报"

- "会议"

- "工作"

scenarios:

- "上下级沟通"

- "同事协作"

- "项目讨论"

dependencies:

- python>=3.12

author: AI军师团队

---



# 职场丛林法则



## 技能概述



本技能专注于职场场景的沟通分析和策略生成，适用于上下级关系、同事协作、项目讨论等职场沟通场景。



## 核心能力



1. **博弈剖析**: 洞察对话文本背后的「权力位阶」与「隐性诉求」

2. **策略研判**: 根据职场场景，自主研判3种最具破局可能性的应对路径

3. **视觉建模**: 识别关键时刻，设计火柴人绘图描述词



## Prompt模板



```prompt

角色: 你是一位精通博弈论、职场心理学与视觉修辞的深度沟通专家。



任务: 基于 Call #1 提供的对话转录音本，深入拆解双方的权力动态，并提供具备实战价值的应对策略与视觉化方案。



核心指令:

1. **博弈剖析**: 洞察对话文本背后的「权力位阶」与「隐性诉求」。

2. **自主策略研判**: **请勿使用固定分类**。请根据具体场景（如：需求加塞、情感勒索、沟通僵局），自主研判 3 种最具破局可能性的应对路径。每种策略需给出独特的 `label`（如：借力打力、柔性边界、认知对齐）。

3. **视觉建模**: 识别对话中的关键时刻（如情绪转折、冲突爆发、重要决策等），为每个关键时刻设计详细的火柴人绘图描述词。

- **关键时刻识别**: 从对话转录中识别 2-5 个关键时刻

- **构图规则**: 米色背景，极简火柴人线稿，左侧为用户，右侧为对方

- **详细要求**: 每个 `image_prompt` 必须包含：

* 说话人位置和身份标注（明确标注左侧是用户，右侧是对方）

* 说话人情绪表现（通过肢体语言、表情、姿态展现）

* 潜台词暗示（通过细微动作体现）

* 当时的情景或心理状态描述



参数定义:

- **strategies**: 数组，每个策略包含 `id`, `label`, `emoji`, `title`, `content` (Markdown格式)

- **visual**: 数组，包含 2-5 个关键时刻的视觉数据



{transcript_json}
```

## 知识库

详见 [references/knowledge_base.md](references/knowledge_base.md)

## 使用示例

详见 [references/examples.md](references/examples.md)

## 脚本支持

- `scripts/preprocess.py`: 对话预处理（提取关键信息）

- `scripts/postprocess.py`: 结果后处理（格式化和验证）

```
#### 1.3 技能加载机制



- **文件系统**: 从 `skills/{skill_id}/SKILL.md` 读取

- **数据库缓存**: 解析SKILL.md的frontmatter后缓存到数据库，支持热更新

- **Prompt提取**: 从SKILL.md的"## Prompt模板"部分提取Prompt内容

- **代码执行**: 如果存在 `scripts/` 目录，可以执行预处理/后处理脚本

- **知识库引用**: 从 `references/knowledge_base.md` 读取知识库内容（可选）



### 2. 路由器设计 (Router Agent)



#### 2.1 场景识别流程
```

输入: transcript (对话转录)

↓

场景分类模型 (Gemini-3-Flash)

↓

输出: 场景分类结果 + 置信度分数

↓

技能匹配算法

↓

输出: 匹配的技能列表 (按优先级和置信度排序)

```
#### 2.2 路由器Prompt设计



```python

router_prompt = """

你是一个场景分类专家。请分析以下对话转录，识别对话发生的场景类型。



场景类型包括：

1. workplace (职场场景): 工作相关、上下级关系、同事协作、项目讨论

2. family (家庭场景): 夫妻关系、亲子关系、家庭决策

3. education (教育场景): 孩子教育、学习辅导、成长引导

4. brainstorm (头脑风暴): 创意讨论、方案设计、问题解决

5. other (其他场景): 无法明确分类的场景



请返回JSON格式：

{

"scenes": [

{

"category": "workplace",

"confidence": 0.95,

"reasoning": "对话涉及项目汇报和截止日期讨论"

},

{

"category": "family",

"confidence": 0.3,

"reasoning": "提到了家庭安排"

}

],

"primary_scene": "workplace"

}



对话转录:

{transcript_json}

"""
```

### 3. 动态执行流程

#### 3.1 完整流程

```
1. 音频分析完成 (Call #1)

↓

2. 场景识别 (Router)

- 输入: transcript

- 输出: 场景分类结果

↓

3. 技能匹配

- 根据场景类别匹配技能

- 根据置信度筛选技能

- 支持多技能组合

↓

4. 技能加载

- 从数据库或配置文件加载技能

- 组装Prompt模板

↓

5. 策略生成 (Call #2)

- 使用技能特定的Prompt

- 生成策略分析

↓

6. 结果融合 (如果多技能)

- 合并多个技能的结果

- 去重和优先级排序

↓

7. 保存到数据库
```

#### 3.2 多技能组合策略

当识别到多个场景时：

- **策略合并**: 合并所有匹配技能的strategies数组

- **去重处理**: 基于策略内容相似度去重

- **优先级排序**: 根据技能priority和场景confidence排序

- **Visual数据**: 合并所有技能的visual数据，按时间顺序排列

### 4. API设计

#### 5.1 技能管理接口

**GET /api/v1/skills** - 获取所有可用技能

- **认证**: 需要JWT Token

- **响应**:

```json
{

"code": 200,

"message": "success",

"data": {

"skills": [

{

"skill_id": "workplace_jungle",

"name": "职场丛林法则",

"description": "适用于职场沟通、上下级关系、同事协作等场景",

"category": "workplace",

"priority": 100,

"enabled": true,

"version": "1.0.0"

}

]

}

}
```

**GET /api/v1/skills/{skill_id}** - 获取特定技能详情

- **认证**: 需要JWT Token

- **响应**: 包含技能的完整信息（不包括Prompt模板，Prompt从文件系统读取）

**POST /api/v1/skills** - 创建新技能（管理员）

- **认证**: 需要JWT Token + 管理员权限

- **请求**: 技能元数据（skill_id、name、description等）

- **功能**: 在文件系统创建技能目录和SKILL.md，并注册到数据库

**PUT /api/v1/skills/{skill_id}** - 更新技能（管理员）

- **认证**: 需要JWT Token + 管理员权限

- **功能**: 更新SKILL.md文件，并刷新数据库缓存

**POST /api/v1/skills/{skill_id}/reload** - 重新加载技能（从文件系统刷新数据库缓存）

- **认证**: 需要JWT Token

- **功能**: 重新解析SKILL.md，更新数据库中的技能元数据

#### 5.2 策略生成接口（更新）

**POST /api/v1/tasks/sessions/{session_id}/strategies** - 生成策略分析

- **认证**: 需要JWT Token

- **功能**:

- 自动场景识别（调用Router Agent）

- 自动技能匹配（根据场景类别匹配技能）

- 动态生成策略（使用匹配技能的Prompt模板）

- **请求**: 无（从session_id获取transcript）

- **响应**:

```json
{

"code": 200,

"message": "success",

"data": {

"strategies": [...],

"visual": [...],

"applied_skills": [

{"skill_id": "workplace_jungle", "priority": 100}

],

"scene_category": "workplace",

"scene_confidence": 0.95

}

}
```

#### 5.3 场景识别接口（新增）

**POST /api/v1/tasks/sessions/{session_id}/classify-scene** - 仅进行场景识别

- **认证**: 需要JWT Token

- **功能**: 仅进行场景识别，不生成策略（用于调试和预览）

- **响应**:

```json
{

"code": 200,

"message": "success",

"data": {

"scenes": [

{

"category": "workplace",

"confidence": 0.95,

"reasoning": "对话涉及项目汇报和截止日期讨论"

}

],

"primary_scene": "workplace",

"matched_skills": [

{

"skill_id": "workplace_jungle",

"name": "职场丛林法则",

"priority": 100

}

]

}

}
```

### 5. 数据库设计

#### 5.1 新增表

**skills表** (技能库):

```sql
CREATE TABLE skills (

skill_id VARCHAR(100) PRIMARY KEY, -- 直接使用skill_id作为主键（如 "workplace_jungle"）

name VARCHAR(200) NOT NULL,

description TEXT,

category VARCHAR(50) NOT NULL, -- workplace/family/education/brainstorm

skill_path VARCHAR(500) NOT NULL, -- 技能目录路径，如 "skills/workplace_jungle"

priority INTEGER DEFAULT 0,

enabled BOOLEAN DEFAULT true,

version VARCHAR(50),

metadata JSONB DEFAULT '{}',

created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()

);

CREATE INDEX idx_skills_category ON skills(category);

CREATE INDEX idx_skills_enabled ON skills(enabled);
```

**说明**: 使用 `skill_id` 作为主键，因为它是稳定的业务标识符，不会频繁变化，且其他表已使用 `skill_id` 作为外键引用。

**skill_executions表** (技能执行记录):

```sql
CREATE TABLE skill_executions (

id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,

skill_id VARCHAR(100) NOT NULL REFERENCES skills(skill_id),

scene_category VARCHAR(50), -- 识别的场景类别

confidence_score FLOAT, -- 场景识别置信度

execution_time_ms INTEGER, -- 执行耗时（毫秒）

success BOOLEAN DEFAULT true,

error_message TEXT,

created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()

);

CREATE INDEX idx_skill_executions_session_id ON skill_executions(session_id);

CREATE INDEX idx_skill_executions_skill_id ON skill_executions(skill_id);
```

#### 5.2 修改表

**strategy_analysis表** (新增字段):

```sql
ALTER TABLE strategy_analysis

ADD COLUMN applied_skills JSONB DEFAULT '[]', -- [{"skill_id": "workplace_jungle", "priority": 100}]

ADD COLUMN scene_category VARCHAR(50), -- 识别的场景类别

ADD COLUMN scene_confidence FLOAT; -- 场景识别置信度



CREATE INDEX idx_strategy_analysis_scene_category ON strategy_analysis(scene_category);
```

### 6. 实现细节

#### 6.1 代码结构

```
skills/

├── __init__.py

├── registry.py # 技能注册表管理（读取SKILL.md，缓存到数据库）

├── router.py # 场景路由器

├── executor.py # 技能执行器（执行SKILL.md中的Prompt和scripts）

├── composer.py # 多技能组合器

├── loader.py # 技能加载器（解析SKILL.md frontmatter和内容）

└── workplace_jungle/ # 技能目录（Claude Skills格式）

├── SKILL.md

├── scripts/

├── references/

└── assets/

└── family_relationship/ # 其他技能目录...

└── ...
```

#### 6.2 关键函数

**skills/router.py**:

- `classify_scene(transcript: str) -> dict`: 场景分类，调用Gemini Router Agent

- `match_skills(scene_result: dict) -> List[dict]`: 根据场景分类结果匹配技能，返回按优先级和置信度排序的技能列表

**skills/loader.py**:

- `load_skill_from_file(skill_id: str) -> dict`: 从文件系统加载SKILL.md文件

- `parse_skill_markdown(skill_path: str) -> dict`: 解析SKILL.md的frontmatter和Prompt模板

- 返回: `{"frontmatter": {...}, "prompt_template": "...", "content": "..."}`

- `extract_prompt_template(markdown_content: str) -> str`: 从SKILL.md的"## Prompt模板"部分提取Prompt内容

- `load_knowledge_base(skill_id: str) -> str`: 从`references/knowledge_base.md`读取知识库内容（可选）

**skills/registry.py**:

- `register_skill(skill_id: str) -> dict`: 注册技能到数据库（从文件系统读取并缓存）

- `get_skill(skill_id: str) -> dict`: 从数据库获取技能（如果不存在则从文件系统加载）

- `list_skills(category: str = None, enabled: bool = True) -> List[dict]`: 列出所有可用技能

- `reload_skill(skill_id: str) -> dict`: 重新加载技能（刷新数据库缓存）

**skills/executor.py**:

- `execute_skill_scripts(skill_id: str, script_name: str, input_data: dict) -> dict`: 执行技能scripts目录下的代码（预处理/后处理）

- `execute_skill(skill: dict, transcript: str, context: dict) -> dict`: 执行单个技能

- 从skill中提取prompt_template

- 替换变量（{transcript_json}等）

- 调用Gemini生成策略

- 返回策略分析结果

**skills/composer.py**:

- `compose_results(skill_results: List[dict]) -> dict`: 组合多个技能的结果

- 合并strategies数组

- 基于内容相似度去重

- 按优先级和置信度排序

- 合并visual数据，按时间顺序排列

## 实施步骤

1. **数据库迁移**: 创建skills、skill_executions表

2. **技能库初始化**:
- 创建 `skills/` 目录结构

- 为每个技能创建目录（workplace_jungle、family_relationship、education_communication、brainstorm）

- 为每个技能编写 `SKILL.md` 文件（包含YAML frontmatter和Prompt模板）

- 可选：创建 `references/` 和 `scripts/` 目录
3. **技能加载器实现**: 实现 `skills/loader.py`，解析SKILL.md的frontmatter和Prompt模板

4. **技能注册表实现**: 实现 `skills/registry.py`，从文件系统加载技能并缓存到数据库

5. **路由器实现**: 实现场景分类和技能匹配逻辑

6. **执行器实现**: 实现动态Prompt组装和策略生成（从SKILL.md提取Prompt）

7. **组合器实现**: 实现多技能结果融合

8. **API更新**: 更新策略生成接口，集成新架构

9. **测试验证**: 测试不同场景的技能匹配和执行

## 关键文件

### 后端文件

- `skills/__init__.py`: 技能模块初始化

- `skills/loader.py`: 技能加载器（解析SKILL.md）

- `skills/registry.py`: 技能注册表（数据库缓存管理）

- `skills/router.py`: 场景路由器（场景识别和技能匹配）

- `skills/executor.py`: 技能执行器（动态Prompt组装和策略生成）

- `skills/composer.py`: 多技能组合器（结果融合）

- `database/models.py`: 新增Skill、SkillExecution模型

- `main.py`: 更新策略生成逻辑，集成新架构

- `api/skills.py`: 技能管理API端点（新增）

### 技能目录结构

- `skills/workplace_jungle/SKILL.md`: 职场技能定义

- `skills/family_relationship/SKILL.md`: 家庭关系技能定义

- `skills/education_communication/SKILL.md`: 教育沟通技能定义

- `skills/brainstorm/SKILL.md`: 头脑风暴技能定义

### 数据库迁移

- `database/migrations/add_skills_tables.sql`: 创建skills、skill_executions表

- `database/migrations/update_strategy_analysis.sql`: 更新strategy_analysis表

## 技术细节补充

### Prompt模板变量替换

SKILL.md中的Prompt模板支持以下变量：

- `{transcript_json}`: 对话转录（JSON格式）

- `{session_id}`: 会话ID

- `{user_id}`: 用户ID

### 技能执行流程

1. **预处理**（可选）: 如果存在`scripts/preprocess.py`，先执行预处理脚本

2. **Prompt组装**: 从SKILL.md提取Prompt模板，替换变量

3. **知识库注入**（可选）: 如果存在`references/knowledge_base.md`，将其内容注入Prompt

4. **Gemini调用**: 使用组装的Prompt调用Gemini生成策略

5. **后处理**（可选）: 如果存在`scripts/postprocess.py`，执行后处理脚本

6. **结果返回**: 返回策略分析结果

### 多技能组合规则

当识别到多个场景时：

1. **技能选择**: 选择置信度 > 0.5 的所有场景对应的技能

2. **并行执行**: 并行执行所有匹配的技能

3. **结果合并**:
- strategies: 合并所有技能的strategies，去重（基于title和content相似度），按priority排序

- visual: 合并所有技能的visual数据，按transcript_index排序
4. **优先级**: 如果多个技能生成相同类型的策略，保留priority最高的
