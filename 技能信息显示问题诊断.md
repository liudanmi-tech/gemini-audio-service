# 技能信息显示问题诊断

## 问题描述

iOS客户端日志中没有显示：
- 命中的技能
- 技能的名称
- 技能的md文件详情

## 可能的原因

1. **服务器代码未更新**：服务器上的代码可能还是旧版本，没有v0.4技能化架构
2. **策略分析数据是旧的**：该session的策略分析是在v0.4架构部署之前生成的，数据库中没有技能信息
3. **技能信息为null**：数据库中策略分析记录的`applied_skills`、`scene_category`、`scene_confidence`字段为null

## 解决方案

### 步骤1: 更新服务器代码

执行以下命令上传最新代码到服务器：

```bash
bash update_server_code.sh
```

或者手动执行：

```bash
# 上传主文件
scp main.py admin@47.79.254.213:~/gemini-audio-service/

# 上传API文件
scp api/skills.py admin@47.79.254.213:~/gemini-audio-service/api/

# 上传skills模块
scp -r skills/ admin@47.79.254.213:~/gemini-audio-service/

# 确保安装了pyyaml
ssh admin@47.79.254.213 "cd ~/gemini-audio-service && source venv/bin/activate && pip install pyyaml>=6.0.0"
```

### 步骤2: 重启服务器

```bash
ssh admin@47.79.254.213 << 'EOF'
cd ~/gemini-audio-service
source venv/bin/activate

# 停止旧服务
pkill -f "python.*main.py"

# 等待进程停止
sleep 2

# 启动新服务
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &

# 等待启动
sleep 5

# 检查服务状态
ps aux | grep "[p]ython.*main.py"
tail -30 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|技能"
EOF
```

### 步骤3: 重新生成策略分析

**重要**：旧的策略分析数据没有技能信息，需要重新生成。

有两种方式：

#### 方式1: 删除旧数据后重新生成（推荐）

```bash
# 连接到数据库，删除该session的策略分析
ssh admin@47.79.254.213 << 'EOF'
cd ~/gemini-audio-service
source venv/bin/activate

python3 << 'PYEOF'
import asyncio
import asyncpg
import os
from dotenv import load_dotenv
from urllib.parse import urlparse

load_dotenv()

async def delete_strategy():
    database_url = os.getenv("DATABASE_URL", "")
    if "postgresql+asyncpg://" in database_url:
        database_url = database_url.replace("postgresql+asyncpg://", "postgresql://")
    
    parsed = urlparse(database_url)
    
    conn = await asyncpg.connect(
        host=parsed.hostname or 'localhost',
        port=parsed.port or 5432,
        user=parsed.username or 'postgres',
        password=parsed.password or 'postgres',
        database=parsed.path.lstrip('/') or 'gemini_audio_db'
    )
    
    session_id = "36ce0d4b-3a15-4382-9cd0-63b99397b10a"
    
    # 删除策略分析
    await conn.execute("""
        DELETE FROM strategy_analysis
        WHERE session_id = $1
    """, session_id)
    
    print(f"✅ 已删除session {session_id}的策略分析数据")
    print("现在可以在iOS客户端重新生成策略分析，将使用v0.4架构")
    
    await conn.close()

asyncio.run(delete_strategy())
PYEOF
EOF
```

#### 方式2: 在iOS客户端重新生成

在iOS客户端，进入任务详情页面，策略分析会自动重新生成（如果数据库中没有）。

### 步骤4: 验证技能信息

重新生成策略分析后，检查日志：

**服务器日志**：
```bash
ssh admin@47.79.254.213 "tail -100 ~/gemini-audio-service.log | grep -E '技能|skill|场景|applied_skills'"
```

应该看到类似这样的日志：
```
策略分析生成成功（v0.4 技能化架构）
  - 场景类别: workplace (置信度: 0.95)
  - 应用技能: 1 个
    - workplace_jungle: priority=100, confidence=0.95
```

**iOS客户端日志**：
应该看到：
```
📊 [NetworkManager] 策略分析解析结果:
   - 应用技能数量: 1
     * workplace_jungle (priority: 100, confidence: 0.95)
   - 场景类别: workplace
   - 场景置信度: 0.95
```

## 调试工具

### 测试API

使用 `test_skill_info.py` 测试API：

```bash
python3 test_skill_info.py
```

需要提供JWT Token。

### 检查数据库

```bash
ssh admin@47.79.254.213 << 'EOF'
cd ~/gemini-audio-service
source venv/bin/activate

python3 << 'PYEOF'
import asyncio
import asyncpg
import os
from dotenv import load_dotenv
from urllib.parse import urlparse

load_dotenv()

async def check():
    database_url = os.getenv("DATABASE_URL", "")
    if "postgresql+asyncpg://" in database_url:
        database_url = database_url.replace("postgresql+asyncpg://", "postgresql://")
    
    parsed = urlparse(database_url)
    
    conn = await asyncpg.connect(
        host=parsed.hostname or 'localhost',
        port=parsed.port or 5432,
        user=parsed.username or 'postgres',
        password=parsed.password or 'postgres',
        database=parsed.path.lstrip('/') or 'gemini_audio_db'
    )
    
    session_id = "36ce0d4b-3a15-4382-9cd0-63b99397b10a"
    
    result = await conn.fetchrow("""
        SELECT 
            applied_skills,
            scene_category,
            scene_confidence
        FROM strategy_analysis
        WHERE session_id = $1
    """, session_id)
    
    if result:
        print(f"✅ 找到策略分析数据")
        print(f"  applied_skills: {result['applied_skills']}")
        print(f"  scene_category: {result['scene_category']}")
        print(f"  scene_confidence: {result['scene_confidence']}")
    else:
        print(f"❌ 未找到策略分析数据")
    
    await conn.close()

asyncio.run(check())
PYEOF
EOF
```

## 预期结果

重新生成策略分析后，iOS客户端应该显示：

1. **技能信息卡片**：
   - 场景类别（如：workplace）
   - 场景置信度（如：95%）
   - 应用的技能列表（可点击查看详情）

2. **技能详情**（点击技能卡片后）：
   - 技能名称和描述
   - SKILL.md完整内容
   - Prompt模板（如果包含）

## 注意事项

1. **旧数据兼容性**：v0.4架构部署之前生成的策略分析数据没有技能信息，需要重新生成
2. **技能初始化**：服务器启动时会自动初始化所有技能到数据库
3. **日志级别**：确保日志级别包含INFO，才能看到技能相关的日志
