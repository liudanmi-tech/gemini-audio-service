# 切换到真实 API 指南

## 🎯 当前状态

✅ **已完成**：
- 后端 API 已实现（`main.py`）
- iOS 客户端代码已更新，支持真实 API
- 任务模块完整流程已实现

---

## 📋 切换步骤

### 步骤 1: 确保后端服务运行

1. **在服务器上启动后端服务**：
   ```bash
   cd /opt/work-survival-backend
   source venv/bin/activate
   python3 main.py
   ```

2. **验证服务运行**：
   - 访问：`http://47.79.254.213:8001/health`
   - 应该返回：`{"message": "音频分析服务正在运行", "status": "ok"}`

### 步骤 2: 配置 iOS 客户端 API 地址

1. **打开 `Services/NetworkManager.swift`**

2. **确认 `baseURL` 已设置为服务器地址**：
   ```swift
   private let baseURL = "http://47.79.254.213/api/v1"
   ```

3. **保存文件**

### 步骤 3: 切换到真实 API

1. **打开 `Shared/AppConfig.swift`**

2. **确保使用真实 API**：
   - 当前配置：DEBUG 模式下默认使用真实 API
   - 如果需要强制使用真实 API，可以调用：
     ```swift
     AppConfig.shared.setUseMockData(false)
     ```

3. **或者直接运行项目**：
   - 当前配置已经默认使用真实 API

---

## ✅ 功能验证

### 1. 测试任务列表

1. **运行 iOS 应用**
2. **查看任务列表**：
   - 应该从服务端获取任务列表
   - 如果列表为空，说明服务端还没有任务数据

### 2. 测试录制和上传

1. **点击录制按钮**
2. **录制一段音频**
3. **停止录制**：
   - 音频会上传到服务端
   - 任务列表中会出现新任务（状态：分析中）
   - 3 秒后，状态会更新为"已归档"

### 3. 测试任务详情

1. **点击任务卡片**
2. **查看详情页**：
   - 如果任务已归档，会自动加载详情
   - 显示对话列表和风险点

---

## 🔧 如果遇到问题

### 问题 1: 无法连接到服务端

**检查**：
- 服务端是否运行
- API 地址是否正确
- 网络是否正常

**解决**：
- 检查 `NetworkManager.swift` 中的 `baseURL`
- 测试服务端健康检查接口

### 问题 2: 上传失败

**检查**：
- 服务端日志
- 网络错误信息

**解决**：
- 查看 Xcode 控制台错误信息
- 检查服务端日志

### 问题 3: 分析状态不更新

**检查**：
- 轮询是否正常工作
- 服务端分析是否完成

**解决**：
- 查看服务端日志
- 检查任务状态接口

---

## 📊 完整流程

### 真实 API 模式流程：

1. **用户录制音频**
   - iOS 客户端录制

2. **上传到服务端**
   - `POST /api/v1/audio/upload`
   - 服务端创建任务（状态：analyzing）
   - 返回 session_id

3. **服务端异步分析**
   - 上传音频到 Gemini
   - 调用 Gemini API 分析
   - 解析分析结果
   - 更新任务状态（analyzing → archived）

4. **客户端轮询状态**
   - 每 3 秒查询一次状态
   - 状态变为 archived 后，获取详情
   - 更新任务列表

5. **展示分析结果**
   - 任务详情页显示对话列表
   - 显示风险点
   - 显示情绪分数

---

## 🎯 现在操作

1. **确保后端服务运行**
2. **运行 iOS 应用**
3. **测试录制功能**
4. **查看任务列表和详情**

---

**现在可以切换到真实 API 了！运行项目，测试完整流程。**


