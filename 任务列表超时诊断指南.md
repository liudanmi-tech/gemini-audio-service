# 任务列表超时诊断指南

## 问题现象
- 任务列表 / auth/me 请求约 90 秒后超时，响应为空

## 一、服务端增强日志（已添加）

以下文件已加入性能日志，可帮助定位卡点：

| 位置 | 日志内容 |
|------|----------|
| `auth/jwt_handler.py` | `[Auth] User 查询耗时 Xs`（>2s 时输出） |
| `main.py` | `[任务列表] 进入 handler`、`Session 查询耗时`、`完成 total=Xs` |
| 中间件 | `[Request]` / `[Response]` + duration |

## 二、诊断步骤

### 1. 部署最新代码并重启

```bash
# 本机执行
scp main.py auth/jwt_handler.py admin@47.79.254.213:~/gemini-audio-service/
# 上传 auth 子目录
scp auth/jwt_handler.py admin@47.79.254.213:~/gemini-audio-service/auth/

# SSH 重启
ssh admin@47.79.254.213 'cd ~/gemini-audio-service && pkill -f uvicorn; sleep 2; nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 >> ~/gemini-audio-service.log 2>&1 &'
```

### 2. 复现超时

在 iOS 客户端加载任务列表，等待超时发生。

### 3. 查看日志

```bash
./查看服务端日志并诊断.sh
```

输出会保存到 `服务器日志_诊断.txt`。

### 4. 根据日志判断

| 日志表现 | 可能原因 |
|----------|----------|
| 有 `[Request]` 但长时间无 `[Response]` | 请求卡在应用内 |
| `[Auth] User 查询耗时` 较大 | 数据库连接慢或 RDS 响应慢 |
| `[任务列表] Session 查询耗时` 较大 | 缺索引或 RDS 慢 |
| 完全没有 `[Request]` | 请求未到应用（Nginx/网络/防火墙） |
| Nginx `proxy_read_timeout 60s` | 需改为 120s 或更长 |

## 三、常见修复

### 1. Nginx 超时

```bash
# 服务器上执行
sudo sed -i.bak 's/proxy_read_timeout 60s/proxy_read_timeout 120s/g' /etc/nginx/sites-available/gemini-and-api
sudo nginx -t && sudo systemctl reload nginx
```

### 2. 列表索引（加速 Session 查询）

```bash
# 服务器上执行
cd ~/gemini-audio-service && python3 database/migrations/run_add_sessions_list_index.py
```

### 3. 数据库连接（RDS）

- 检查阿里云 RDS 白名单是否包含应用服务器 IP
- 检查 `DATABASE_URL`、`DATABASE_SSL`、`DATABASE_CA_CERT` 配置
