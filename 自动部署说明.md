# 自动部署说明

## 一键部署（本地 Mac 执行）

在项目根目录执行：

```bash
./自动部署.sh
```

或：

```bash
bash 自动部署.sh
```

脚本会依次完成：

1. **同步代码**：用 rsync 把当前项目（排除 .git、venv、.env、iOS/Models.swift 等）同步到服务器
2. **上传迁移与脚本**：上传 database/migrations 下的 SQL/迁移脚本和 `服务器上执行_部署并重启.sh`
3. **迁移与重启**：SSH 到服务器执行迁移（若有）、停止旧进程、启动 `python3 main.py`、打日志
4. **健康检查**：本地 curl 请求 `http://服务器:8001/health`，成功则显示「健康检查通过」

## 前置条件

- 本机已安装 **rsync**、**ssh**、**curl**
- 本机已配置到服务器的 **SSH 免密登录**（`ssh admin@你的服务器` 无需输入密码）
- 服务器上已有项目目录和 **venv**（首次部署需先在服务器上创建目录和虚拟环境）

## 配置（可选）

默认部署到 `admin@47.79.254.213`，远程目录 `~/gemini-audio-service`。

### 方式一：环境变量

```bash
export DEPLOY_SERVER="admin@你的服务器IP或域名"
export DEPLOY_REMOTE_DIR="~/gemini-audio-service"
export DEPLOY_HOST="你的服务器IP"   # 健康检查用，不设则从 DEPLOY_SERVER 解析
./自动部署.sh
```

### 方式二：配置文件

在项目根目录创建 `.deploy.env`（不要提交敏感信息到 git）：

```bash
DEPLOY_SERVER="admin@47.79.254.213"
DEPLOY_REMOTE_DIR="~/gemini-audio-service"
DEPLOY_HOST="47.79.254.213"
```

然后执行 `./自动部署.sh`，脚本会自动 source 该文件。

## 部署失败时

- **rsync 失败**：检查 SSH 免密是否生效（`ssh admin@服务器`）、本机是否安装 rsync
- **服务未启动**：SSH 登录服务器，执行 `tail -100 ~/gemini-audio-service.log` 查看错误
- **健康检查未通过**：可能是服务仍在启动（约 5 秒后再试），或端口不是 8001、防火墙未放行

## 与 deploy_to_server.sh 的关系

`自动部署.sh` 在原有 `deploy_to_server.sh` 基础上增加了：

- 通过环境变量或 `.deploy.env` 配置服务器与目录
- 部署结束后的健康检查
- 更清晰的步骤输出

逻辑与 `deploy_to_server.sh` 一致，可二选一使用；习惯用原脚本也可继续用 `./deploy_to_server.sh`。
