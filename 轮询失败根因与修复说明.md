# 录音轮询失败：根因与修复

## 一、根因定位（来自服务端日志）

| 现象 | 日志证据 |
|------|----------|
| Gemini 文件上传失败 | `TypeError: string indices must be integers, not 'str'` |
| resumable=True 失败后切换 resumable=False | 日志显示「下次重试将使用 resumable=False」 |
| 分析任务未完成、未更新 status | 无「分析音频失败」「数据库Session状态已更新为 failed」 |
| 结论 | `genai.upload_file` 卡住或代理返回 502/异常，SDK 解析出错；resumable=False 可能卡在连接等待 |

**直接原因**：代理（`/secret-channel`）转发 Gemini 文件服务时返回了 502 或非 JSON 响应，SDK 解析时抛出 TypeError；重试时连接可能长时间挂起，导致分析任务永远不结束、status 一直是 `analyzing`。

---

## 二、已实施的修复

### 1. 分析任务 6 分钟超时
- 用 `asyncio.wait_for` 包裹 `run_in_executor`，超时 360 秒
- 超时后会抛出异常，进入 `except`，更新 `status=failed`，客户端可停止轮询并提示失败

### 2. 文件上传直连选项（绕过代理）
- 新增环境变量：`GEMINI_FILE_UPLOAD_NO_PROXY=true`
- 设置为 `true` 时，文件上传阶段直连 `generativelanguage.googleapis.com`，不走代理
- **使用前提**：服务器能访问 Google（例如有 VPN/专线或在海外）

### 3. 恢复 discovery URL
- 在 `finally` 中恢复 discovery URL，避免影响同一进程中的其他请求

---

## 三、建议操作

### 方案 A：服务器能访问 Google
在 `.env` 或启动命令中添加：
```
GEMINI_FILE_UPLOAD_NO_PROXY=true
```
然后重启服务。

### 方案 B：服务器无法直连 Google
1. 检查 Nginx 中 `/secret-channel` 的配置，确保正确转发到 Gemini API
2. 如有 502，检查上游超时、请求体大小等配置
3. 当前修复仍有效：6 分钟后任务会失败，客户端会收到 `status=failed` 并显示失败原因

---

## 四、部署步骤

```bash
# 1. 上传 main.py 到服务器
scp main.py admin@47.79.254.213:~/gemini-audio-service/

# 2. （可选）如需直连，在 .env 中加一行
echo "GEMINI_FILE_UPLOAD_NO_PROXY=true" >> ~/gemini-audio-service/.env

# 3. 重启服务（Workbench 中执行）
cd ~/gemini-audio-service && pkill -f "uvicorn main:app"; sleep 3; nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4 >> ~/gemini-audio-service.log 2>&1 &
```
