# ä»»åŠ¡åˆ†æè¶…æ—¶è¯Šæ–­æŒ‡å—

## é—®é¢˜ç°è±¡

- å½•éŸ³ä¸Šä¼ æˆåŠŸ
- ä»»åŠ¡çŠ¶æ€ä¸€ç›´æ˜¾ç¤º `analyzing`
- è½®è¯¢60æ¬¡ï¼ˆ3åˆ†é’Ÿï¼‰åè¶…æ—¶

## å¯èƒ½åŸå› 

### 1. éŸ³é¢‘æ–‡ä»¶å¤ªå°ï¼ˆæœ€å¯èƒ½ï¼‰

ä»æ—¥å¿—çœ‹åˆ°ï¼š
```
ğŸ“Š [AudioRecorderService] æ–‡ä»¶å¤§å°: 28 å­—èŠ‚
```

**é—®é¢˜**ï¼š
- iOSæ¨¡æ‹Ÿå™¨æ²¡æœ‰çœŸå®çš„éº¦å…‹é£è¾“å…¥
- 28å­—èŠ‚çš„æ–‡ä»¶å¯èƒ½åªåŒ…å«å…ƒæ•°æ®ï¼Œæ²¡æœ‰å®é™…éŸ³é¢‘å†…å®¹
- Gemini APIæ— æ³•åˆ†æç©ºéŸ³é¢‘æˆ–è¿‡å°çš„æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨çœŸå®iOSè®¾å¤‡ä¸Šæµ‹è¯•å½•éŸ³åŠŸèƒ½
- æˆ–è€…ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæµ‹è¯•

### 2. åç«¯åˆ†æä»»åŠ¡å¡ä½

å¯èƒ½åŸå› ï¼š
- Gemini APIè°ƒç”¨è¶…æ—¶
- æ–‡ä»¶å¤„ç†å¤±è´¥ä½†æ²¡æœ‰æ›´æ–°çŠ¶æ€
- å¼‚æ­¥ä»»åŠ¡å¼‚å¸¸é€€å‡º

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„ä»»åŠ¡çŠ¶æ€

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# ç™»å½•è·å–Token
TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000", "code": "123456"}' | \
  python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('token', ''))")

# æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
curl -s -X GET "http://localhost:8001/api/v1/tasks/sessions/9b49e802-3614-43f2-ac8a-4f713cde3012/status" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool

# æ£€æŸ¥ä»»åŠ¡è¯¦æƒ…
curl -s -X GET "http://localhost:8001/api/v1/tasks/sessions/9b49e802-3614-43f2-ac8a-4f713cde3012" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool
```

### æ­¥éª¤2ï¼šæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
tail -100 ~/gemini-audio-service.log

# æœç´¢ç‰¹å®šsession_idçš„æ—¥å¿—
grep "9b49e802-3614-43f2-ac8a-4f713cde3012" ~/gemini-audio-service.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -E "ERROR|é”™è¯¯|Exception|Traceback" ~/gemini-audio-service.log | tail -50

# æŸ¥çœ‹åˆ†æç›¸å…³çš„æ—¥å¿—
grep -E "analyze|Gemini|åˆ†æ" ~/gemini-audio-service.log | tail -50
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­çš„ä»»åŠ¡çŠ¶æ€

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd ~/gemini-audio-service
source venv/bin/activate

python3 -c "
import sys
sys.path.insert(0, '.')
import asyncio
from database.connection import AsyncSessionLocal
from database.models import Session
from sqlalchemy import select
import uuid

async def check():
    async with AsyncSessionLocal() as session:
        session_id = uuid.UUID('9b49e802-3614-43f2-ac8a-4f713cde3012')
        result = await session.execute(
            select(Session).where(Session.id == session_id)
        )
        db_session = result.scalar_one_or_none()
        if db_session:
            print(f'ä»»åŠ¡ID: {db_session.id}')
            print(f'çŠ¶æ€: {db_session.status}')
            print(f'åˆ›å»ºæ—¶é—´: {db_session.created_at}')
            print(f'æ›´æ–°æ—¶é—´: {db_session.updated_at}')
            print(f'æ ‡é¢˜: {db_session.title}')
        else:
            print('æœªæ‰¾åˆ°ä»»åŠ¡')

asyncio.run(check())
"
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨çœŸå®è®¾å¤‡ä¸Šæµ‹è¯•ï¼ˆæ¨èï¼‰

1. åœ¨çœŸå®iOSè®¾å¤‡ä¸Šè¿è¡Œåº”ç”¨
2. ä½¿ç”¨çœŸå®éº¦å…‹é£å½•éŸ³
3. å½•éŸ³æ–‡ä»¶åº”è¯¥ä¼šæœ‰å®é™…éŸ³é¢‘æ•°æ®ï¼ˆé€šå¸¸å‡ MBï¼‰

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨æµ‹è¯•éŸ³é¢‘æ–‡ä»¶

å¦‚æœéœ€è¦åœ¨æ¨¡æ‹Ÿå™¨ä¸Šæµ‹è¯•ï¼Œå¯ä»¥ï¼š
1. å‡†å¤‡ä¸€ä¸ªçœŸå®çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆ.m4aæ ¼å¼ï¼‰
2. ä¿®æ”¹ä»£ç ï¼Œç›´æ¥ä½¿ç”¨è¯¥æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•
3. æˆ–è€…åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ¥å£ï¼Œå¯ä»¥ä¸Šä¼ æœ¬åœ°æ–‡ä»¶

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥åç«¯åˆ†æä»»åŠ¡

å¦‚æœä»»åŠ¡ç¡®å®å¡ä½äº†ï¼š

1. **æ£€æŸ¥å¼‚æ­¥ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿è¡Œ**
   ```bash
   # æŸ¥çœ‹Pythonè¿›ç¨‹
   ps aux | grep python
   ```

2. **é‡å¯æœåŠ¡**
   ```bash
   cd ~/gemini-audio-service
   pkill -f 'python.*main.py'
   sleep 2
   source venv/bin/activate
   nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
   ```

3. **æ‰‹åŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   ```bash
   # åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨æ›´æ–°çŠ¶æ€ä¸ºfailed
   python3 -c "
   import sys
   sys.path.insert(0, '.')
   import asyncio
   from database.connection import AsyncSessionLocal
   from database.models import Session
   from sqlalchemy import select
   import uuid
   
   async def update():
       async with AsyncSessionLocal() as session:
           session_id = uuid.UUID('9b49e802-3614-43f2-ac8a-4f713cde3012')
           result = await session.execute(
               select(Session).where(Session.id == session_id)
           )
           db_session = result.scalar_one_or_none()
           if db_session:
               db_session.status = 'failed'
               await session.commit()
               print('çŠ¶æ€å·²æ›´æ–°ä¸ºfailed')
   
   asyncio.run(update())
   "
   ```

## é¢„é˜²æªæ–½

### 1. æ·»åŠ æ–‡ä»¶å¤§å°éªŒè¯

åœ¨å®¢æˆ·ç«¯æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼š

```swift
// åœ¨RecordingViewModelä¸­
if fileSize < 1000 { // å°äº1KBå¯èƒ½æ˜¯æ— æ•ˆæ–‡ä»¶
    errorMessage = "å½•éŸ³æ–‡ä»¶å¤ªå°ï¼Œè¯·é‡æ–°å½•éŸ³"
    showError = true
    return
}
```

### 2. å¢åŠ è¶…æ—¶æ—¶é—´

å¦‚æœéŸ³é¢‘æ–‡ä»¶è¾ƒå¤§ï¼Œåˆ†æå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼š

```swift
// åœ¨RecordingViewModelä¸­
let maxPolls = 120  // å¢åŠ åˆ°120æ¬¡ï¼ˆ6åˆ†é’Ÿï¼‰
```

### 3. æ·»åŠ é”™è¯¯å¤„ç†

åœ¨çŠ¶æ€è½®è¯¢ä¸­æ·»åŠ æ›´å¥½çš„é”™è¯¯å¤„ç†ï¼š

```swift
// å¦‚æœçŠ¶æ€æ˜¯failedï¼Œåœæ­¢è½®è¯¢å¹¶æ˜¾ç¤ºé”™è¯¯
if status == "failed" {
    // åœæ­¢è½®è¯¢
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
}
```

## å¿«é€Ÿè¯Šæ–­å‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd ~/gemini-audio-service
source venv/bin/activate

echo "=== 1. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ ==="
TOKEN=$(curl -s -X POST "http://localhost:8001/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000", "code": "123456"}' | \
  python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('token', ''))")

curl -s -X GET "http://localhost:8001/api/v1/tasks/sessions/9b49e802-3614-43f2-ac8a-4f713cde3012/status" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool

echo -e "\n=== 2. æŸ¥çœ‹ç›¸å…³æ—¥å¿— ==="
grep "9b49e802-3614-43f2-ac8a-4f713cde3012" ~/gemini-audio-service.log | tail -20

echo -e "\n=== 3. æŸ¥çœ‹é”™è¯¯æ—¥å¿— ==="
grep -E "ERROR|é”™è¯¯|Exception" ~/gemini-audio-service.log | tail -10
```

## æ€»ç»“

æœ€å¯èƒ½çš„åŸå› æ˜¯**éŸ³é¢‘æ–‡ä»¶å¤ªå°**ï¼ˆ28å­—èŠ‚ï¼‰ï¼Œè¿™åœ¨iOSæ¨¡æ‹Ÿå™¨ä¸Šæ˜¯æ­£å¸¸çš„ã€‚å»ºè®®ï¼š

1. **åœ¨çœŸå®iOSè®¾å¤‡ä¸Šæµ‹è¯•** - è¿™æ˜¯æœ€å¯é çš„è§£å†³æ–¹æ¡ˆ
2. **æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—** - ç¡®è®¤æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
3. **æ£€æŸ¥ä»»åŠ¡çŠ¶æ€** - ç¡®è®¤ä»»åŠ¡æ˜¯å¦çœŸçš„å¡ä½äº†

å¦‚æœä»»åŠ¡ç¡®å®å¡ä½äº†ï¼Œå¯ä»¥é‡å¯æœåŠ¡æˆ–æ‰‹åŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€ã€‚
