# ============================================================
# 当 SSH 超时无法连接时，使用阿里云「远程连接」在服务器上执行
# 操作：轻量服务器控制台 → Ubuntu-pdra → 点击「远程连接」→ 粘贴下面整段命令
# ============================================================

cd ~/gemini-audio-service

# 1. 停止旧进程并启动应用（修复 502）
pkill -f "uvicorn main:app" 2>/dev/null
pkill -f "python.*main.py" 2>/dev/null
sleep 3
nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 >> ~/gemini-audio-service.log 2>&1 &
echo "已启动应用，等待 15 秒..."
sleep 15

# 2. 修复 Nginx 超时（修复任务列表超时）
NGINX_CONF="/etc/nginx/sites-available/gemini-and-api"
[ ! -f "$NGINX_CONF" ] && NGINX_CONF="/etc/nginx/sites-available/default"
sudo sed -i.bak 's/proxy_read_timeout 60s/proxy_read_timeout 120s/g; s/proxy_connect_timeout 60s/proxy_connect_timeout 120s/g; s/proxy_send_timeout 60s/proxy_send_timeout 120s/g' "$NGINX_CONF" 2>/dev/null || true
sudo nginx -t 2>&1 && sudo systemctl reload nginx 2>/dev/null && echo "Nginx 已重载" || echo "Nginx 未修改或重载失败"

# 3. 添加 sessions 索引（若脚本存在）
python3 database/migrations/run_add_sessions_list_index.py 2>/dev/null && echo "索引已创建" || echo "索引跳过"

# 4. 验证
echo ""
echo "=== 验证 ==="
curl -sf --max-time 5 http://127.0.0.1:8000/health && echo " 应用正常" || echo " 应用异常"
curl -s -X POST "http://127.0.0.1:8000/api/v1/auth/send-code" -H "Content-Type: application/json" -d '{"phone":"13800138000"}' | head -c 200
echo ""
echo "=== 完成，请重试 App 登录和任务列表 ==="
