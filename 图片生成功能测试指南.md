# 图片生成功能测试指南

## 功能概述

在策略分析接口中集成了 Gemini Nano Banana 图片生成功能，为每个关键时刻生成火柴人动画图片。

## 实现内容

1. **数据模型更新**
   - `VisualData` 模型添加了 `image_base64` 字段
   - 支持 Base64 编码的图片数据

2. **图片生成函数**
   - `generate_image_from_prompt()` - 使用 Gemini Nano Banana 生成图片
   - 模型: `gemini-2.5-flash-image`
   - 宽高比: `4:3` (1184x864)
   - 返回: Base64 编码的 PNG 图片

3. **集成到策略分析**
   - 在生成策略分析后，自动为每个关键时刻生成图片
   - 图片生成失败不影响其他功能

## 测试步骤

### 1. 上传代码到服务器

```bash
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py
```

### 2. 检查依赖

确保服务器上有 `google-genai` SDK：

```bash
ssh admin@47.79.254.213
cd ~/gemini-audio-service
source venv/bin/activate
pip3 list | grep google-genai
```

如果没有，安装：

```bash
pip3 install google-genai>=0.2.0
```

### 3. 重启服务

```bash
cd ~/gemini-audio-service
source venv/bin/activate
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
sleep 3
ps aux | grep 'python.*main.py' | grep -v grep
```

### 4. 测试策略分析接口

```bash
SESSION_ID="你的session_id"

curl -X POST "http://localhost:8001/api/v1/tasks/sessions/$SESSION_ID/strategies" \
  -H "Content-Type: application/json" | python3 -m json.tool > response.json
```

### 5. 检查返回数据

查看返回的 JSON，确认每个 visual 对象包含 `image_base64` 字段：

```bash
python3 -c "
import json
with open('response.json', 'r') as f:
    data = json.load(f)
    
if data.get('code') == 200:
    visual_list = data.get('data', {}).get('visual', [])
    print(f'关键时刻数量: {len(visual_list)}')
    print()
    
    for i, v in enumerate(visual_list):
        has_image = '✅' if v.get('image_base64') else '❌'
        image_size = len(v.get('image_base64', '')) if v.get('image_base64') else 0
        print(f'关键时刻 {i+1}:')
        print(f'  - transcript_index: {v.get(\"transcript_index\")}')
        print(f'  - speaker: {v.get(\"speaker\")}')
        print(f'  - emotion: {v.get(\"emotion\")}')
        print(f'  - 图片: {has_image} (Base64 大小: {image_size} 字符)')
        print()
"
```

### 6. 查看服务器日志

```bash
tail -100 ~/gemini-audio-service.log | grep -E "图片生成|关键时刻|image_base64"
```

应该看到：
- "========== 开始为 X 个关键时刻生成图片 =========="
- "生成图片 1/X: ..."
- "✅ 图片生成成功，耗时: X 秒"
- "✅ 图片 Base64 编码完成，大小: X 字符"

### 7. 验证图片数据（可选）

如果返回了 `image_base64`，可以验证是否是有效的图片：

```bash
python3 -c "
import json
import base64

with open('response.json', 'r') as f:
    data = json.load(f)

visual_list = data.get('data', {}).get('visual', [])
if visual_list and visual_list[0].get('image_base64'):
    image_base64 = visual_list[0]['image_base64']
    image_bytes = base64.b64decode(image_base64)
    print(f'✅ Base64 解码成功，图片大小: {len(image_bytes)} 字节')
    
    # 保存第一张图片用于验证
    with open('test_image.png', 'wb') as f:
        f.write(image_bytes)
    print('✅ 图片已保存为 test_image.png')
else:
    print('❌ 没有找到图片数据')
"
```

## 预期结果

1. ✅ 每个关键时刻都有对应的图片（`image_base64` 不为空）
2. ✅ Base64 数据可以正确解码为 PNG 图片
3. ✅ 图片大小合理（每张约 100-500KB Base64 编码）
4. ✅ 日志显示图片生成成功

## 可能的问题

### 1. SDK 导入错误

如果出现 `ImportError: cannot import name 'genai' from 'google'`：

```bash
pip3 install --upgrade google-genai
```

### 2. 代理连接问题

如果图片生成失败，可能是代理配置问题。检查日志中的错误信息。

### 3. API 密钥问题

确保 `GEMINI_API_KEY` 环境变量已设置。

### 4. 响应时间过长

生成多张图片可能需要较长时间（每张 5-10 秒），这是正常的。

## 客户端使用

返回的 JSON 格式：

```json
{
  "code": 200,
  "data": {
    "visual": [
      {
        "transcript_index": 0,
        "speaker": "Speaker_1",
        "image_prompt": "...",
        "emotion": "...",
        "subtext": "...",
        "context": "...",
        "my_inner": "...",
        "other_inner": "...",
        "image_base64": "iVBORw0KGgoAAAANSUhEUgAA..."  // Base64 编码的 PNG
      }
    ],
    "strategies": [...]
  }
}
```

客户端可以：
1. 解码 Base64 数据：`Data(base64Encoded: imageBase64)`
2. 使用 `UIImage(data:)` 创建图片
3. 使用 `UICollectionView` 或 `UIPageViewController` 实现左右滑动
