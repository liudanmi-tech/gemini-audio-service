# 诊断图片生成失败

## 查看详细的错误日志

```bash
# 查看最近的图片生成相关日志
tail -300 ~/gemini-audio-service.log | grep -A 20 -B 5 "图片生成\|generate_image\|错误\|Error\|失败\|Failed" | tail -50

# 或者查看所有错误
tail -300 ~/gemini-audio-service.log | grep -E "错误|Error|Exception|失败|Failed" | tail -30

# 查看策略分析接口的完整日志
tail -500 ~/gemini-audio-service.log | grep -A 50 "策略分析\|generate_strategies\|POST.*strategies" | tail -60
```

## 可能的原因

1. **图片生成 API 调用失败** - Gemini API 调用可能失败
2. **代理配置问题** - 新的 SDK 可能无法通过代理访问
3. **API Key 问题** - API Key 可能没有图片生成权限
4. **网络连接问题** - 服务器可能无法直接访问 Google API

## 检查步骤

### 1. 查看详细错误日志

```bash
tail -500 ~/gemini-audio-service.log | grep -A 10 "图片生成\|generate_image" | tail -50
```

### 2. 测试图片生成函数

```bash
python3 -c "
import sys
sys.path.insert(0, '/home/admin/gemini-audio-service')
from main import generate_image_from_prompt

# 测试图片生成
print('测试图片生成...')
result = generate_image_from_prompt('米色背景，极简火柴人线稿。左侧为用户，右侧为对方。', 'test-session', 0)
print(f'结果: {type(result)}')
if result:
    if result.startswith('http'):
        print(f'✅ 返回 URL: {result}')
    else:
        print(f'✅ 返回 Base64 (长度: {len(result)} 字符)')
else:
    print('❌ 返回 None（生成失败）')
"
```
