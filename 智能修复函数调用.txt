# ============================================
# æ™ºèƒ½ä¿®å¤å‡½æ•°è°ƒç”¨ - ç›´æ¥å¤åˆ¶æ‰§è¡Œ
# ============================================

cd /home/admin/gemini-audio-service && python3 << 'FIX'
import re

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()
    lines = content.split('\n')

print("ğŸ” æ£€æŸ¥ä»£ç ç»“æ„...")

# æŸ¥æ‰¾ upload_audio_api å‡½æ•°
upload_func_start = -1
for i, line in enumerate(lines):
    if '@app.post("/api/v1/audio/upload")' in line or 'def upload_audio_api' in line:
        upload_func_start = i
        break

if upload_func_start == -1:
    print("âŒ æœªæ‰¾åˆ° upload_audio_api å‡½æ•°")
    exit(1)

# æŸ¥æ‰¾ analyze_audio_async è°ƒç”¨
call_line_idx = -1
for i in range(upload_func_start, min(upload_func_start + 100, len(lines))):
    if 'asyncio.create_task(analyze_audio_async' in lines[i]:
        call_line_idx = i
        break

if call_line_idx == -1:
    print("âŒ æœªæ‰¾åˆ° analyze_audio_async è°ƒç”¨")
    exit(1)

print(f"âœ… æ‰¾åˆ°å‡½æ•°è°ƒç”¨åœ¨ç¬¬ {call_line_idx + 1} è¡Œ")
print(f"   å½“å‰è°ƒç”¨: {lines[call_line_idx].strip()}")

# æ£€æŸ¥è°ƒç”¨å‰æ˜¯å¦æœ‰ temp_file_path å’Œ file_filename
has_temp_file = False
has_file_filename = False
for i in range(max(0, call_line_idx - 20), call_line_idx):
    if 'temp_file_path' in lines[i] and '=' in lines[i]:
        has_temp_file = True
    if 'file_filename' in lines[i] and '=' in lines[i]:
        has_file_filename = True

print(f"   æ£€æŸ¥å˜é‡: temp_file_path={has_temp_file}, file_filename={has_file_filename}")

# ä¿®å¤è°ƒç”¨
if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in lines[call_line_idx]:
    if has_temp_file and has_file_filename:
        # æ›¿æ¢ä¸ºæ­£ç¡®çš„è°ƒç”¨
        old_line = lines[call_line_idx]
        # ä¿æŒç¼©è¿›
        indent = len(old_line) - len(old_line.lstrip())
        new_line = ' ' * indent + 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'
        lines[call_line_idx] = new_line
        print("âœ… ä¿®å¤å‡½æ•°è°ƒç”¨ï¼šä½¿ç”¨ temp_file_path å’Œ file_filename")
    else:
        print("âŒ é”™è¯¯ï¼šä»£ç ä¸­ç¼ºå°‘ temp_file_path æˆ– file_filename å˜é‡")
        print("éœ€è¦å…ˆä¿®å¤ upload_audio_api å‡½æ•°ï¼Œç¡®ä¿è¯»å–æ–‡ä»¶å¹¶åˆ›å»ºä¸´æ—¶æ–‡ä»¶")
        exit(1)
elif 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))' in lines[call_line_idx]:
    print("âœ… å‡½æ•°è°ƒç”¨å·²ç»æ˜¯æ­£ç¡®ç‰ˆæœ¬ï¼Œæ— éœ€ä¿®æ”¹")
else:
    print(f"âš ï¸  æœªçŸ¥çš„è°ƒç”¨æ ¼å¼: {lines[call_line_idx].strip()}")
    print("éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»£ç ")

# å†™å…¥æ–‡ä»¶
if 'asyncio.create_task(analyze_audio_async(session_id, file, task_data))' in content:
    content = '\n'.join(lines)
    with open('main.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    import py_compile
    py_compile.compile('main.py', doraise=True)
    print("âœ… ä¿®å¤å®Œæˆï¼Œéœ€è¦é‡å¯æœåŠ¡")
else:
    print("âœ… ä»£ç å·²ç»æ˜¯æ­£ç¡®ç‰ˆæœ¬ï¼Œæ— éœ€ä¿®æ”¹")
FIX

# é‡å¯æœåŠ¡
cd /home/admin/gemini-audio-service && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && echo "âœ… æœåŠ¡å·²é‡å¯" && curl -s http://localhost:8001/health

