# ============================================
# 服务端完整自测 - 一键执行
# ============================================

cd /home/admin/gemini-audio-service && python3 << 'FULL_TEST'
import requests
import json
import wave
import struct
import os
import time

print("=" * 60)
print("服务端完整自测")
print("=" * 60)

# 1. 检查服务状态
print("\n[1] 检查服务状态...")
try:
    response = requests.get("http://localhost:8001/health", timeout=5)
    if response.status_code == 200:
        print(f"✅ 服务运行正常: {response.json()}")
    else:
        print(f"❌ 服务异常，状态码: {response.status_code}")
        exit(1)
except Exception as e:
    print(f"❌ 无法连接到服务: {e}")
    exit(1)

# 2. 创建测试音频文件
print("\n[2] 创建测试音频文件...")
test_audio_path = "/tmp/test_audio.wav"
sample_rate = 44100
duration = 2  # 2秒
num_samples = sample_rate * duration

try:
    with wave.open(test_audio_path, 'w') as wav_file:
        wav_file.setnchannels(1)
        wav_file.setsampwidth(2)
        wav_file.setframerate(sample_rate)
        for i in range(num_samples):
            value = int(0)
            packed_value = struct.pack('h', value)
            wav_file.writeframes(packed_value)
    file_size = os.path.getsize(test_audio_path)
    print(f"✅ 测试音频文件已创建: {test_audio_path} ({file_size} 字节)")
except Exception as e:
    print(f"❌ 创建音频文件失败: {e}")
    exit(1)

# 3. 测试上传接口
print("\n[3] 测试上传接口...")
url = "http://localhost:8001/api/v1/audio/upload"
try:
    with open(test_audio_path, 'rb') as f:
        files = {'file': ('test_audio.wav', f, 'audio/wav')}
        data = {'title': '服务端自测'}
        response = requests.post(url, files=files, data=data, timeout=30)
    
    print(f"状态码: {response.status_code}")
    print(f"响应: {response.text[:200]}...")
    
    if response.status_code == 200:
        result = response.json()
        if result.get('code') == 200:
            session_id = result['data']['session_id']
            print(f"✅ 上传成功！")
            print(f"   session_id: {session_id}")
            print(f"   title: {result['data']['title']}")
            print(f"   status: {result['data']['status']}")
            
            # 4. 等待几秒后检查任务状态
            print("\n[4] 等待3秒后检查任务状态...")
            time.sleep(3)
            
            status_url = f"http://localhost:8001/api/v1/tasks/sessions/{session_id}/status"
            status_response = requests.get(status_url, timeout=5)
            if status_response.status_code == 200:
                status_result = status_response.json()
                print(f"✅ 任务状态查询成功:")
                print(f"   状态: {status_result['data']['status']}")
                print(f"   进度: {status_result['data']['progress']}")
            else:
                print(f"⚠️  状态查询失败: {status_response.status_code}")
            
            # 5. 检查任务列表
            print("\n[5] 检查任务列表...")
            list_url = "http://localhost:8001/api/v1/tasks/sessions"
            list_response = requests.get(list_url, timeout=5)
            if list_response.status_code == 200:
                list_result = list_response.json()
                sessions = list_result['data']['sessions']
                print(f"✅ 任务列表查询成功，共 {len(sessions)} 个任务")
                if sessions:
                    print(f"   最新任务: {sessions[0]['title']} ({sessions[0]['status']})")
            else:
                print(f"⚠️  任务列表查询失败: {list_response.status_code}")
            
        else:
            print(f"❌ 上传失败: {result.get('message')}")
    else:
        print(f"❌ 上传失败，状态码: {response.status_code}")
        print(f"响应内容: {response.text}")
except Exception as e:
    print(f"❌ 上传请求失败: {e}")
    import traceback
    traceback.print_exc()

# 6. 查看最近的错误日志
print("\n[6] 查看最近的错误日志...")
try:
    log_path = os.path.expanduser('~/gemini-service.log')
    if os.path.exists(log_path):
        with open(log_path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
            error_lines = [l for l in lines[-100:] if 'ERROR' in l or '错误' in l or '失败' in l]
            if error_lines:
                print("最近的错误:")
                for line in error_lines[-10:]:
                    print(f"  {line.strip()}")
            else:
                print("✅ 最近100行日志中没有错误")
    else:
        print("⚠️  日志文件不存在")
except Exception as e:
    print(f"⚠️  读取日志失败: {e}")

print("\n" + "=" * 60)
print("自测完成")
print("=" * 60)
FULL_TEST

