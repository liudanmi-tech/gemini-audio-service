# v0.4 技能化架构 — 技术实现检查报告

基于《v0.4 技能化架构技术方案设计.md》对当前服务端代码的对照检查结果。

---

## 一、文档与实现对照（符合项）

| 文档要求 | 实现位置 | 状态 |
|----------|----------|------|
| 技能目录结构 skills/{skill_id}/SKILL.md | skills/workplace_jungle、family_relationship、education_communication、brainstorm | 符合 |
| skills/registry.py 注册、获取、列表、重载 | registry.py: register_skill, get_skill, list_skills, reload_skill, initialize_skills | 符合 |
| skills/loader.py 解析 SKILL.md、frontmatter、Prompt 模板 | loader.py: parse_skill_markdown, extract_prompt_template, load_knowledge_base, load_skill_from_file | 符合 |
| skills/router.py 场景分类与技能匹配 | router.py: classify_scene, match_skills（需 db） | 符合 |
| skills/executor.py 执行单技能、Prompt 组装 | executor.py: execute_skill, execute_skill_scripts（脚本暂未实现） | 符合 |
| skills/composer.py 多技能结果融合 | composer.py: compose_results | 符合 |
| 数据库 skills、skill_executions 表 | database/models.py: Skill, SkillExecution；migrations/add_skills_tables.sql | 符合 |
| strategy_analysis 新增 applied_skills、scene_category、scene_confidence | database/models.py StrategyAnalysis；migrations 中 ALTER | 符合 |
| GET /api/v1/skills、GET /api/v1/skills/{id}、POST /api/v1/skills/{id}/reload | api/skills.py | 符合 |
| POST /api/v1/tasks/sessions/{id}/strategies 集成场景识别与技能执行 | main.py generate_strategies | 符合 |
| POST /api/v1/tasks/sessions/{id}/classify-scene | main.py classify_scene_endpoint | 符合 |

---

## 二、发现的技术问题

### 1. 循环导入（高风险）

**现象**  
- `skills/executor.py` 第 17 行：`from main import parse_gemini_response, VisualData, StrategyItem, Call2Response`  
- `skills/composer.py` 第 9 行：`from main import Call2Response, VisualData, StrategyItem`  
- `main.py` 第 73 行：`from skills.executor import execute_skill`，第 74 行：`from skills.composer import compose_results`

**原因**  
main 在加载时导入 skills.executor，executor 再导入 main。此时 main 尚未执行到定义 `parse_gemini_response`（约 521 行）、`StrategyItem`（约 260 行）等，可能导致 `AttributeError` 或启动失败。

**建议**  
将 `parse_gemini_response`、`StrategyItem`、`VisualData`、`Call2Response` 抽到独立模块（如 `schemas/strategy.py` 或 `models/schemas.py`），main 与 skills 均从该模块导入，避免 main ↔ skills 循环依赖。

---

### 2. 文档规定的 API 未实现

**文档 5.1**  
- **POST /api/v1/skills** — 创建新技能（管理员）  
- **PUT /api/v1/skills/{skill_id}** — 更新技能（管理员）

**当前**  
api/skills.py 仅有 GET 列表、GET 详情、POST reload，无创建与更新接口。

**影响**  
无法通过 API 创建/更新技能，只能通过文件系统 + reload 或启动时 initialize_skills。

**建议**  
若需与文档一致，可补充 POST（创建）、PUT（更新）及权限控制（管理员）。

---

### 3. 模型名称硬编码与兼容性

**现象**  
多处使用 `gemini-3-flash-preview`：  
- skills/router.py:39  
- skills/executor.py:60、95  
- main.py:632、1496、1767、2075

**风险**  
该名称可能随 Google API 变更或不可用，导致场景识别/策略生成失败。

**建议**  
- 使用环境变量（如 `GEMINI_ROUTER_MODEL`、`GEMINI_STRATEGY_MODEL`），默认 `gemini-1.5-flash` 或当前官方名称。  
- 统一从配置读取，避免硬编码。

---

### 4. 数据库字段与文档/迁移不一致

| 项目 | 文档 / 迁移 | 当前 models.py | 说明 |
|------|-------------|----------------|------|
| skill_executions.confidence_score | FLOAT | JSONB | 文档/迁移为 FLOAT，模型为 JSONB，类型不一致。 |
| strategy_analysis.scene_confidence | FLOAT | JSONB | 同上。 |

**建议**  
- 若业务只需一个浮点置信度，建议与文档一致改为 FLOAT，并做一次迁移或说明。  
- 若需存复杂结构，保留 JSONB 并更新文档与迁移说明。

---

### 5. 技能脚本执行未实现

**文档 6.2 / 技能执行流程**  
- scripts/preprocess.py、scripts/postprocess.py 的调用  
- execute_skill_scripts

**当前**  
executor.py 中 `execute_skill_scripts` 仅打日志“暂未实现”，未实际执行脚本。

**影响**  
带 scripts/ 的技能无法做预处理/后处理，与文档描述不符。

**建议**  
若需要脚本能力，可在安全约束下实现（如子进程/沙箱）；否则在文档中注明“脚本执行暂未实现”。

---

### 6. 路由器 match_skills 签名与文档不一致

**文档**  
`match_skills(scene_result: dict) -> List[dict]`

**当前**  
router.py: `match_skills(scene_result: Dict, db: AsyncSession) -> List[Dict]`，多出 `db` 参数（用于从数据库拉技能列表）。

**说明**  
当前实现合理（需要 db 查技能），文档可更新为“需传入 db”。

---

## 三、已修复项（与 502 方案重叠）

- **main.py 启动时技能初始化**：已由 `async_session_maker` 改为 `AsyncSessionLocal`（与 database/connection 一致），避免启动时技能初始化报错。

---

## 四、建议优先级

| 优先级 | 项 | 说明 |
|--------|----|------|
| 高 | 循环导入 | 可能导致启动失败或不可预测错误，建议抽离共享模型/解析函数。 |
| 中 | 模型名称配置化 | 避免 API 更名或下线导致全线失败。 |
| 中 | 数据库字段一致性 | 避免迁移与 ORM 不一致带来的问题。 |
| 低 | POST/PUT 技能 API | 若有管理后台或运维需求再补。 |
| 低 | 脚本执行 | 按安全与需求决定是否实现或仅在文档中说明。 |

---

## 五、小结

v0.4 技能化架构在目录结构、技能加载/注册、路由/执行/组合、数据库表与核心 API 上基本按文档实现；当前主要技术债为 **main 与 skills 的循环导入**、**Gemini 模型名硬编码**、**文档中的部分 API 与字段定义未实现或不一致**。建议优先消除循环依赖并统一模型配置与数据库类型定义。

---

## 六、修复完成说明（已实施）

以下问题已按报告建议完成修复：

| 项 | 处理方式 |
|----|----------|
| 循环导入 | 新增 `schemas/strategy_schemas.py`，main 与 skills 均从该模块导入 StrategyItem、VisualData、Call2Response、parse_gemini_response。 |
| 模型名硬编码 | 使用环境变量 `GEMINI_FLASH_MODEL`，默认 `gemini-3-flash-preview`，可在 .env 中覆盖。 |
| 数据库字段一致性 | `StrategyAnalysis.scene_confidence`、`SkillExecution.confidence_score` 已改为 Float，与文档/迁移一致。 |
| POST/PUT 技能 API | 已实现 POST /api/v1/skills（创建）、PUT /api/v1/skills/{skill_id}（更新）；loader 新增 create_skill_file、update_skill_file。 |

**后续建议：**

1. **线上数据库**：若 `strategy_analysis.scene_confidence` 或 `skill_executions.confidence_score` 当前为 JSONB，可执行 `database/migrations/alter_confidence_to_float.sql` 做一次性类型迁移（脚本内已做类型判断，仅当列为 JSONB 时 ALTER）。
2. **环境变量**：如需更换模型，在 .env 中设置 `GEMINI_FLASH_MODEL=gemini-1.5-flash`（或当前可用模型名）。
3. **部署**：将本次修改（schemas、main、skills、api/skills、database/models、migrations）部署到服务器后重启服务即可。
