# 查看服务器日志 - 诊断分析失败问题

## 🔍 问题现象

- ✅ 音频上传成功
- ✅ 任务创建成功
- ❌ 任务状态一直显示 `failed`
- ❌ 分析过程失败

## 📋 查看服务器日志步骤

### 在服务器上执行：

```bash
# 1. SSH 连接到服务器
ssh admin@47.79.254.213

# 2. 查看最近的日志（最后 100 行）
tail -100 /tmp/gemini-service.log

# 3. 或者实时查看日志（推荐）
tail -f /tmp/gemini-service.log
```

### 查找错误信息

在日志中查找以下关键词：
- `❌` - 错误标记
- `分析音频失败` - 分析失败的错误
- `Exception` - 异常信息
- `Traceback` - 错误堆栈

## 🔧 常见错误和解决方案

### 错误 1: `analyze_audio` 不是异步函数

**症状**: `TypeError: object function can't be used in 'await' expression`

**原因**: `analyze_audio` 是同步函数，但 `analyze_audio_async` 使用了 `await`

**解决**: 需要修复代码，将 `analyze_audio` 改为异步函数，或者使用 `asyncio.to_thread` 包装

### 错误 2: Gemini API 调用失败

**症状**: `HttpError` 或 `TimeoutError`

**原因**: 
- API Key 无效
- 反向代理配置错误
- 网络连接问题

**解决**: 
1. 检查 `.env` 文件中的 `GEMINI_API_KEY`
2. 检查反向代理配置
3. 测试 Gemini API 连接：`curl http://47.79.254.213:8001/test-gemini`

### 错误 3: 文件上传到 Gemini 失败

**症状**: `upload_file` 相关错误

**原因**: 
- 文件格式不支持
- 文件太大
- Gemini API 配额用完

**解决**: 
1. 检查文件格式（支持 mp3/wav/m4a）
2. 检查文件大小
3. 检查 Gemini API 配额

## 📊 测试 Gemini API 连接

在服务器上执行：

```bash
curl http://localhost:8001/test-gemini
```

如果返回成功，说明 Gemini API 连接正常。

## 🔄 修复代码（如果需要）

如果发现 `analyze_audio` 不是异步函数的问题，需要修复 `main.py`。


