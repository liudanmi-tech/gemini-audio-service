# 最简单修复命令

## 使用方法

1. 打开阿里云控制台 → 轻量应用服务器 → 你的服务器 → **命令助手**
2. 点击"执行命令"
3. **复制下面的整段代码，粘贴执行**

---

## 完整修复命令（复制整段）

```bash
cd ~/gemini-audio-service && python3 << 'FIX' && pkill -f "python3 main.py" 2>/dev/null; sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl -s http://localhost:8001/health
import shutil, time

backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
print(f"✅ 备份: {backup}")

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

changes = []

# 修复1: Query导入
if 'Query' not in content.split('from fastapi import')[1].split('\n')[0]:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    changes.append("添加Query导入")

# 修复2: file_filename
if 'file_filename = file.filename' in content and 'or "audio.m4a"' not in content[content.find('file_filename = file.filename'):content.find('file_filename = file.filename')+60]:
    content = content.replace('file_filename = file.filename', 'file_filename = file.filename or "audio.m4a"')
    changes.append("修复file_filename")

# 修复3: 函数定义添加task_data
if 'async def analyze_audio_async(' in content and 'task_data' not in content[content.find('async def analyze_audio_async('):content.find('async def analyze_audio_async(')+200]:
    content = content.replace('async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):', 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):')
    if 'task_data' in content[content.find('async def analyze_audio_async('):content.find('async def analyze_audio_async(')+200]:
        changes.append("函数定义添加task_data")

# 修复4: 函数调用添加task_data
if 'asyncio.create_task(analyze_audio_async(' in content:
    old_call = 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))'
    new_call = 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))'
    if old_call in content:
        content = content.replace(old_call, new_call)
        changes.append("函数调用添加task_data")
    elif 'asyncio.create_task(analyze_audio_async(' in content and 'task_data' not in content[content.find('asyncio.create_task(analyze_audio_async('):content.find('asyncio.create_task(analyze_audio_async(')+150]:
        # 尝试其他格式
        import re
        pattern = r'asyncio\.create_task\(analyze_audio_async\(([^)]+)\)\)'
        def replace_call(m):
            args = m.group(1)
            if 'task_data' not in args:
                if args.endswith('file_filename'):
                    return f'asyncio.create_task(analyze_audio_async({args}, task_data))'
            return m.group(0)
        new_content = re.sub(pattern, replace_call, content)
        if new_content != content:
            content = new_content
            changes.append("函数调用添加task_data")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

print(f"\n✅ 修复完成，共 {len(changes)} 处:")
for c in changes:
    print(f"  - {c}")

import py_compile
try:
    py_compile.compile('main.py', doraise=True)
    print("✅ 语法检查通过")
except Exception as e:
    print(f"❌ 语法错误: {e}")
    shutil.copy(backup, 'main.py')
    raise
print(f"✅ 修复成功！备份: {backup}")
FIX
```

---

## 如果上面的命令太长，分步执行：

### 步骤1：先查看问题
```bash
cd ~/gemini-audio-service && grep -A 3 "async def analyze_audio_async" main.py | head -5
```

### 步骤2：修复代码
```bash
cd ~/gemini-audio-service && python3 << 'FIX'
import shutil, time, re
backup = f'main.py.backup_{int(time.time())}'
shutil.copy('main.py', backup)
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 修复函数定义
if 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):' in content:
    content = content.replace('async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str):', 'async def analyze_audio_async(session_id: str, temp_file_path: str, file_filename: str, task_data: dict):')
    print("✅ 修复函数定义")

# 修复函数调用
if 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))' in content:
    content = content.replace('asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename))', 'asyncio.create_task(analyze_audio_async(session_id, temp_file_path, file_filename, task_data))')
    print("✅ 修复函数调用")

# 添加Query导入
if 'from fastapi import' in content and 'Query' not in content.split('from fastapi import')[1].split('\n')[0]:
    content = content.replace('from fastapi import FastAPI, UploadFile, File, HTTPException', 'from fastapi import FastAPI, UploadFile, File, HTTPException, Query')
    print("✅ 添加Query导入")

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

import py_compile
py_compile.compile('main.py', doraise=True)
print(f"✅ 修复完成！备份: {backup}")
FIX
```

### 步骤3：重启服务
```bash
cd ~/gemini-audio-service && pkill -f "python3 main.py" && sleep 2 && nohup python3 main.py > /tmp/gemini-service.log 2>&1 & sleep 3 && curl http://localhost:8001/health
```

---

## 验证修复

修复后，执行以下命令验证：

```bash
# 检查函数定义
grep "async def analyze_audio_async" ~/gemini-audio-service/main.py

# 检查函数调用
grep "asyncio.create_task(analyze_audio_async" ~/gemini-audio-service/main.py

# 检查服务状态
curl http://localhost:8001/health
```

