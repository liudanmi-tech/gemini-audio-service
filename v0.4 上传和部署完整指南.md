# v0.4 上传和部署完整指南

## 第一步：配置SSH免密登录（推荐）

### 方法1: 使用脚本自动配置

在本地终端执行：

```bash
cd ~/Desktop/AI军师/gemini-audio-service

chmod +x 配置SSH免密登录.sh

./配置SSH免密登录.sh
```

### 方法2: 手动配置

#### 步骤1: 生成SSH密钥（如果还没有）

```bash
# 检查是否已有SSH密钥

ls -la ~/.ssh/id_rsa*



# 如果没有，生成新的SSH密钥

ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa

# 提示输入密码时，直接回车（不设置密码）
```

#### 步骤2: 复制公钥到服务器

```bash
# 方法A: 使用ssh-copy-id（推荐）

ssh-copy-id admin@47.79.254.213

# 输入密码: Ld123456



# 方法B: 手动复制（如果ssh-copy-id不可用）

# 1. 查看公钥

cat ~/.ssh/id_rsa.pub



# 2. SSH到服务器并添加公钥

ssh admin@47.79.254.213

mkdir -p ~/.ssh

chmod 700 ~/.ssh

echo "你的公钥内容" >> ~/.ssh/authorized_keys

chmod 600 ~/.ssh/authorized_keys

exit
```

#### 步骤3: 测试免密登录

```bash
ssh admin@47.79.254.213 "echo '✅ 免密登录成功'"
```

**如果成功，应该直接连接，不需要输入密码。**

---

## 第二步：上传v0.4代码到服务器

### 方法1: 使用脚本一键上传（推荐）

```bash
cd ~/Desktop/AI军师/gemini-audio-service

chmod +x v0.4上传代码到服务器.sh

./v0.4上传代码到服务器.sh
```

**脚本会自动上传**:

- `skills/` 目录（所有技能）

- `database/migrations/run_migration_v0.4.py`

- `database/migrations/add_skills_tables.sql`

- `database/models.py`

- `api/skills.py`

- `main.py`

- `注册技能到数据库.py`

- `测试v0.4功能.py`

- `测试v0.4架构.sh`

- `服务器执行v0.4部署.sh`

- `在服务器上执行.sh`

### 方法2: 手动上传关键文件

如果脚本不可用，可以手动上传：

```bash
# 进入项目目录

cd ~/Desktop/AI军师/gemini-audio-service



# 1. 上传skills目录（整个目录）

scp -r skills admin@47.79.254.213:~/gemini-audio-service/



# 2. 上传数据库迁移文件

scp database/migrations/run_migration_v0.4.py admin@47.79.254.213:~/gemini-audio-service/database/migrations/

scp database/migrations/add_skills_tables.sql admin@47.79.254.213:~/gemini-audio-service/database/migrations/



# 3. 上传数据库模型

scp database/models.py admin@47.79.254.213:~/gemini-audio-service/database/



# 4. 上传API文件

scp api/skills.py admin@47.79.254.213:~/gemini-audio-service/api/



# 5. 上传main.py

scp main.py admin@47.79.254.213:~/gemini-audio-service/



# 6. 上传脚本文件

scp 注册技能到数据库.py admin@47.79.254.213:~/gemini-audio-service/

scp 测试v0.4功能.py admin@47.79.254.213:~/gemini-audio-service/

scp 测试v0.4架构.sh admin@47.79.254.213:~/gemini-audio-service/

scp 服务器执行v0.4部署.sh admin@47.79.254.213:~/gemini-audio-service/

scp 在服务器上执行.sh admin@47.79.254.213:~/gemini-audio-service/
```

### 方法3: 使用rsync同步（推荐用于大量文件）

```bash
cd ~/Desktop/AI军师/gemini-audio-service



# 同步skills目录

rsync -avz --progress skills/ admin@47.79.254.213:~/gemini-audio-service/skills/



# 同步其他文件

rsync -avz --progress \

database/migrations/run_migration_v0.4.py \

database/models.py \

api/skills.py \

main.py \

admin@47.79.254.213:~/gemini-audio-service/
```

---

## 第三步：在服务器上执行部署

### 方法1: 使用一键部署脚本（推荐）

在服务器终端执行：

```bash
ssh admin@47.79.254.213

cd ~/gemini-audio-service

chmod +x 服务器执行v0.4部署.sh

./服务器执行v0.4部署.sh
```

**脚本会自动执行**:

1. 验证环境和代码结构

2. 执行数据库迁移

3. 注册技能到数据库

4. 验证技能注册

5. 停止旧服务

6. 启动新服务

7. 运行功能测试

### 方法2: 分步执行

如果需要逐步执行，参考 `v0.4部署执行步骤.md`

---

## 验证上传和部署

### 1. 验证文件是否上传成功

在服务器终端执行：

```bash
ssh admin@47.79.254.213

cd ~/gemini-audio-service



# 检查skills目录

ls -la skills/

ls -la skills/*/SKILL.md



# 检查其他文件

ls -la database/migrations/run_migration_v0.4.py

ls -la api/skills.py

ls -la main.py
```

### 2. 验证部署是否成功

```bash
# 检查服务状态

ps aux | grep '[p]ython.*main.py'



# 检查服务日志

tail -50 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|Application startup|ERROR"



# 健康检查

curl http://localhost:8001/health
```

---

## 故障排查

### 问题1: SSH连接失败

**症状**: `Permission denied` 或 `Connection refused`

**解决方案**:

- 检查服务器IP是否正确: `47.79.254.213`

- 检查网络连接: `ping 47.79.254.213`

- 检查防火墙设置

### 问题2: 免密登录配置失败

**症状**: 仍然需要输入密码

**解决方案**:

1. 检查公钥是否复制成功:

```bash
ssh admin@47.79.254.213 "cat ~/.ssh/authorized_keys"
```

2. 检查服务器权限:

```bash
ssh admin@47.79.254.213 "ls -la ~/.ssh/"

# 应该看到: drwx------ (700)

# authorized_keys 应该是: -rw------- (600)
```

3. 手动修复权限:

```bash
ssh admin@47.79.254.213

chmod 700 ~/.ssh

chmod 600 ~/.ssh/authorized_keys
```

### 问题3: 上传失败

**症状**: `scp` 命令失败或文件不完整

**解决方案**:

- 检查文件路径是否正确

- 检查服务器磁盘空间: `ssh admin@47.79.254.213 "df -h"`

- 使用 `rsync` 替代 `scp`（支持断点续传）

### 问题4: 文件权限问题

**症状**: 脚本无法执行

**解决方案**:

```bash
ssh admin@47.79.254.213

cd ~/gemini-audio-service

chmod +x *.sh

chmod +x 注册技能到数据库.py 测试v0.4功能.py

chmod +x database/migrations/run_migration_v0.4.py
```

---

## 快速命令总结

### 配置免密登录

```bash
./配置SSH免密登录.sh
```

### 上传代码

```bash
./v0.4上传代码到服务器.sh
```

### 在服务器上部署

```bash
ssh admin@47.79.254.213

cd ~/gemini-audio-service

./服务器执行v0.4部署.sh
```

---

**文档版本**: v0.4

**创建日期**: 2026-01-16
