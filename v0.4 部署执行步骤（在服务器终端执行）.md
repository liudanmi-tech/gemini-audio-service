# v0.4 部署执行步骤（在服务器终端执行）

## 前提条件

- ✅ 已SSH连接到服务器

- ✅ 当前在服务器终端中

- ✅ 项目目录: `~/gemini-audio-service`

## 执行步骤

### 步骤1: 验证环境和代码结构

```bash
# 1. 进入项目目录

cd ~/gemini-audio-service



# 2. 确认目录

pwd



# 3. 检查技能目录

echo "检查技能目录..."

ls -la skills/



# 4. 检查迁移脚本

echo "检查迁移脚本..."

ls -la database/migrations/run_migration_v0.4.py



# 5. 检查注册脚本

echo "检查注册脚本..."

ls -la 注册技能到数据库.py



# 6. 激活虚拟环境（如果存在）

if [ -d "venv" ]; then

source venv/bin/activate

echo "✅ 虚拟环境已激活"

python3 --version

which python3

else

echo "⚠️ 虚拟环境不存在，使用系统Python"

fi
```

### 步骤2: 执行数据库迁移

```bash
echo "========== 步骤2: 执行数据库迁移 =========="

python3 database/migrations/run_migration_v0.4.py
```

**预期输出**: 应该看到 "数据库迁移完成" 的消息

### 步骤3: 注册技能到数据库

```bash
echo "========== 步骤3: 注册技能到数据库 =========="

python3 注册技能到数据库.py
```

**预期输出**: 应该看到4个技能注册成功的消息

### 步骤4: 验证技能注册

```bash
echo "========== 步骤4: 验证技能注册 =========="

python3 << 'EOF'

import asyncio

import sys

from pathlib import Path

project_root = Path.home() / "gemini-audio-service"

sys.path.insert(0, str(project_root))

from database.connection import AsyncSessionLocal

from skills.registry import list_skills



async def verify():

try:

async with AsyncSessionLocal() as db:

skills = await list_skills(db, enabled=None)

print(f"✅ 数据库中共有 {len(skills)} 个技能:")

for skill in skills:

print(f" - {skill['skill_id']}: {skill.get('name')} (category: {skill.get('category')}, priority: {skill.get('priority', 0)})")

if len(skills) < 4:

print(f"⚠️ 警告: 应该注册4个技能，但只找到 {len(skills)} 个")

except Exception as e:

print(f"❌ 验证失败: {e}")

import traceback

traceback.print_exc()



asyncio.run(verify())

EOF
```

**预期输出**: 应该看到4个技能列表

### 步骤5: 停止旧服务

```bash
echo "========== 步骤5: 停止旧服务 =========="

if pgrep -f 'python.*main.py' > /dev/null; then

OLD_PIDS=$(pgrep -f 'python.*main.py')

echo "找到运行中的服务进程: $OLD_PIDS"

pkill -f 'python.*main.py'

sleep 2

if pgrep -f 'python.*main.py' > /dev/null; then

echo "强制停止服务..."

pkill -9 -f 'python.*main.py'

sleep 1

fi

echo "✅ 旧服务已停止"

else

echo "未发现运行中的服务"

fi
```

### 步骤6: 启动新服务

```bash
echo "========== 步骤6: 启动新服务 =========="

nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &

SERVICE_PID=$!

echo "服务PID: $SERVICE_PID"

sleep 5



# 检查服务状态

if ps -p $SERVICE_PID > /dev/null 2>&1; then

echo "✅ 服务进程运行中，PID: $SERVICE_PID"

else

echo "❌ 服务进程不存在，检查日志..."

tail -50 ~/gemini-audio-service.log | tail -20

exit 1

fi



# 检查服务日志

echo "检查服务启动日志..."

sleep 2

tail -100 ~/gemini-audio-service.log | grep -E "启动|Uvicorn|Application startup|ERROR" | tail -10
```

**预期输出**: 应该看到 "Uvicorn running" 或 "Application startup complete"

### 步骤7: 运行功能测试

```bash
echo "========== 步骤7: 运行功能测试 =========="

python3 测试v0.4功能.py
```

**预期输出**:

- ✅ 技能列表查询成功

- ✅ 技能加载成功

- ✅ 场景识别成功（需要网络连接）

- ✅ 技能匹配成功

### 步骤8: 验证服务健康

```bash
echo "========== 步骤8: 验证服务健康 =========="

sleep 3

curl -s http://localhost:8001/health || echo "⚠️ 健康检查失败"
```

**预期输出**: 应该返回服务信息或 "OK"

## 一键执行所有步骤

如果想一次性执行所有步骤，可以运行：

```bash
cd ~/gemini-audio-service

chmod +x 服务器执行v0.4部署.sh

./服务器执行v0.4部署.sh
```

## 故障排查

如果某个步骤失败：

1. **数据库迁移失败**:
- 检查 `.env` 文件中的 `DATABASE_URL`

- 检查数据库连接是否正常
2. **技能注册失败**:
- 检查技能目录是否存在: `ls -la skills/`

- 检查SKILL.md文件是否存在: `ls -la skills/*/SKILL.md`
3. **服务启动失败**:
- 查看日志: `tail -100 ~/gemini-audio-service.log`

- 检查端口是否被占用: `netstat -tlnp | grep 8001`
4. **功能测试失败**:
- 检查环境变量: `cat .env | grep GEMINI_API_KEY`

- 检查网络连接（如果需要访问Gemini API）
