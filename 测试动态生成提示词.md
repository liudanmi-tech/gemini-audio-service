# 测试动态生成火柴人动画提示词

## 前置条件

1. ✅ 代码已修改完成
2. ⚠️ 需要上传到服务器并重启服务

## 测试步骤

### 1. 上传代码到服务器

```bash
scp main.py admin@47.79.254.213:~/gemini-audio-service/main.py
```

### 2. 重启服务（在服务器上执行）

```bash
ssh admin@47.79.254.213
cd ~/gemini-audio-service
source venv/bin/activate
pkill -f 'python.*main.py'
sleep 2
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
sleep 3
ps aux | grep 'python.*main.py' | grep -v grep
```

### 3. 验证服务启动

```bash
curl http://47.79.254.213:8001/health
```

应该返回：
```json
{"message":"音频分析服务正在运行","status":"ok"}
```

### 4. 测试策略分析接口

#### 4.1 先上传一个音频文件（如果还没有）

从 iOS 客户端上传一个音频文件，获取 `session_id`。

#### 4.2 等待音频分析完成

检查任务状态：
```bash
curl "http://47.79.254.213:8001/api/v1/tasks/sessions/{session_id}/status"
```

等待 `status` 变为 `"archived"`。

#### 4.3 调用策略分析接口

```bash
curl -X POST "http://47.79.254.213:8001/api/v1/tasks/sessions/{session_id}/strategies" \
  -H "Content-Type: application/json" | python3 -m json.tool
```

### 5. 验证返回数据

检查返回的 JSON 数据：

1. **visual 应该是数组**：
   ```json
   "visual": [
     {
       "transcript_index": 3,
       "speaker": "Speaker_1",
       "image_prompt": "...",
       "emotion": "...",
       "subtext": "...",
       "context": "...",
       "my_inner": "...",
       "other_inner": "..."
     }
   ]
   ```

2. **关键时刻数量**：应该是 2-5 个

3. **每个 visual 包含的字段**：
   - ✅ transcript_index（数字）
   - ✅ speaker（字符串）
   - ✅ image_prompt（详细描述）
   - ✅ emotion（情绪）
   - ✅ subtext（潜台词）
   - ✅ context（情景）
   - ✅ my_inner（我的内心OS）
   - ✅ other_inner（对方的内心OS）

4. **image_prompt 内容**：应该包含：
   - 说话人位置和身份标注
   - 情绪表现（肢体语言、表情）
   - 潜台词暗示
   - 情景描述

### 6. 查看服务器日志

```bash
ssh admin@47.79.254.213
tail -50 ~/gemini-audio-service.log | grep -A 10 "策略分析"
```

应该看到：
- "策略分析生成成功"
- "关键时刻数量: X"
- "策略数量: 3"

### 7. 测试向后兼容性（可选）

如果 Gemini 返回单个 visual 对象（旧格式），应该自动转换为数组格式。

## 预期结果

1. ✅ visual 是数组格式
2. ✅ 包含 2-5 个关键时刻
3. ✅ 每个关键时刻都有完整的字段
4. ✅ image_prompt 包含详细的标注信息
5. ✅ transcript_index 关联到正确的对话项

## 如果遇到问题

1. **检查服务是否运行**：
   ```bash
   ps aux | grep 'python.*main.py' | grep -v grep
   ```

2. **查看错误日志**：
   ```bash
   tail -100 ~/gemini-audio-service.log | grep -i error
   ```

3. **检查代码语法**：
   ```bash
   python3 -m py_compile main.py
   ```

4. **验证数据模型**：确保 VisualData 和 Call2Response 定义正确

## 测试检查清单

- [ ] 代码已上传到服务器
- [ ] 服务已重启
- [ ] 健康检查通过
- [ ] 有已完成分析的音频任务
- [ ] 策略分析接口调用成功
- [ ] visual 是数组格式
- [ ] 关键时刻数量合理（2-5 个）
- [ ] image_prompt 包含详细标注
- [ ] 所有字段都存在且有效
