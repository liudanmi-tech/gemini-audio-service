# 登录失败排查指南

## 问题现象

iOS 编译运行后点击登录，提示「登录失败」。

## 根本原因

登录接口 `POST /api/v1/auth/login` 依赖数据库（验证码校验、用户查询）。若数据库连接失败，接口返回 500 Internal Server Error，客户端解析为「登录失败」。

## 排查步骤

### 1. 确认数据库连接

在**服务器**上执行：

```bash
cd ~/gemini-audio-service
source venv/bin/activate
python3 -c "
import asyncio
from database.connection import engine
from sqlalchemy import text

async def test():
    try:
        async with engine.connect() as conn:
            await conn.execute(text('SELECT 1'))
        print('✅ 数据库连接成功')
    except Exception as e:
        print('❌ 数据库连接失败:', e)

asyncio.run(test())
"
```

### 2. 常见数据库错误

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| `pg_hba.conf rejects ... no encryption` | RDS 要求 SSL 加密 | 在 `.env` 中添加 `DATABASE_SSL=true`，重启服务 |
| `PostgreSQL server rejected SSL upgrade` | RDS 已开启 SSL，需用 CA 证书验证 | 1. 在 RDS 控制台「数据安全性→SSL」下载 CA 证书<br>2. 上传到服务器并设置 `DATABASE_CA_CERT=/path/to/ca.pem`<br>3. 确保 `DATABASE_SSL=true` |
| `could not connect to server` | 网络/白名单 | 在阿里云 RDS 控制台「白名单」中添加应用服务器 IP `47.79.254.213` |
| `password authentication failed` | 账号密码错误 | 检查 `.env` 中 `DATABASE_URL` 的用户名和密码 |

### 2.1 阿里云 RDS SSL + CA 证书（解决 "rejected SSL upgrade"）

当 RDS 已开启 SSL 且使用云端证书时，客户端需使用 CA 证书做 verify-ca 才能连接：

1. 登录 [RDS 控制台](https://rdsnext.console.aliyun.com/)
2. 选择实例 → **数据安全性** → **SSL**
3. 选择「使用云端证书」→ 点击 **下载 CA 证书**
4. 解压得到 PEM 文件（如 `ApsaraDB-CA-Chain.pem`）
5. 上传到服务器，例如：`~/gemini-audio-service/certs/rds-ca.pem`
6. 在 `.env` 添加：
   ```
   DATABASE_SSL=true
   DATABASE_CA_CERT=/home/你的用户名/gemini-audio-service/certs/rds-ca.pem
   ```
7. 重启服务

### 3. 检查 RDS 白名单

1. 登录 [阿里云 RDS 控制台](https://rdsnext.console.aliyun.com/)
2. 进入你的 PostgreSQL 实例
3. 左侧「数据安全性」 → 「白名单设置」
4. 确认白名单中包含应用服务器公网 IP：`47.79.254.213`  
   （若应用在 ECS 内网访问 RDS，则添加 ECS 内网 IP）

### 4. 测试登录接口

在本机或服务器执行：

```bash
# 1. 发送验证码（开发环境会返回验证码）
curl -s -X POST "http://47.79.254.213/api/v1/auth/send-code" \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'

# 2. 登录（开发环境验证码一般为 123456）
curl -s -X POST "http://47.79.254.213/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

- 若返回 `{"code":200,"data":{"token":"...","user_id":"..."}}` → 登录成功
- 若返回 500 或 Internal Server Error → 查看服务器日志 `tail -50 ~/gemini-audio-service.log`

### 5. iOS 端检查

- **Info.plist**：已为 `47.79.254.213` 配置 `NSExceptionAllowsInsecureHTTPLoads`，HTTP 可访问
- **API 地址**：`AuthService` 与 `NetworkManager` 的 `baseURL` 为 `http://47.79.254.213/api/v1`
- 若使用模拟器访问本机：确保用实际服务器 IP，不要用 localhost

## 部署修复后重启

修改 `database/connection.py` 或 `.env` 后，需重启服务：

```bash
# 在服务器执行
cd ~/gemini-audio-service
pkill -f "python.*main"
sleep 2
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
```
