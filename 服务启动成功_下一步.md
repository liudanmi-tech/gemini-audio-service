# 🎉 服务启动成功！

## ✅ 当前状态

- ✅ 后端服务运行在 `http://47.79.254.213:8001`
- ✅ 健康检查通过
- ✅ iOS 客户端配置已更新（端口 8001）

## 📋 下一步操作

### 1. 在服务器上验证服务（可选）

```bash
# 在服务器上执行
cd ~/gemini-audio-service
source venv/bin/activate

# 检查进程
ps aux | grep python3 | grep main.py | grep -v grep

# 测试 API
curl http://localhost:8001/health
curl http://localhost:8001/api/v1/tasks/sessions
```

### 2. 配置阿里云安全组（重要！）

**必须开放 8001 端口，否则 iOS 客户端无法连接！**

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入 **云服务器 ECS** → **实例**
3. 找到你的服务器实例（47.79.254.213）
4. 点击 **安全组** → **配置规则**
5. 点击 **添加安全组规则**：
   - **规则方向**: 入方向
   - **授权策略**: 允许
   - **协议类型**: 自定义 TCP
   - **端口范围**: 8001/8001
   - **授权对象**: 0.0.0.0/0（或你的 IP 地址）
   - **描述**: FastAPI 音频分析服务
6. 点击 **保存**

### 3. 从 Mac 测试连接（验证安全组）

```bash
# 在你的 Mac 上执行
curl http://47.79.254.213:8001/health

# 应该返回：
# {"message":"音频分析服务正在运行","status":"ok"}
```

如果无法连接，说明安全组未配置，请完成步骤 2。

### 4. 在 iOS 客户端测试

1. **确保 `NetworkManager.swift` 的 `baseURL` 已更新为**：
   ```swift
   private let baseURL = "http://47.79.254.213:8001/api/v1"
   ```

2. **确保 `AppConfig.swift` 使用真实 API**：
   ```swift
   // 在 AppConfig.swift 中，确保返回 .production
   var currentEnvironment: Environment {
       return .production  // 或通过 UserDefaults 设置
   }
   ```

3. **运行 iOS 应用**：
   - 在 Xcode 中按 `Cmd + R` 运行
   - 点击录制按钮
   - 录制一段音频
   - 停止录制
   - 查看控制台日志，应该看到：
     - ✅ 上传成功
     - ✅ 任务创建
     - ✅ 状态轮询开始

### 5. 查看实时日志

**在服务器上**：
```bash
# 实时查看日志
tail -f /tmp/gemini-service.log
```

**在 Xcode 控制台**：
- 查看 iOS 客户端的详细日志（已添加大量 `print` 语句）

## 🔍 故障排查

### 问题 1: iOS 客户端无法连接

**症状**: 控制台显示 `Failed to connect` 或 `Couldn't connect to server`

**解决**:
1. 检查安全组是否开放 8001 端口
2. 在 Mac 上测试：`curl http://47.79.254.213:8001/health`
3. 检查 `NetworkManager.swift` 的 `baseURL` 是否正确

### 问题 2: 上传成功但分析失败

**症状**: 任务状态一直显示 "analyzing"

**解决**:
1. 查看服务器日志：`tail -f /tmp/gemini-service.log`
2. 检查 Gemini API Key 是否正确
3. 检查反向代理配置

### 问题 3: 服务意外停止

**症状**: iOS 客户端无法连接，服务器上进程不存在

**解决**:
```bash
# 在服务器上重新启动
cd ~/gemini-audio-service
source venv/bin/activate
nohup python3 main.py > /tmp/gemini-service.log 2>&1 &
```

## 📊 监控服务状态

### 创建监控脚本（可选）

在服务器上创建 `check_service.sh`：

```bash
#!/bin/bash
if ! pgrep -f "python3 main.py" > /dev/null; then
    echo "⚠️  服务未运行，正在重启..."
    cd ~/gemini-audio-service
    source venv/bin/activate
    nohup python3 main.py > /tmp/gemini-service.log 2>&1 &
    echo "✅ 服务已重启"
else
    echo "✅ 服务运行正常"
fi
```

添加到 crontab（每 5 分钟检查一次）：
```bash
crontab -e
# 添加：
*/5 * * * * /home/admin/gemini-audio-service/check_service.sh >> /tmp/service_check.log 2>&1
```

## 🎯 测试清单

- [ ] 服务器进程运行中
- [ ] 健康检查 API 返回成功
- [ ] 安全组已开放 8001 端口
- [ ] 从 Mac 可以访问 `http://47.79.254.213:8001/health`
- [ ] iOS 客户端 `baseURL` 已更新为 `http://47.79.254.213:8001/api/v1`
- [ ] iOS 客户端 `AppConfig` 设置为生产环境
- [ ] 可以录制音频
- [ ] 可以上传音频
- [ ] 任务列表显示新任务
- [ ] 任务状态从 "analyzing" 变为 "archived"

## 🚀 完成！

现在你可以：
1. 在 iOS 客户端录制音频
2. 上传到服务器
3. 服务器使用 Gemini API 分析音频
4. 返回分析结果到 iOS 客户端

祝你测试顺利！🎉

