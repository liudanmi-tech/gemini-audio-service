# v0.6 方案 B：记忆功能完整流程验证指南

## 当前状态 ✅

- 代码已部署到服务器 (47.79.254.213)
- 记忆服务 `services/memory_service.py` 已同步
- mem0ai 已安装
- 服务已启动，健康检查通过：`http://47.79.254.213/health` → OK

---

## 一、iOS 客户端测试步骤

1. **打开 iOS 应用**（WorkSurvivalGuide），确保 API 地址为 `http://47.79.254.213/api/v1`

2. **登录**（若未登录）

3. **创建或选择档案**
   - 确保已有至少 2 个档案（用于说话人匹配）
   - 档案匹配成功后才会触发「B 钩子」写入记忆

4. **上传录音并分析**
   - 上传一段会议/对话录音
   - 等待分析完成（含声纹匹配、策略生成等）

5. **观察结果**
   - 分析完成后，若档案匹配成功，记忆会自动写入
   - 策略生成时会注入历史记忆

---

## 二、查看 [记忆] 日志

SSH 连接服务器后执行：

```bash
# 实时查看记忆相关日志
tail -f ~/gemini-audio-service.log | grep --line-buffered "\[记忆\]"

# 或查看最近 200 行中的记忆日志
grep "\[记忆\]" ~/gemini-audio-service.log | tail -50
```

### 预期日志示例

| 阶段 | 日志关键词 | 说明 |
|------|-----------|------|
| B 钩子 | `[记忆] B 钩子触发` | 档案匹配完成，准备写入对话记忆 |
| 写入 | `[记忆] add_memory 成功` | 对话/策略已写入 Mem0 |
| 检索 | `[记忆] 检索成功注入技能` | 策略生成前命中相关记忆 |
| C 钩子 | `[记忆] C 钩子触发` | 策略生成后写入策略记忆 |

### 若未看到 [记忆] 日志

- **B 钩子跳过**：`speaker_mapping` 或 `profile_names` 为空 → 需确保档案匹配成功
- **Mem0 未初始化**：服务器未安装 mem0ai 或 GEMINI_API_KEY 无效 → 已安装 mem0ai，确认 .env 中 API Key
- **add_memory 失败**：网络或 Qdrant 写入异常 → 查看完整错误堆栈

---

## 三、快速验证命令汇总

```bash
# SSH 到服务器
ssh admin@47.79.254.213

# 查看最近记忆日志
grep "\[记忆\]" ~/gemini-audio-service.log | tail -30

# 查看某次分析的完整日志（替换 session_id）
grep "b026a171-972c-4355-bb96-227e5a1e8e00" ~/gemini-audio-service.log | grep "\[记忆\]"
```

---

## 四、注意事项

1. **档案匹配**：只有 `speaker_mapping` 不为空时才会写入对话记忆
2. **首次分析**：若此前无记忆，检索可能为空；第二次分析同一用户的任务时，应能命中第一次写入的记忆
3. **Qdrant 锁**：同一时刻仅一个进程可访问本地 Qdrant 数据；服务正常运行时不要在本机同时跑 `verify_memory.py`
