# 修复OSS图片403错误说明

## 问题描述

图片上传成功，但客户端加载图片时返回 HTTP 403 错误（禁止访问）。

从日志可以看到：
- ✅ 图片上传成功
- ✅ 档案更新成功，photo_url已保存
- ❌ 图片加载失败：HTTP 403

## 问题原因

HTTP 403 表示 OSS Bucket 的权限设置为私有，不允许匿名访问。客户端无法直接访问上传的图片。

## 解决方案

在上传图片时设置 ACL（访问控制列表）为 `public-read`，允许客户端直接访问图片。

### 代码修改

**main.py** - `upload_image_to_oss` 函数：

**之前**：
```python
oss_bucket.put_object(oss_key, image_bytes, headers={'Content-Type': 'image/png'})
```

**之后**：
```python
headers = {
    'Content-Type': 'image/png',
    'x-oss-object-acl': 'public-read'  # 设置对象为公共读
}
oss_bucket.put_object(oss_key, image_bytes, headers=headers)
```

## 部署步骤

1. **上传修复后的文件到服务器**：
```bash
scp main.py admin@47.79.254.213:~/gemini-audio-service/
```

2. **重启服务**：
```bash
ssh admin@47.79.254.213
cd ~/gemini-audio-service
pkill -f "python3 main.py"
nohup python3 main.py > ~/gemini-audio-service.log 2>&1 &
```

## 验证

修复后，新上传的图片应该可以正常访问。对于已经上传的图片，可以：

1. **方案1**：重新上传图片（推荐）
   - 在编辑档案页面重新选择图片
   - 新上传的图片会设置为公共读权限

2. **方案2**：批量修改已上传图片的权限
   - 需要在OSS控制台手动修改
   - 或者编写脚本批量修改

## 注意事项

1. **安全性**：设置为公共读后，任何人都可以通过URL访问图片。如果图片包含敏感信息，需要考虑：
   - 使用签名URL（有时效性）
   - 通过后端代理访问图片
   - 使用私有Bucket + 签名URL

2. **Bucket级别权限**：如果Bucket本身设置为私有，即使对象设置为公共读，也可能无法访问。需要确保：
   - Bucket的读写权限设置为"公共读"或"公共读写"
   - 或者使用CDN域名访问

3. **CORS配置**：如果从Web客户端访问，还需要配置OSS的CORS规则，允许跨域访问。

## 测试

修复后，请测试：
1. 上传新图片
2. 查看图片是否能正常显示
3. 检查控制台是否有HTTP 403错误

如果仍有问题，请检查：
- OSS Bucket的权限设置
- OSS的CORS配置
- 网络连接是否正常
